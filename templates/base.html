<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="/static/favicon.png"
    />
    <link rel="alternate icon" href="/static/favicon.ico" />

    <!-- Pretendard font -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Suppress Tailwind CDN warning in console (development use only)
      if (window.tailwindcss) {
        window.tailwindcss.config = { corePlugins: {} };
      }

      // Suppress storage access errors from browser extensions
      window.addEventListener(
        "error",
        function (event) {
          if (
            event.message &&
            event.message.includes("Access to storage is not allowed")
          ) {
            event.preventDefault();
          }
        },
        true
      );

      // Also suppress unhandled promise rejections for storage errors
      window.addEventListener("unhandledrejection", function (event) {
        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("Access to storage is not allowed")
        ) {
          event.preventDefault();
        }
      });
    </script>

    <style>
      :root {
        --bg1: #ffe7c2;
        --bg2: #ffd6f5;
        --panel: #ffffff;
        --text-main: #22293a;
        --text-sub: #6b7280;
        --accent: #fb923c;
        --accent2: #6366f1;
      }

      html,
      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", "Noto Sans KR", "Noto Sans", Arial,
          sans-serif;
      }

      body {
        min-height: 100vh;
        background: radial-gradient(circle at 0% 0%, #fff7db, transparent 50%),
          radial-gradient(circle at 100% 100%, #e0e7ff, transparent 50%),
          linear-gradient(135deg, var(--bg1), var(--bg2));
        color: var(--text-main);
      }

      .nav-link {
        transition: all 0.2s ease;
      }

      .nav-link:hover {
        transform: translateY(-2px);
        color: var(--accent);
      }

      .nav-link.active {
        color: var(--accent);
        font-weight: 600;
      }

      .dropdown {
        position: relative;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        min-width: 200px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        z-index: 1000;
        margin-top: 0px;
        padding-top: 8px;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .dropdown-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 8px;
        background: transparent;
      }

      .dropdown-content a {
        padding: 12px 16px;
        display: block;
        color: #374151;
        text-decoration: none;
        font-size: 0.875rem;
        transition: background-color 0.2s;
      }

      .dropdown-content a:hover {
        background-color: #fff7ed;
        color: #fb923c;
      }

      .dropdown-content a:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-content a:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-content .menu-disabled {
        color: #9ca3af;
        cursor: not-allowed;
      }

      .dropdown-content .menu-disabled:hover {
        background-color: transparent;
        color: #9ca3af;
      }

      /* Right-aligned dropdown (hamburger help) */
      .dropdown-right .dropdown-content {
        right: 0;
        left: auto;
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>
  <body class="bg-gray-100">
    <!-- Navigation Header -->
    <nav class="sticky top-0 z-40 bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6">
        <div class="flex justify-between h-14">
          <div class="flex items-center">
            <!-- Logo -->
            <div class="flex-shrink-0 flex items-center">
              <a
                href="/"
                class="text-lg sm:text-2xl font-bold text-orange-500 whitespace-nowrap"
              >
                ğŸŒ¸ ì˜¤ëˆ„ì´ í•œêµ­ì–´
              </a>
            </div>

            <!-- Desktop Navigation -->
            <div
              class="hidden sm:ml-4 lg:ml-6 sm:flex sm:space-x-2 lg:space-x-4"
            >
              <a
                href="/"
                class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-900 whitespace-nowrap"
              >
                ğŸ  í™ˆ
              </a>

              <!-- ë°œìŒ í•™ìŠµ ë“œë¡­ë‹¤ìš´ -->
              <div class="dropdown inline-flex items-center">
                <button
                  class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-900 whitespace-nowrap"
                >
                  ğŸ—£ï¸ ë°œìŒ í•™ìŠµ â–¾
                </button>
                <div class="dropdown-content">
                  <a href="/pronunciation-check">ğŸ¯ ë°œìŒ ê²€ì‚¬</a>
                  <a href="/pronunciation-correction">âœï¸ ë°œìŒ êµì •</a>
                  <a href="/pronunciation-practice">ğŸµ ë°œìŒ ì—°ìŠµ</a>
                  <a href="/pronunciation-rules">ğŸ“– ë°œìŒ ê·œì¹™</a>
                  <a href="/pronunciation-stages">ğŸ“š ë‹¨ê³„ë³„ í•™ìŠµ</a>
                  <div class="border-t border-gray-200 my-1"></div>
                  <a href="/speechpro-practice">ğŸ¤ ë°œìŒ ì •í™•ë„ (SpeechPro)</a>
                  <a href="/fluency-practice">ğŸ—£ï¸ ìœ ì°½ì„± í‰ê°€ (FluencyPro)</a>
                  <a href="/vocabulary-progress">ğŸ“ˆ ì–´íœ˜ ì§„ë„</a>
                </div>
              </div>

              <!-- AI í•™ìŠµ ë“œë¡­ë‹¤ìš´ -->
              <div class="dropdown inline-flex items-center">
                <button
                  class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-900 whitespace-nowrap"
                >
                  ğŸ¤– AI í•™ìŠµ â–¾
                </button>
                <div class="dropdown-content">
                  <a href="/learning">ğŸ“ AI í•™ìŠµ ë„êµ¬</a>
                  <a href="/content-generation">ğŸ“š ë§ì¶¤í˜• êµì¬</a>
                  <a href="/custom-materials">ğŸ“‘ ë§ì¶¤ í•™ìŠµ ìë£Œ</a>
                  <a href="/essay-test">ğŸ“ ì—ì„¸ì´ í‰ê°€</a>
                  <a href="/fluency-test">âœï¸ ì‘ë¬¸ ìœ ì°½ì„± í…ŒìŠ¤íŠ¸</a>
                  <a href="/media-generation">ğŸ¨ ìƒí™©ë³„ ì½˜í…ì¸  ìƒì„±</a>
                </div>
              </div>

              <!-- í™œë™í•˜ê¸° ë“œë¡­ë‹¤ìš´ -->
              <div class="dropdown inline-flex items-center">
                <button
                  class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-900 whitespace-nowrap"
                >
                  ğŸ² í™œë™í•˜ê¸° â–¾
                </button>
                <div class="dropdown-content">
                  <div
                    class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase"
                  >
                    ì¬ë¯¸ìˆëŠ” ë†€ì´
                  </div>
                  <a href="/word-puzzle">ğŸ§© ë¬¸ì¥ ìˆœì„œ ë§ì¶”ê¸°</a>
                  <a href="/vocab-garden">ğŸŒ¸ ì–´íœ˜ ì •ì›</a>
                  <a href="/daily-expression">ğŸ’¬ ì˜¤ëŠ˜ì˜ í‘œí˜„</a>
                  <a href="/typing-game">âŒ¨ï¸ íƒ€ì´í•‘ ê²Œì„</a>
                  <a href="/listening-dictation">ğŸ§ ë“£ê³  ë°›ì•„ì“°ê¸°</a>
                  <a href="/speed-quiz">âš¡ ìŠ¤í”¼ë“œ í€´ì¦ˆ</a>
                  <div class="border-t border-gray-100 my-1"></div>
                  <div
                    class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase"
                  >
                    ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°
                  </div>
                  <a href="/folktales">ğŸ“– ì „ë˜ë™í™” ì½ê¸°</a>
                  <a href="/cultural-expressions">ğŸ¨ ë¬¸í™” í‘œí˜„ í•™ìŠµ</a>
                </div>
              </div>

              <!-- API í…ŒìŠ¤íŠ¸ - ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™ ì˜ˆì •
              <a
                href="/api-test"
                class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-900 whitespace-nowrap"
              >
                ğŸ”§ API í…ŒìŠ¤íŠ¸
              </a>
              -->

              <a
                href="/sitemap"
                class="nav-link inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-900 whitespace-nowrap"
              >
                ğŸ“ ì‚¬ì´íŠ¸ë§µ
              </a>
            </div>
          </div>

          <!-- Auth Links (Desktop) -->
          <div class="flex items-center space-x-2 sm:space-x-3">
            <a
              href="/learning-progress"
              id="progress-link"
              class="px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-900 whitespace-nowrap"
              style="display: none"
            >
              ğŸ“Š í•™ìŠµ ì§„ë„
            </a>
            <a
              href="/mypage"
              id="user-display"
              class="px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-900 whitespace-nowrap"
              style="display: none"
            ></a>
            <button
              id="logout-btn"
              class="px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-900"
              style="display: none"
            >
              ë¡œê·¸ì•„ì›ƒ
            </button>
            <a
              href="/login"
              id="login-link"
              class="px-2 sm:px-4 py-2 rounded-lg bg-orange-500 text-white text-xs sm:text-sm font-medium hover:bg-orange-600 whitespace-nowrap"
            >
              ë¡œê·¸ì¸
            </a>

            <!-- ë„ì›€ë§: ìš°ì¸¡ í–„ë²„ê±° ë²„íŠ¼ -->
            <div
              class="dropdown dropdown-right inline-flex items-center relative"
            >
              <button
                class="flex items-center gap-1 px-2 sm:px-3 py-2 rounded-lg border border-gray-200 text-xs sm:text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900"
                aria-label="ë„ì›€ë§ ë©”ë‰´"
              >
                <span class="text-lg">â˜°</span>
                <span class="hidden sm:inline">ë„ì›€ë§</span>
              </button>
              <div class="dropdown-content">
                <span class="menu-disabled block px-4 py-3 text-xs"
                  >â“ Q&A(ìì£¼ë¬»ëŠ”ì§ˆë¬¸) (ì¤€ë¹„ì¤‘)</span
                >
                <div class="border-t border-gray-100 my-1"></div>
                <div
                  class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase"
                >
                  1:1ë¬¸ì˜ ì±„ë„
                </div>
                <span class="menu-disabled block px-4 py-3 text-xs"
                  >ğŸ’¬ ê²Œì‹œíŒ ë¬¸ì˜ (ì¤€ë¹„ì¤‘)</span
                >
                <span class="menu-disabled block px-4 py-3 text-xs"
                  >âœ‰ï¸ ì´ë©”ì¼ ë°œì†¡ (ì¤€ë¹„ì¤‘)</span
                >
                <span class="menu-disabled block px-4 py-3 text-xs"
                  >ğŸ“ ì „í™” ìƒë‹´ (ì¤€ë¹„ì¤‘)</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile menu (hidden by default) -->
      <div class="sm:hidden" id="mobile-menu" style="display: none">
        <div class="pt-2 pb-3 space-y-1">
          <a
            href="/"
            class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
          >
            ğŸ  í™ˆ
          </a>

          <!-- ë°œìŒ í•™ìŠµ -->
          <div class="pl-3 pr-4 py-2">
            <div class="text-sm font-semibold text-gray-900 mb-1">
              ğŸ—£ï¸ ë°œìŒ í•™ìŠµ
            </div>
            <a
              href="/pronunciation-check"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ¯ ë°œìŒ ê²€ì‚¬</a
            >
            <a
              href="/pronunciation-correction"
              class="block pl-4 py-1 text-sm text-gray-600"
              >âœï¸ ë°œìŒ êµì •</a
            >
            <a
              href="/pronunciation-practice"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸµ ë°œìŒ ì—°ìŠµ</a
            >
            <a
              href="/pronunciation-rules"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“– ë°œìŒ ê·œì¹™</a
            >
            <a
              href="/pronunciation-stages"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“š ë‹¨ê³„ë³„ í•™ìŠµ</a
            >
            <div class="border-t border-gray-200 my-1 ml-4"></div>
            <a
              href="/speechpro-practice"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ¤ ë°œìŒ ì •í™•ë„ (SpeechPro)</a
            >
            <a
              href="/fluency-practice"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ—£ï¸ ìœ ì°½ì„± í‰ê°€ (FluencyPro)</a
            >
            <a
              href="/vocabulary-progress"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“ˆ ì–´íœ˜ ì§„ë„</a
            >
          </div>

          <!-- AI í•™ìŠµ -->
          <div class="pl-3 pr-4 py-2">
            <div class="text-sm font-semibold text-gray-900 mb-1">
              ğŸ¤– AI í•™ìŠµ
            </div>
            <a href="/learning" class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“ AI í•™ìŠµ ë„êµ¬</a
            >
            <a
              href="/content-generation"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“š ë§ì¶¤í˜• êµì¬</a
            >
            <a
              href="/custom-materials"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“‘ ë§ì¶¤ í•™ìŠµ ìë£Œ</a
            >
            <a
              href="/essay-test"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ“ ì—ì„¸ì´ í‰ê°€</a
            >
            <a
              href="/fluency-test"
              class="block pl-4 py-1 text-sm text-gray-600"
              >âœï¸ ì‘ë¬¸ ìœ ì°½ì„± í…ŒìŠ¤íŠ¸</a
            >
            <a
              href="/media-generation"
              class="block pl-4 py-1 text-sm text-gray-600"
              >ğŸ¨ ìƒí™©ë³„ ì½˜í…ì¸  ìƒì„±</a
            >
          </div>

          <!-- í™œë™í•˜ê¸° -->
          <div class="pl-3 pr-4 py-2">
            <div class="text-sm font-semibold text-gray-900 mb-1">
              ğŸ² í™œë™í•˜ê¸°
            </div>
            <div class="pl-2 py-1">
              <div class="text-xs font-semibold text-gray-700 mb-1">
                ì¬ë¯¸ìˆëŠ” ë†€ì´
              </div>
              <a
                href="/word-puzzle"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸ§© ë¬¸ì¥ ìˆœì„œ ë§ì¶”ê¸°</a
              >
              <a
                href="/vocab-garden"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸŒ¸ ì–´íœ˜ ì •ì›</a
              >
              <a
                href="/daily-expression"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸ’¬ ì˜¤ëŠ˜ì˜ í‘œí˜„</a
              >
              <a
                href="/typing-game"
                class="block pl-4 py-1 text-sm text-gray-600"
                >âŒ¨ï¸ íƒ€ì´í•‘ ê²Œì„</a
              >
              <a
                href="/listening-dictation"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸ§ ë“£ê³  ë°›ì•„ì“°ê¸°</a
              >
              <a
                href="/speed-quiz"
                class="block pl-4 py-1 text-sm text-gray-600"
                >âš¡ ìŠ¤í”¼ë“œ í€´ì¦ˆ</a
              >
            </div>
            <div class="pl-2 py-1 mt-2">
              <div class="text-xs font-semibold text-gray-700 mb-1">
                ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°
              </div>
              <a
                href="/folktales"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸ“– ì „ë˜ë™í™” ì½ê¸°</a
              >
              <a
                href="/cultural-expressions"
                class="block pl-4 py-1 text-sm text-gray-600"
                >ğŸ¨ ë¬¸í™” í‘œí˜„ í•™ìŠµ</a
              >
            </div>
          </div>

          <!-- ë„ì›€ë§ -->
          <div class="pl-3 pr-4 py-2">
            <div class="text-sm font-semibold text-gray-900 mb-1">
              ğŸ†˜ ë„ì›€ë§
            </div>
            <span class="block pl-4 py-1 text-sm text-gray-400"
              >â“ Q&A(ìì£¼ë¬»ëŠ”ì§ˆë¬¸) (ì¤€ë¹„ì¤‘)</span
            >
            <div class="pl-2 py-1 mt-2">
              <div class="text-xs font-semibold text-gray-700 mb-1">
                1:1ë¬¸ì˜ ì±„ë„
              </div>
              <span class="block pl-4 py-1 text-sm text-gray-400"
                >ğŸ’¬ ê²Œì‹œíŒ ë¬¸ì˜ (ì¤€ë¹„ì¤‘)</span
              >
              <span class="block pl-4 py-1 text-sm text-gray-400"
                >âœ‰ï¸ ì´ë©”ì¼ ë°œì†¡ (ì¤€ë¹„ì¤‘)</span
              >
              <span class="block pl-4 py-1 text-sm text-gray-400"
                >ğŸ“ ì „í™” ìƒë‹´ (ì¤€ë¹„ì¤‘)</span
              >
            </div>
          </div>

          <!-- API í…ŒìŠ¤íŠ¸ - ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™ ì˜ˆì •
          <a
            href="/api-test"
            class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
          >
            ğŸ”§ API í…ŒìŠ¤íŠ¸
          </a>
          -->

          <a
            href="/sitemap"
            class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
          >
            ğŸ“ ì‚¬ì´íŠ¸ë§µ
          </a>

          <!-- User Menu Mobile -->
          <div
            class="border-t border-gray-200 pt-2 mt-2"
            id="mobile-user-menu"
            style="display: none"
          >
            <a
              href="/learning-progress"
              class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
            >
              ğŸ“Š í•™ìŠµ ì§„ë„
            </a>
            <a
              href="/mypage"
              id="mobile-user-display"
              class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
            ></a>
            <button
              id="mobile-logout-btn"
              class="block w-full text-left pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-orange-500 hover:text-gray-800"
              style="display: none"
            >
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="py-6">{% block content %}{% endblock %}</main>

    <!-- Floating Chatbot & Mail Widget -->
    <div
      id="chatbot-widget"
      class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4"
    >
      <!-- Mail Button -->
      <button
        id="mail-toggle"
        class="w-16 h-16 rounded-full bg-white shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center hover:scale-110 border-2 border-blue-400 relative"
        onclick="toggleMailNotification()"
      >
        <span class="text-4xl leading-none select-none" aria-hidden="true"
          >ğŸ“¬</span
        >
        <span
          id="mail-badge-float"
          class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center font-bold animate-pulse"
          style="display: none"
        >
          1
        </span>
      </button>

      <!-- Chat Button -->
      <button
        id="chatbot-toggle"
        class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-pink-500 shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group hover:scale-110"
      >
        <img
          src="/static/tiger_chatbot.svg"
          alt="í˜¸ë‘ì´ ì±—ë´‡"
          class="w-12 h-12"
        />
      </button>

      <!-- Mail Dropdown -->
      <div
        id="mail-dropdown"
        class="hidden absolute bottom-24 right-0 w-80 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50"
      >
        <div class="p-4 border-b border-gray-200">
          <h3 class="font-bold text-gray-900">ğŸ“¬ ë©”ì¼í•¨</h3>
        </div>
        <div id="mail-list" class="max-h-80 overflow-y-auto">
          <div class="p-4 text-center text-gray-500 text-sm">
            ìƒˆ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <!-- Mail Modal Popup -->
      <div
        id="mail-modal"
        class="hidden fixed inset-0 bg-black/50 z-[999] flex items-center justify-center p-4 backdrop-blur-sm"
        onclick="closeMail()"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all"
          onclick="event.stopPropagation()"
        >
          <!-- Modal Header -->
          <div
            class="flex items-center justify-between p-6 border-b border-gray-200"
          >
            <div class="flex items-center gap-3 flex-1">
              <span id="mail-modal-icon" class="text-3xl">ğŸ“Œ</span>
              <h2
                id="mail-modal-title"
                class="text-xl font-bold text-gray-900 truncate"
              >
                ë©”ì¼ ì œëª©
              </h2>
            </div>
            <button
              onclick="closeMail()"
              class="text-gray-400 hover:text-gray-600 transition-colors p-1"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Modal Content -->
          <div class="p-6 max-h-[400px] overflow-y-auto">
            <p
              id="mail-modal-message"
              class="text-gray-700 leading-relaxed whitespace-pre-wrap"
            >
              ë©”ì¼ ë‚´ìš©
            </p>
            <p id="mail-modal-timestamp" class="text-gray-400 text-sm mt-4">
              ì‹œê°„
            </p>
          </div>

          <!-- Modal Footer -->
          <div class="flex gap-3 p-6 border-t border-gray-200">
            <button
              id="mail-delete-btn"
              onclick="deleteCurrentMail()"
              class="flex-1 px-4 py-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-700 font-medium transition-colors"
            >
              ì‚­ì œ
            </button>
            <button
              onclick="closeMail()"
              class="flex-1 px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium transition-colors"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Window -->
      <div
        id="chatbot-window"
        class="hidden absolute bottom-24 right-0 w-96 h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden"
        style="max-width: calc(100vw - 2rem)"
      >
        <!-- Header -->
        <div
          class="bg-gradient-to-r from-orange-500 to-pink-500 text-white p-4 flex items-center justify-between"
        >
          <div class="flex items-center space-x-2">
            <div
              class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center p-2"
            >
              <img
                src="/static/tiger_chatbot.svg"
                alt="í˜¸ë‘ì´"
                class="w-full h-full"
              />
            </div>
            <div>
              <div class="font-semibold">AI í•œêµ­ì–´ íŠœí„°</div>
              <div class="text-xs opacity-90">ì˜¨ë¼ì¸</div>
            </div>
          </div>
          <button
            id="chatbot-close"
            class="text-white hover:bg-white/20 rounded-full p-1"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Messages -->
        <div
          id="chatbot-messages"
          class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"
        >
          <div class="flex items-start space-x-2">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-pink-400 flex items-center justify-center flex-shrink-0 p-1"
            >
              <img
                src="/static/tiger_chatbot.svg"
                alt="í˜¸ë‘ì´"
                class="w-full h-full"
              />
            </div>
            <div
              class="bg-white rounded-lg rounded-tl-sm p-3 shadow-sm max-w-[80%]"
            >
              <p class="text-sm text-gray-800">
                ì–´í¥! ğŸ¯<br />í˜¸ë‘ì´ê°€ í•œêµ­ì–´ í•™ìŠµì„ ë„ì™€ë“œë¦´ê²Œìš”!<br />ë¬´ì—‡ì„
                ë„ì™€ë“œë¦´ê¹Œìš”?
              </p>
            </div>
          </div>
        </div>

        <!-- Input -->
        <div class="border-t border-gray-200 p-3 bg-white">
          <div class="flex space-x-2">
            <input
              type="text"
              id="chatbot-input"
              placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
              class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-orange-500"
              autocomplete="off"
            />
            <button
              id="chatbot-send"
              class="px-4 py-2 bg-gradient-to-r from-orange-500 to-pink-500 text-white text-sm font-medium rounded-full hover:from-orange-600 hover:to-pink-600 focus:outline-none disabled:opacity-50"
            >
              ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </div>

    <style>
      #chatbot-messages::-webkit-scrollbar {
        width: 6px;
      }

      #chatbot-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #chatbot-messages::-webkit-scrollbar-thumb {
        background: #fb923c;
        border-radius: 10px;
      }

      .chatbot-typing {
        display: inline-flex;
        gap: 4px;
      }

      .chatbot-typing span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #fb923c;
        animation: typing 1.4s infinite;
      }

      .chatbot-typing span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .chatbot-typing span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-8px);
        }
      }

      @media (max-width: 640px) {
        #chatbot-window {
          width: calc(100vw - 2rem);
          right: 1rem;
        }
      }
    </style>

    <script>
      // Chatbot Widget
      const chatbotToggle = document.getElementById("chatbot-toggle");
      const chatbotWindow = document.getElementById("chatbot-window");
      const chatbotClose = document.getElementById("chatbot-close");
      const chatbotMessages = document.getElementById("chatbot-messages");
      const chatbotInput = document.getElementById("chatbot-input");
      const chatbotSend = document.getElementById("chatbot-send");

      // Toggle chat window
      chatbotToggle.addEventListener("click", () => {
        chatbotWindow.classList.toggle("hidden");
        if (!chatbotWindow.classList.contains("hidden")) {
          chatbotInput.focus();
        }
      });

      chatbotClose.addEventListener("click", () => {
        chatbotWindow.classList.add("hidden");
      });

      // Add user message
      function addChatbotUserMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex items-start space-x-2 justify-end";
        messageDiv.innerHTML = `
          <div class="bg-gradient-to-br from-orange-500 to-pink-500 rounded-lg rounded-tr-sm p-3 shadow-sm max-w-[80%]">
            <p class="text-sm text-white">${escapeHtml(text)}</p>
          </div>
        `;
        chatbotMessages.appendChild(messageDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }

      // Add AI message
      function addChatbotAIMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex items-start space-x-2";
        messageDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-pink-400 flex items-center justify-center flex-shrink-0 p-1">
            <img src="/static/tiger_chatbot.svg" alt="í˜¸ë‘ì´" class="w-full h-full" />
          </div>
          <div class="bg-white rounded-lg rounded-tl-sm p-3 shadow-sm max-w-[80%]">
            <p class="text-sm text-gray-800">${escapeHtml(text).replace(
              /\n/g,
              "<br>"
            )}</p>
          </div>
        `;
        chatbotMessages.appendChild(messageDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }

      // Add typing indicator
      function addChatbotTyping() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "chatbot-typing-indicator";
        typingDiv.className = "flex items-start space-x-2";
        typingDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-pink-400 flex items-center justify-center flex-shrink-0 p-1 animate-bounce">
            <img src="/static/tiger_chatbot.svg" alt="í˜¸ë‘ì´" class="w-full h-full" />
          </div>
          <div class="bg-white rounded-lg rounded-tl-sm p-3 shadow-sm">
            <div class="chatbot-typing">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        `;
        chatbotMessages.appendChild(typingDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }

      // Remove typing indicator
      function removeChatbotTyping() {
        const typingDiv = document.getElementById("chatbot-typing-indicator");
        if (typingDiv) {
          typingDiv.remove();
        }
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Send message
      async function sendChatbotMessage(message) {
        if (!message.trim()) return;

        addChatbotUserMessage(message);
        chatbotInput.value = "";
        chatbotSend.disabled = true;

        addChatbotTyping();

        // Log chatbot usage
        const nickname = localStorage.getItem("user_nickname");
        if (nickname && typeof logUserActivity === "function") {
          logUserActivity(
            nickname,
            "CHATBOT_MESSAGE",
            window.location.pathname,
            {
              messageLength: message.length,
              messagePreview: message.substring(0, 30),
            }
          );
        }

        try {
          const response = await fetch("/api/chatbot", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: message }),
          });

          const data = await response.json();
          removeChatbotTyping();

          if (response.ok) {
            addChatbotAIMessage(data.response);
          } else {
            addChatbotAIMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("Error:", error);
          removeChatbotTyping();
          addChatbotAIMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          chatbotSend.disabled = false;
          chatbotInput.focus();
        }
      }

      // Event listeners
      chatbotSend.addEventListener("click", () => {
        sendChatbotMessage(chatbotInput.value);
      });

      chatbotInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendChatbotMessage(chatbotInput.value);
        }
      });
    </script>

    <!-- Footer -->
    <footer class="bg-white mt-12 py-6 border-t border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center text-sm text-gray-500">
          <span>Â© 2025 Mediazen - ì˜¤ëˆ„ì´ í•œêµ­ì–´ í•™ìŠµ í”Œë«í¼</span>
          <span>Powered by FastAPI + AI</span>
        </div>
      </div>
    </footer>

    <script>
      // Mobile menu toggle
      const mobileMenuButton = document.createElement("button");
      mobileMenuButton.className =
        "sm:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100";
      mobileMenuButton.innerHTML = `
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    `;

      // Add menu button to nav (this would need proper positioning in production)
      mobileMenuButton.addEventListener("click", () => {
        const menu = document.getElementById("mobile-menu");
        menu.style.display = menu.style.display === "none" ? "block" : "none";
      });

      // Prepend the mobile menu button into the header for small screens
      const headerFlex = document.querySelector("nav .flex");
      if (headerFlex) {
        headerFlex.prepend(mobileMenuButton);
      }

      // Set active state on navigation links by matching current path
      function setActiveNav() {
        const rawPath = window.location.pathname || "/";
        const path = rawPath.replace(/\/$/, "") || "/";
        document.querySelectorAll("nav a").forEach((a) => {
          const href = (a.getAttribute("href") || "").replace(/\/$/, "") || "/";
          if (href === path) {
            a.classList.add("active", "font-semibold", "text-orange-500");
          } else {
            a.classList.remove("active", "font-semibold", "text-orange-500");
          }
        });
      }

      // Update auth display
      function updateAuthDisplay() {
        const token = localStorage.getItem("auth_token");
        const nickname = localStorage.getItem("user_nickname");
        const loginLink = document.getElementById("login-link");
        const progressLink = document.getElementById("progress-link");
        const userDisplay = document.getElementById("user-display");
        const mobileUserDisplay = document.getElementById("mobile-user-display");
        const logoutBtn = document.getElementById("logout-btn");
        const mobileUserMenu = document.getElementById("mobile-user-menu");
        const mobileLinkoutBtn = document.getElementById("mobile-logout-btn");

        if (token && nickname) {
          if (loginLink) loginLink.style.display = "none";
          if (progressLink) progressLink.style.display = "inline-block";
          if (userDisplay) {
            userDisplay.textContent = `ğŸ‘¤ ${nickname}`;
            userDisplay.style.display = "inline-block";
          }
          if (mobileUserDisplay) {
            mobileUserDisplay.textContent = `ğŸ‘¤ ${nickname}`;
          }
          if (logoutBtn) {
            logoutBtn.style.display = "inline-block";
            logoutBtn.addEventListener("click", handleLogout);
          }
          if (mobileUserMenu) mobileUserMenu.style.display = "block";
          if (mobileLinkoutBtn) {
            mobileLinkoutBtn.style.display = "block";
            mobileLinkoutBtn.addEventListener("click", handleLogout);
          }
        } else {
          if (loginLink) loginLink.style.display = "inline-block";
          if (progressLink) progressLink.style.display = "none";
          if (userDisplay) userDisplay.style.display = "none";
          if (logoutBtn) logoutBtn.style.display = "none";
          if (mobileUserMenu) mobileUserMenu.style.display = "none";
          if (mobileLinkoutBtn) mobileLinkoutBtn.style.display = "none";
        }
      }

      // Ensure nickname is stored after login (fallback if localStorage missing)
      async function ensureNicknameInLocalStorage() {
        const token = localStorage.getItem("auth_token");
        const nickname = localStorage.getItem("user_nickname");
        if (!token || nickname) return; // nothing to do

        try {
          const res = await fetch("/api/me", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) return;
          const data = await res.json();
          if (data && data.nickname) {
            localStorage.setItem("user_nickname", data.nickname);
            updateAuthDisplay();
          }
        } catch (e) {
          console.warn("Failed to fetch profile for nickname sync", e);
        }
      }

      function handleLogout() {
        const nickname = localStorage.getItem("user_nickname");
        if (nickname) {
          logUserActivity(nickname, "LOGOUT", window.location.pathname);
        }
        localStorage.removeItem("auth_token");
        localStorage.removeItem("user_nickname");
        localStorage.removeItem("is_guest");
        updateAuthDisplay();
        window.location.href = "/";
      }

      // Log user activity helper
      async function logUserActivity(nickname, action, page, details = {}) {
        try {
          await fetch("/api/log/activity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              nickname: nickname,
              action: action,
              page: page,
              details: details,
              timestamp: new Date().toISOString(),
            }),
          });
        } catch (err) {
          console.error("Failed to log activity:", err);
        }
      }

      // Log page view on load
      window.addEventListener("load", () => {
        const nickname = localStorage.getItem("user_nickname");
        const isGuest = localStorage.getItem("is_guest");
        if (nickname) {
          logUserActivity(nickname, "PAGE_VIEW", window.location.pathname, {
            isGuest: isGuest === "true",
            referrer: document.referrer,
            screenSize: `${window.screen.width}x${window.screen.height}`,
          });
        }
      });

      // Get stored learning progress summary (from learning page)
      function getLearningProgressSummary() {
        const minutes = Number(localStorage.getItem("learning_minutes")) || 0;
        const sentences =
          Number(localStorage.getItem("learning_sentence_count")) || 0;
        return `í˜„ì¬ í•™ìŠµ: ${minutes}ë¶„, ë¬¸ì¥ ${sentences}ê°œ ì™„ë£Œ`;
      }

      function showWelcomeTigerWithProgress(nickname) {
        if (typeof openCharacterModal === "function") {
          openCharacterModal("tiger");
          const msgEl = document.getElementById("character-message");
          if (msgEl) {
            msgEl.textContent = `ì–´í¥! ${nickname}ë‹˜, í™˜ì˜í•´ìš”! ì˜¤ëˆ„ì´ í•œêµ­ì–´ì—ì„œ ë°œìŒÂ·ìœ ì°½ì„± ì—°ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”.`;
          }
        }
      }

      // Run on load
      setActiveNav();
      updateAuthDisplay();
      ensureNicknameInLocalStorage();

      // Watch for localStorage changes (e.g., from guest login)
      window.addEventListener("storage", () => {
        updateAuthDisplay();
        setActiveNav();
      });

      // Also listen for custom events from other tabs/iframes
      document.addEventListener("authStateChanged", () => {
        updateAuthDisplay();
      });

      // Welcome mail on first visit per user (no auth dependency)
      (function () {
        const nickname = localStorage.getItem("user_nickname") || "ìƒˆ í•™ìŠµì";
        const flagKey = `welcome_mail_sent_${nickname}`;
        const hasSeenWelcomeMail = localStorage.getItem(flagKey) === "true";
        if (hasSeenWelcomeMail) return;

        setTimeout(() => {
          if (typeof addMailNotification === "function") {
            addMailNotification(
              "ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!",
              `${nickname}ë‹˜, ì˜¤ëˆ„ì´ í•œêµ­ì–´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! AIì™€ í•¨ê»˜ ë°œìŒÂ·ìœ ì°½ì„± ì—°ìŠµì„ ë°”ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”.`,
              "ğŸ‘‹"
            );
            // Also show character popup (tiger) to greet the user
            showWelcomeTigerWithProgress(nickname);
            localStorage.setItem(flagKey, "true");
          }
        }, 1200);
      })();
    </script>

    <!-- Character Popup Modal -->
    <div
      id="character-modal-overlay"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm"
      onclick="closeCharacterModal(event)"
    >
      <div
        class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full mx-4 relative animate-bounce-in"
        id="character-modal-box"
      >
        <button
          class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl"
          onclick="closeCharacterModal()"
        >
          Ã—
        </button>

        <div class="text-center mb-6">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <span class="inline-block mr-2">ğŸ’Œ</span>í¸ì§€ê°€ ë„ì°©í–ˆì–´ìš”!
          </h2>
        </div>

        <div class="flex gap-4">
          <!-- Character Avatar -->
          <div class="flex flex-col items-center flex-shrink-0">
            <div
              id="character-avatar"
              class="w-24 h-24 rounded-full flex items-center justify-center text-5xl font-bold border-4 flex-shrink-0"
            >
              ğŸ§‘â€ğŸ¦°
            </div>
            <p
              id="character-name"
              class="mt-2 text-sm font-semibold text-gray-600"
            >
              ì˜¤ë¹ 
            </p>
          </div>

          <!-- Message -->
          <div class="flex-1">
            <div class="bg-gray-50 rounded-2xl p-4 rounded-tl-none">
              <p
                id="character-message"
                class="text-gray-800 text-base leading-relaxed"
              >
                ë©”ì‹œì§€
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      @keyframes bounce-in {
        0% {
          transform: scale(0.7);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .animate-bounce-in {
        animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
    </style>

    <script>
      // Character Popup Data
      const characterData = {
        brother: {
          name: "ì˜¤ë¹ ",
          emoji: "ğŸ‘¨â€ğŸ”§",
          color: "#A0D2EB",
          messages: [
            "ì—˜ë¦¬ìë² ìŠ¤ë‹˜, ì§€ê¸ˆê¹Œì§€ ê³µë¶€í•˜ì‹  ì‹œê°„ì´ 1ì‹œê°„ì´ ë˜ì—ˆì–´ìš”. ê·¸ë™ì•ˆ 23ê°œì˜ ë¬¸ì¥ì„ í•™ìŠµí•˜ì…¨ìŠµë‹ˆë‹¤.",
            "ì¢‹ì€ ì§„ë„ì…ë‹ˆë‹¤! ê³„ì† ì´ ì†ë„ë¡œ ë‚˜ê°€ë©´ ì •ë§ ë©‹ìˆì„ ê±°ì˜ˆìš”!",
            "ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ ê³µë¶€í•˜ì…¨ë„¤ìš”. ì´ ì •ë„ë©´ ì¶©ë¶„í•´ìš”!",
          ],
        },
        sister: {
          name: "ì—¬ë™ìƒ",
          emoji: "ğŸ‘©",
          color: "#FFB7B2",
          messages: [
            "ì˜¤ëŠ˜ <ì§„ë‹¬ë˜>ì˜ ì ìˆ˜ê°€ 95ì ì„ ê¸°ë¡í•˜ì—¬ ì„¸ê³„ 2ìœ„ì— ì˜¬ëì–´ìš”! ì •ë§ ë©‹ì§€ë„¤ìš”!",
            "ì˜¤ë¹ , ì •ë§ ì˜í•˜ê³  ìˆì–´ìš”! ì €ë„ ì‘ì›í• ê²Œìš”!",
            "ì´ ì •ë„ë©´ í•œêµ­ì–´ ë§ˆìŠ¤í„°ê°€ ê±°ì˜ ë‹¤ ì˜¨ ê±° ì•„ë‹ˆì•¼?",
          ],
        },
        tiger: {
          name: "í˜¸ë‘ì´",
          emoji: "ğŸ¯",
          color: "#FF8A65",
          messages: [
            "30ë¶„ ë™ì•ˆ í•™ìŠµí•œ ë‹¨ì–´ê°€ 5ê°œë°–ì— ì•ˆ ë¼ìš”. ì´ë ‡ê²Œ ëŠë¦¬ê²Œ ê°€ë‹¤ê°„ ì €í•œí…Œ ì¡í˜€ê°ˆ ìˆ˜ ìˆì–´ìš”!!",
            "ì–´í¥! ì¡°ê¸ˆ ë” ë¹¨ë¦¬ í•˜ì§€ ì•Šì„ë˜?",
            "í˜¼ìë§Œ ì‰¬ì§€ ë§ê³  ì—´ì‹¬íˆ í•´! ì–´í¥! ğŸ¯",
          ],
        },
      };

      // Open character popup
      function openCharacterModal(character) {
        const data = characterData[character];
        const messages = data.messages;
        const randomMessage =
          messages[Math.floor(Math.random() * messages.length)];

        document.getElementById("character-avatar").textContent = data.emoji;
        document.getElementById("character-avatar").style.borderColor =
          data.color;
        document.getElementById("character-avatar").style.backgroundColor =
          data.color + "20";
        document.getElementById("character-name").textContent = data.name;
        document.getElementById("character-message").textContent =
          randomMessage;

        document
          .getElementById("character-modal-overlay")
          .classList.remove("hidden");
      }

      // Close character popup
      function closeCharacterModal(event) {
        if (event && event.target.id !== "character-modal-overlay") return;
        document
          .getElementById("character-modal-overlay")
          .classList.add("hidden");
      }

      // Test functions for console
      window.showBrotherPopup = () => openCharacterModal("brother");
      window.showSisterPopup = () => openCharacterModal("sister");
      window.showTigerPopup = () => openCharacterModal("tiger");

      // Mail notification system
      let mailCount = 0;
      const mailData = [];
      let currentOpenMailId = null;

      function toggleMailNotification() {
        const dropdown = document.getElementById("mail-dropdown");
        dropdown.classList.toggle("hidden");
      }

      function addMailNotification(title, message, icon = "ğŸ“Œ") {
        mailCount++;
        document.getElementById("mail-badge-float").style.display = "flex";
        document.getElementById("mail-badge-float").textContent = mailCount;

        const mailItem = {
          id: Date.now(),
          title: title,
          message: message,
          icon: icon,
          timestamp: new Date().toLocaleString("ko-KR"),
        };
        mailData.unshift(mailItem);

        renderMailList();
      }

      function renderMailList() {
        const mailList = document.getElementById("mail-list");

        if (mailData.length === 0) {
          mailList.innerHTML =
            '<div class="p-4 text-center text-gray-500 text-sm">ìƒˆ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        mailList.innerHTML = mailData
          .map(
            (mail) => `
          <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition" onclick="openMail(${mail.id})">
            <div class="flex items-start gap-3">
              <span class="text-2xl flex-shrink-0">${mail.icon}</span>
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-gray-900 text-sm truncate">${mail.title}</p>
                <p class="text-gray-600 text-xs mt-1 line-clamp-2">${mail.message}</p>
                <p class="text-gray-400 text-xs mt-2">${mail.timestamp}</p>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function openMail(mailId) {
        const mail = mailData.find((m) => m.id === mailId);
        if (mail) {
          currentOpenMailId = mailId;
          document.getElementById("mail-modal-icon").textContent = mail.icon;
          document.getElementById("mail-modal-title").textContent = mail.title;
          document.getElementById("mail-modal-message").textContent =
            mail.message;
          document.getElementById("mail-modal-timestamp").textContent =
            mail.timestamp;
          document.getElementById("mail-modal").classList.remove("hidden");
          document.body.style.overflow = "hidden";
        }
      }

      function closeMail() {
        document.getElementById("mail-modal").classList.add("hidden");
        document.body.style.overflow = "auto";
        currentOpenMailId = null;
      }

      function deleteCurrentMail() {
        if (currentOpenMailId !== null) {
          clearMailNotification(currentOpenMailId);
          closeMail();
        }
      }

      function clearMailNotification(mailId) {
        const index = mailData.findIndex((m) => m.id === mailId);
        if (index > -1) {
          mailData.splice(index, 1);
          mailCount--;
          if (mailCount <= 0) {
            mailCount = 0;
            document.getElementById("mail-badge-float").style.display = "none";
          } else {
            document.getElementById("mail-badge-float").textContent = mailCount;
          }
          renderMailList();
        }
      }

      // Close mail dropdown when clicking outside
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("mail-dropdown");
        const mailToggle = document.getElementById("mail-toggle");
        const chatToggle = document.getElementById("chatbot-toggle");
        if (!dropdown.contains(e.target) && !mailToggle.contains(e.target)) {
          dropdown.classList.add("hidden");
        }
      });

      // Close mail modal with Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeMail();
        }
      });

      // Test function: Add sample mail
      window.addTestMail = () => {
        addMailNotification(
          "í•™ìŠµ ì™„ë£Œ ì¶•í•˜!",
          "30ë¶„ í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ì„±ê³µì…ë‹ˆë‹¤! ğŸ‰",
          "ğŸ†"
        );
      };
    </script>

    {% block extra_js %}{% endblock %}

    <!-- ìºë¦­í„° íŒì—… ì»´í¬ë„ŒíŠ¸ -->
    {% include 'components/character-popup.html' %}
  </body>
</html>
