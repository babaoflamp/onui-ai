{% extends "base.html" %}
{% block title %}ìƒí™©ë³„ ì½˜í…ì¸  ìƒì„± - ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <div class="bg-white rounded-2xl p-6 shadow-lg">
    <!-- Header -->
    <header class="mb-8">
      <div
        class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold mb-2"
      >
        <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
        ONUI Â· AI ì½˜í…ì¸  ìƒì„±
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        ğŸ¨ ìƒí™©ë³„ ì½˜í…ì¸  ìƒì„±
      </h1>
      <p class="text-sm text-gray-600">
        í•™ìŠµ ìƒí™©ì— ë§ëŠ” ì´ë¯¸ì§€ì™€ ë°°ê²½ìŒì•…ì„ AIë¡œ ìë™ ìƒì„±í•©ë‹ˆë‹¤
      </p>
    </header>

    <!-- Input Section -->
    <section class="mb-8 p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <span class="text-2xl">ğŸ“</span>
        ìƒí™© ì„¤ëª…
      </h2>
      
      <div class="space-y-4">
        <!-- Situation Input -->
        <div>
          <label for="situation" class="block text-sm font-medium text-gray-700 mb-2">
            í•™ìŠµ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”
          </label>
          <textarea
            id="situation"
            rows="4"
            placeholder="ì˜ˆ: ì„œìš¸ì˜ ì „í†µ ì‹œì¥ì—ì„œ ê³¼ì¼ì„ ì‚¬ëŠ” ìƒí™©. í™œê¸°ì°¬ ë¶„ìœ„ê¸°ì— ì‚¬ëŒë“¤ì´ ë§ê³ , ì‹ ì„ í•œ ê³¼ì¼ë“¤ì´ ì§„ì—´ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none text-sm"
          ></textarea>
        </div>

        <!-- Options -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="imageStyle" class="block text-sm font-medium text-gray-700 mb-2">
              ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼
            </label>
            <select
              id="imageStyle"
              class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
            >
              <option value="realistic">ì‚¬ì‹¤ì ì¸ (Realistic)</option>
              <option value="illustration" selected>ì¼ëŸ¬ìŠ¤íŠ¸ (Illustration)</option>
              <option value="cartoon">ë§Œí™” (Cartoon)</option>
              <option value="watercolor">ìˆ˜ì±„í™” (Watercolor)</option>
            </select>
          </div>

          <div>
            <label for="musicMood" class="block text-sm font-medium text-gray-700 mb-2">
              ìŒì•… ë¶„ìœ„ê¸°
            </label>
            <select
              id="musicMood"
              class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
            >
              <option value="calm">ì°¨ë¶„í•œ (Calm)</option>
              <option value="energetic" selected>í™œê¸°ì°¬ (Energetic)</option>
              <option value="peaceful">í‰í™”ë¡œìš´ (Peaceful)</option>
              <option value="playful">ê²½ì¾Œí•œ (Playful)</option>
            </select>
          </div>

          <div>
            <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
              ìŒì•… ê¸¸ì´
            </label>
            <select
              id="duration"
              class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
            >
              <option value="15">15ì´ˆ</option>
              <option value="30" selected>30ì´ˆ</option>
              <option value="60">60ì´ˆ</option>
            </select>
          </div>
        </div>

        <!-- Generate Button -->
        <button
          onclick="generateMedia()"
          class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white px-6 py-3 rounded-lg hover:from-purple-600 hover:to-pink-700 transition-all shadow-md hover:shadow-lg font-medium"
        >
          ğŸ¨ ì½˜í…ì¸  ìƒì„±í•˜ê¸°
        </button>
      </div>
    </section>

    <!-- Results Section -->
    <section id="resultsSection" class="hidden space-y-6">
      <!-- Image Result -->
      <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <span class="text-2xl">ğŸ–¼ï¸</span>
          ìƒì„±ëœ ì´ë¯¸ì§€
        </h3>
        <div id="imageResult" class="bg-white rounded-lg p-4 shadow-inner">
          <div class="flex items-center justify-center h-64 text-gray-400">
            ì´ë¯¸ì§€ ë¡œë”© ì¤‘...
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button
            onclick="downloadImage()"
            class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm"
          >
            ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          </button>
          <button
            onclick="regenerateImage()"
            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition text-sm"
          >
            ğŸ”„ ë‹¤ì‹œ ìƒì„±
          </button>
        </div>
      </div>

      <!-- Music Result -->
      <div class="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <span class="text-2xl">ğŸµ</span>
          ìƒì„±ëœ ë°°ê²½ìŒì•…
        </h3>
        <div id="musicResult" class="bg-white rounded-lg p-4 shadow-inner">
          <div class="flex items-center justify-center h-32 text-gray-400">
            ìŒì•… ë¡œë”© ì¤‘...
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button
            onclick="downloadMusic()"
            class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm"
          >
            ğŸ“¥ ìŒì•… ë‹¤ìš´ë¡œë“œ
          </button>
          <button
            onclick="regenerateMusic()"
            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition text-sm"
          >
            ğŸ”„ ë‹¤ì‹œ ìƒì„±
          </button>
        </div>
      </div>
    </section>

    <!-- Info Section -->
    <section class="mt-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
      <div class="text-sm font-semibold text-gray-900 mb-2">ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</div>
      <div class="text-xs text-gray-700 space-y-1">
        <p>
          â€¢ <strong>ì´ë¯¸ì§€ ìƒì„±</strong>: í•™ìŠµ ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•˜ë©´ ë” ì •í™•í•œ ì´ë¯¸ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤
        </p>
        <p>
          â€¢ <strong>ìŒì•… ìƒì„±</strong>: ì„ íƒí•œ ë¶„ìœ„ê¸°ì— ë§ëŠ” ë°°ê²½ìŒì•…ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
        </p>
        <p>
          â€¢ <strong>í™œìš© ë°©ë²•</strong>: ìƒì„±ëœ ì½˜í…ì¸ ëŠ” êµì¬ ì œì‘, ë°œí‘œ ìë£Œ, í•™ìŠµ ì¹´ë“œ ë“±ì— í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </p>
        <p>
          â€¢ <strong>ì£¼ì˜ì‚¬í•­</strong>: AI ìƒì„± ì½˜í…ì¸ ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤
        </p>
      </div>
    </section>
  </div>
</div>

<script>
  let currentImageUrl = null;
  let currentMusicUrl = null;

  async function generateMedia() {
    const situation = document.getElementById("situation").value.trim();
    
    if (!situation) {
      alert("í•™ìŠµ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const imageStyle = document.getElementById("imageStyle").value;
    const musicMood = document.getElementById("musicMood").value;
    const duration = document.getElementById("duration").value;

    // Show results section
    document.getElementById("resultsSection").classList.remove("hidden");

    // Show loading states
    document.getElementById("imageResult").innerHTML = 
      '<div class="flex items-center justify-center h-64"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div><p class="text-gray-600">ì´ë¯¸ì§€ ìƒì„± ì¤‘...</p></div></div>';
    
    document.getElementById("musicResult").innerHTML = 
      '<div class="flex items-center justify-center h-32"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div><p class="text-gray-600">ìŒì•… ìƒì„± ì¤‘...</p></div></div>';

    try {
      // Generate Image
      const imageResponse = await fetch("/api/generate-image", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          situation: situation,
          style: imageStyle,
        }),
      });

      const imageData = await imageResponse.json();

      if (imageData.success) {
        currentImageUrl = imageData.image_url;
        document.getElementById("imageResult").innerHTML = 
          `<img src="${imageData.image_url}" alt="ìƒì„±ëœ ì´ë¯¸ì§€" class="w-full rounded-lg" />`;
      } else {
        document.getElementById("imageResult").innerHTML = 
          `<div class="text-center text-red-600 py-8">ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ${imageData.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</div>`;
      }

      // Generate Music
      const musicResponse = await fetch("/api/generate-music", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          situation: situation,
          mood: musicMood,
          duration: parseInt(duration),
        }),
      });

      const musicData = await musicResponse.json();

      if (musicData.success) {
        currentMusicUrl = musicData.music_url;
        document.getElementById("musicResult").innerHTML = 
          `<audio controls class="w-full">
            <source src="${musicData.music_url}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
          <p class="text-sm text-gray-600 mt-2 text-center">${musicData.description || "ë°°ê²½ìŒì•…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"}</p>`;
      } else {
        document.getElementById("musicResult").innerHTML = 
          `<div class="text-center text-red-600 py-8">ìŒì•… ìƒì„± ì‹¤íŒ¨: ${musicData.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</div>`;
      }

    } catch (error) {
      console.error("ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜:", error);
      alert("ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  function downloadImage() {
    if (!currentImageUrl) {
      alert("ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const link = document.createElement("a");
    link.href = currentImageUrl;
    link.download = "onui-generated-image.png";
    link.click();
  }

  function downloadMusic() {
    if (!currentMusicUrl) {
      alert("ë‹¤ìš´ë¡œë“œí•  ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const link = document.createElement("a");
    link.href = currentMusicUrl;
    link.download = "onui-generated-music.mp3";
    link.click();
  }

  function regenerateImage() {
    generateMedia();
  }

  function regenerateMusic() {
    generateMedia();
  }
</script>
{% endblock %}
