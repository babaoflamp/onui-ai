{% extends "base.html" %} {% block title %}API í…ŒìŠ¤íŠ¸ - ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock
%} {% block content %}
<div class="max-w-6xl mx-auto px-4">
  <!-- Header -->
  <div class="mb-8 text-center">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ”§ API í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
    <p class="text-gray-600">ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
  </div>

  <!-- API Categories -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Learning Game APIs -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“š í•™ìŠµ ê²Œì„ API</h2>

      <!-- Word Puzzle -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ë‹¨ì–´ í¼ì¦</h3>
        <button
          onclick="testAPI('/api/puzzle/sentences', 'puzzle-result')"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-2 w-full"
        >
          GET /api/puzzle/sentences
        </button>
        <button
          onclick="testAPI('/api/puzzle/sentences?level=A1', 'puzzle-result')"
          class="bg-blue-400 text-white px-4 py-2 rounded hover:bg-blue-500 mb-2 w-full text-sm"
        >
          GET /api/puzzle/sentences?level=A1
        </button>
        <pre
          id="puzzle-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Daily Expression -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ì˜¤ëŠ˜ì˜ í‘œí˜„</h3>
        <button
          onclick="testAPI('/api/expressions', 'expression-result')"
          class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-2 w-full"
        >
          GET /api/expressions
        </button>
        <button
          onclick="testAPI('/api/expressions/today', 'expression-result')"
          class="bg-green-400 text-white px-4 py-2 rounded hover:bg-green-500 mb-2 w-full text-sm"
        >
          GET /api/expressions/today
        </button>
        <pre
          id="expression-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Vocabulary -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ë‹¨ì–´ ê½ƒë°­</h3>
        <button
          onclick="testAPI('/api/vocabulary', 'vocab-result')"
          class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mb-2 w-full"
        >
          GET /api/vocabulary
        </button>
        <button
          onclick="testAPI('/api/vocabulary?level=A2', 'vocab-result')"
          class="bg-purple-400 text-white px-4 py-2 rounded hover:bg-purple-500 mb-2 w-full text-sm"
        >
          GET /api/vocabulary?level=A2
        </button>
        <pre
          id="vocab-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Pronunciation Words -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ë°œìŒ ì—°ìŠµ</h3>
        <button
          onclick="testAPI('/api/pronunciation-words', 'pronunciation-result')"
          class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 mb-2 w-full"
        >
          GET /api/pronunciation-words
        </button>
        <button
          onclick="testAPI('/api/pronunciation-words?level=A1', 'pronunciation-result')"
          class="bg-pink-400 text-white px-4 py-2 rounded hover:bg-pink-500 mb-2 w-full text-sm"
        >
          GET /api/pronunciation-words?level=A1
        </button>
        <pre
          id="pronunciation-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>
    </div>

    <!-- AI & Ollama APIs -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ¤– AI & Ollama API</h2>

      <!-- Ollama Models -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Ollama ëª¨ë¸</h3>
        <button
          onclick="testAPI('/api/ollama/models', 'ollama-models-result')"
          class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 mb-2 w-full"
        >
          GET /api/ollama/models
        </button>
        <pre
          id="ollama-models-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Content Generation -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ì½˜í…ì¸  ìƒì„±</h3>
        <div class="mb-2">
          <input
            type="text"
            id="content-topic"
            placeholder="ì£¼ì œ (ì˜ˆ: ì¹´í˜ì—ì„œ)"
            class="border rounded px-3 py-2 w-full mb-2"
          />
          <select
            id="content-level"
            class="border rounded px-3 py-2 w-full mb-2"
          >
            <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
            <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
            <option value="ê³ ê¸‰">ê³ ê¸‰</option>
          </select>
        </div>
        <button
          onclick="testGenerateContent()"
          class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 w-full"
        >
          POST /api/generate-content
        </button>
        <pre
          id="content-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-60 mt-2"
        ></pre>
      </div>

      <!-- Fluency Check -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">
          í•œêµ­ì–´ ë¬¸ì¥ í…ŒìŠ¤íŠ¸
        </h3>
        <textarea
          id="fluency-text"
          placeholder="í•œêµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”"
          class="border rounded px-3 py-2 w-full mb-2"
          rows="3"
        ></textarea>
        <button
          onclick="testFluencyCheck()"
          class="bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600 w-full"
        >
          POST /api/fluency-check
        </button>
        <pre
          id="fluency-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40 mt-2"
        ></pre>
      </div>

      <!-- Ollama Test -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Ollama í…ŒìŠ¤íŠ¸</h3>
        <textarea
          id="ollama-prompt"
          placeholder="í…ŒìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ ì…ë ¥"
          class="border rounded px-3 py-2 w-full mb-2"
          rows="2"
        ></textarea>
        <select
          id="ollama-model-select"
          class="border rounded px-3 py-2 w-full mb-2"
        >
          <option value="">(ìë™ ì„ íƒ)</option>
        </select>
        <button
          onclick="testOllamaTest()"
          class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 w-full"
        >
          POST /api/ollama/test
        </button>
        <pre
          id="ollama-test-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-60 mt-2"
        ></pre>
      </div>
    </div>

    <!-- MzTTS API -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ”Š MzTTS API</h2>

      <!-- TTS Server Info -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ì„œë²„ ì •ë³´</h3>
        <button
          onclick="testAPI('/api/tts/info', 'tts-info-result')"
          class="bg-cyan-500 text-white px-4 py-2 rounded hover:bg-cyan-600 mb-2 w-full"
        >
          GET /api/tts/info
        </button>
        <pre
          id="tts-info-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-60"
        ></pre>
      </div>

      <!-- TTS Generation -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ìŒì„± ìƒì„±</h3>
        <div class="space-y-2 mb-2">
          <input
            type="text"
            id="tts-text"
            placeholder="í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì…ë ¥ (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”)"
            class="border rounded px-3 py-2 w-full"
            value="ì•ˆë…•í•˜ì„¸ìš”"
          />
        </div>
        <button
          onclick="testTTSGeneration()"
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full"
        >
          POST /api/tts/generate (ìŒì„± ì¬ìƒ)
        </button>
        <div
          id="tts-result"
          class="mt-2 p-3 rounded text-sm bg-gray-100"
        ></div>
      </div>

      <!-- Speaker Guide -->
      <div class="bg-blue-50 p-3 rounded text-xs">
        <div class="font-semibold mb-1">ğŸ™ï¸ í™”ì ì •ë³´</div>
        <ul class="space-y-0.5 text-gray-700">
          <li>â€¢ í•œë‚˜ (Hanna): ì—¬ì„± ëª©ì†Œë¦¬</li>
          <li>â€¢ ê³ í’ˆì§ˆ í•œêµ­ì–´ ìŒì„± í•©ì„±</li>
          <li>â€¢ ìƒ˜í”Œë§ ë ˆì´íŠ¸: 22,050Hz</li>
        </ul>
      </div>
    </div>

    <!-- SpeechPro API -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ¤ SpeechPro API</h2>

      <!-- Sentences List -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ë¬¸ì¥ ëª©ë¡</h3>
        <button
          onclick="testAPI('/api/speechpro/sentences', 'speechpro-sentences-result')"
          class="bg-violet-500 text-white px-4 py-2 rounded hover:bg-violet-600 mb-2 w-full"
        >
          GET /api/speechpro/sentences
        </button>
        <pre
          id="speechpro-sentences-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Config -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">API ì„¤ì •</h3>
        <button
          onclick="testAPI('/api/speechpro/config', 'speechpro-config-result')"
          class="bg-violet-400 text-white px-4 py-2 rounded hover:bg-violet-500 mb-2 w-full"
        >
          GET /api/speechpro/config
        </button>
        <pre
          id="speechpro-config-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40"
        ></pre>
      </div>

      <!-- Evaluation Test -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">ë°œìŒ í‰ê°€ í…ŒìŠ¤íŠ¸</h3>
        <div class="space-y-2 mb-2">
          <input
            type="text"
            id="speechpro-text"
            placeholder="í‰ê°€í•  í…ìŠ¤íŠ¸ (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”)"
            class="border rounded px-3 py-2 w-full text-sm"
            value="ì•ˆë…•í•˜ì„¸ìš”"
          />
          <div class="flex gap-2">
            <button
              id="speechpro-record-btn"
              onclick="toggleSpeechProRecording()"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex-1"
            >
              ğŸ™ï¸ ë…¹ìŒ ì‹œì‘
            </button>
          </div>
          <div id="speechpro-recording-status" class="text-sm text-gray-600"></div>
        </div>
        <button
          id="speechpro-evaluate-btn"
          onclick="testSpeechProEvaluate()"
          class="bg-violet-600 text-white px-4 py-2 rounded hover:bg-violet-700 w-full"
          disabled
        >
          POST /api/speechpro/evaluate
        </button>
        <pre
          id="speechpro-evaluate-result"
          class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-60 mt-2"
        ></pre>
      </div>

      <!-- Guide -->
      <div class="bg-violet-50 p-3 rounded text-xs">
        <div class="font-semibold mb-1">ğŸ“‹ SpeechPro API ì •ë³´</div>
        <ul class="space-y-0.5 text-gray-700">
          <li>â€¢ GTP: í…ìŠ¤íŠ¸â†’ìŒì†Œ ë³€í™˜</li>
          <li>â€¢ Model: FST ë°œìŒ ëª¨ë¸ ìƒì„±</li>
          <li>â€¢ Score: ë°œìŒ ì ìˆ˜ í‰ê°€</li>
          <li>â€¢ AI í”¼ë“œë°± ìë™ ìƒì„±</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- API Documentation Section -->
  <div class="mt-8 bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“– API ë¬¸ì„œ</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
      <div>
        <h3 class="font-semibold text-gray-800 mb-2">í•™ìŠµ ê²Œì„ API</h3>
        <ul class="space-y-1 text-gray-600">
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/puzzle/sentences</code
            >
            - í¼ì¦ ë¬¸ì¥ ëª©ë¡
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/expressions</code
            >
            - í‘œí˜„ ëª©ë¡
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/expressions/today</code
            >
            - ì˜¤ëŠ˜ì˜ í‘œí˜„
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/vocabulary</code
            >
            - ë‹¨ì–´ ëª©ë¡
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/pronunciation-words</code
            >
            - ë°œìŒ ë‹¨ì–´ ëª©ë¡
          </li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-gray-800 mb-2">AI API</h3>
        <ul class="space-y-1 text-gray-600">
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/ollama/models</code
            >
            - Ollama ëª¨ë¸ ëª©ë¡
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >POST /api/generate-content</code
            >
            - ì½˜í…ì¸  ìƒì„±
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >POST /api/fluency-check</code
            >
            - ìœ ì°½ì„± í‰ê°€
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >POST /api/ollama/test</code
            >
            - Ollama ëª¨ë¸ í…ŒìŠ¤íŠ¸
          </li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-gray-800 mb-2">MzTTS API</h3>
        <ul class="space-y-1 text-gray-600">
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/tts/info</code
            >
            - TTS ì„œë²„ ì •ë³´
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >POST /api/tts/generate</code
            >
            - ìŒì„± ìƒì„± (í•œë‚˜ í™”ì, ê³ í’ˆì§ˆ ìŒì„±)
          </li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-gray-800 mb-2">SpeechPro API</h3>
        <ul class="space-y-1 text-gray-600">
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/speechpro/sentences</code
            >
            - í”„ë¦¬ì…‹ ë¬¸ì¥ ëª©ë¡
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >GET /api/speechpro/config</code
            >
            - API ì„¤ì • ì¡°íšŒ
          </li>
          <li>
            <code class="bg-gray-100 px-2 py-1 rounded"
              >POST /api/speechpro/evaluate</code
            >
            - ë°œìŒ í‰ê°€ (í…ìŠ¤íŠ¸ + ì˜¤ë””ì˜¤)
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  // SpeechPro recording state
  let speechProRecorder = null;
  let speechProChunks = [];

  // Toggle SpeechPro recording
  async function toggleSpeechProRecording() {
    const btn = document.getElementById("speechpro-record-btn");
    const status = document.getElementById("speechpro-recording-status");
    const evaluateBtn = document.getElementById("speechpro-evaluate-btn");

    if (!speechProRecorder || speechProRecorder.state === "inactive") {
      // Start recording
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        speechProRecorder = new MediaRecorder(stream);
        speechProChunks = [];

        speechProRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            speechProChunks.push(e.data);
          }
        };

        speechProRecorder.onstop = () => {
          const audioBlob = new Blob(speechProChunks, { type: "audio/webm" });
          window.speechProAudioBlob = audioBlob;
          status.textContent = `ë…¹ìŒ ì™„ë£Œ (${(audioBlob.size / 1024).toFixed(1)} KB)`;
          evaluateBtn.disabled = false;
          
          stream.getTracks().forEach(track => track.stop());
        };

        speechProRecorder.start();
        btn.textContent = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
        btn.classList.remove("bg-red-500", "hover:bg-red-600");
        btn.classList.add("bg-gray-500", "hover:bg-gray-600");
        status.textContent = "ë…¹ìŒ ì¤‘... ğŸ”´";
        evaluateBtn.disabled = true;
      } catch (error) {
        status.textContent = `ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`;
      }
    } else {
      // Stop recording
      speechProRecorder.stop();
      btn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì‹œì‘";
      btn.classList.remove("bg-gray-500", "hover:bg-gray-600");
      btn.classList.add("bg-red-500", "hover:bg-red-600");
    }
  }

  // Test SpeechPro evaluation
  async function testSpeechProEvaluate() {
    const resultElement = document.getElementById("speechpro-evaluate-result");
    const text = document.getElementById("speechpro-text").value;
    const audioBlob = window.speechProAudioBlob;

    if (!text) {
      resultElement.textContent = "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    if (!audioBlob) {
      resultElement.textContent = "ë¨¼ì € ë…¹ìŒì„ ì™„ë£Œí•˜ì„¸ìš”.";
      return;
    }

    resultElement.textContent = "í‰ê°€ ì¤‘...";

    try {
      const formData = new FormData();
      formData.append("text", text);
      formData.append("audio", audioBlob, "recording.webm");

      const response = await fetch("/api/speechpro/evaluate", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      
      // Format result nicely
      let displayText = JSON.stringify(data, null, 2);
      if (data.success) {
        const score = data.overall_score || 0;
        const feedback = data.ai_feedback || "í”¼ë“œë°± ì—†ìŒ";
        displayText = `âœ… í‰ê°€ ì„±ê³µ\n\nì ìˆ˜: ${Math.round(score)}ì \n\n${feedback}\n\nì „ì²´ ì‘ë‹µ:\n${displayText}`;
      }
      
      resultElement.textContent = displayText;
    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Simple GET API test
  async function testAPI(endpoint, resultId) {
    const resultElement = document.getElementById(resultId);
    resultElement.textContent = "Loading...";

    try {
      const response = await fetch(endpoint);
      const data = await response.json();
      resultElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Test content generation
  async function testGenerateContent() {
    const resultElement = document.getElementById("content-result");
    const topic = document.getElementById("content-topic").value || "ì¹´í˜ì—ì„œ";
    const level = document.getElementById("content-level").value;

    resultElement.textContent = "Loading...";

    try {
      const formData = new FormData();
      formData.append("topic", topic);
      formData.append("level", level);

      const response = await fetch("/api/generate-content", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      resultElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Test fluency check
  async function testFluencyCheck() {
    const resultElement = document.getElementById("fluency-result");
    const text = document.getElementById("fluency-text").value;

    if (!text) {
      resultElement.textContent = "ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    resultElement.textContent = "Loading...";

    try {
      const formData = new FormData();
      formData.append("user_text", text);

      const response = await fetch("/api/fluency-check", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      resultElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Test Ollama
  async function testOllamaTest() {
    const resultElement = document.getElementById("ollama-test-result");
    const prompt = document.getElementById("ollama-prompt").value;
    const model = document.getElementById("ollama-model-select")?.value || "";

    if (!prompt) {
      resultElement.textContent = "í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    resultElement.textContent = "Loading...";

    try {
      const formData = new FormData();
      formData.append("prompt", prompt);
      if (model) {
        formData.append("model", model);
      }

      const response = await fetch("/api/ollama/test", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      resultElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Load available Ollama models into the select on page load
  async function loadOllamaModels() {
    const select = document.getElementById("ollama-model-select");
    if (!select) return;
    try {
      const res = await fetch("/api/ollama/models");
      if (!res.ok) return;
      const data = await res.json();

      let models = [];
      if (Array.isArray(data)) {
        models = data;
      } else if (Array.isArray(data.models)) {
        models = data.models;
      } else if (data && typeof data === "object") {
        // try common shapes
        if (Array.isArray(data.items)) models = data.items;
        else if (Array.isArray(data.available)) models = data.available;
      }

      // Populate select, keep the first auto option
      select.innerHTML = '<option value="">(ìë™ ì„ íƒ)</option>';
      models.forEach((m) => {
        const opt = document.createElement("option");
        let id = m;
        let label = m;
        if (m && typeof m === "object") {
          id = m.id || m.name || m.model || JSON.stringify(m);
          // Prefer a human-friendly label if available
          label =
            m.id ||
            m.name ||
            (m.description ? `${m.id} â€” ${m.description}` : id);
        }
        opt.value = id;
        opt.textContent = label;
        select.appendChild(opt);
      });
    } catch (err) {
      console.error("Failed to load Ollama models", err);
    }
  }

  // Test TTS generation
  async function testTTSGeneration() {
    const resultElement = document.getElementById("tts-result");
    const text = document.getElementById("tts-text").value;

    if (!text) {
      resultElement.textContent = "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    resultElement.textContent = "ìŒì„± ìƒì„± ì¤‘...";

    try {
      const payload = {
        text: text,
        speaker: 0,
        tempo: 1.0,
        pitch: 1.0,
        gain: 1.0
      };

      const response = await fetch("/api/tts/generate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        resultElement.textContent = `Error: ${JSON.stringify(errorData, null, 2)}`;
        return;
      }

      // Get audio blob and play
      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);

      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        resultElement.textContent = "ì¬ìƒ ì™„ë£Œ âœ“";
      };

      audio.onerror = () => {
        resultElement.textContent = "ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨";
      };

      await audio.play();
      resultElement.textContent = "ì¬ìƒ ì¤‘... ğŸ”Š";

    } catch (error) {
      resultElement.textContent = `Error: ${error.message}`;
    }
  }

  // Populate models now
  loadOllamaModels();
</script>
{% endblock %}
