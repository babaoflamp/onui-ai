{% extends "base.html" %} {% block title %}ë°œìŒ í‰ê°€ - ì˜¤ëˆ„ì´ AI{% endblock %}
{% block content %}
<div
  class="min-h-screen bg-gradient-to-br from-[var(--bg1)] via-white to-[var(--bg2)] p-6"
>
  <div class="max-w-4xl mx-auto">
    <!-- í—¤ë” -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-[var(--text-main)] mb-2">
        ğŸ—£ï¸ ë°œìŒ í‰ê°€
      </h1>
      <p class="text-[var(--text-sub)] text-lg">
        í•œêµ­ì–´ ë°œìŒì„ í‰ê°€ë°›ê³  ê°œì„ ì ì„ ì°¾ì•„ë³´ì„¸ìš”
      </p>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
      <!-- ë¬¸ì¥ ì„ íƒ ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-3">
          ğŸ“š í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥
        </label>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <select
            id="sentence-select"
            onchange="selectSentence()"
            class="flex-1 px-4 py-3 border-2 border-[var(--accent)] rounded-lg focus:outline-none focus:border-[var(--accent)] transition"
          >
            <option value="">-- ë¬¸ì¥ ì„ íƒ --</option>
          </select>
          <button
            onclick="loadSentences()"
            class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:opacity-90 transition"
          >
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      <!-- í…ìŠ¤íŠ¸ ì…ë ¥ ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-3">
          í‰ê°€í•  ë¬¸ì¥
        </label>
        <input
          type="text"
          id="evaluation-text"
          placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”"
          class="w-full px-4 py-3 border-2 border-[var(--accent)] rounded-lg focus:outline-none focus:border-[var(--accent)] transition"
          value="ì•ˆë…•í•˜ì„¸ìš”"
        />
      </div>

      <!-- ë¬¸ì¥ ì •ë³´ ì„¹ì…˜ (ì„ íƒëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
      <div
        id="sentence-info-section"
        class="hidden mb-8 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500"
      >
        <div class="mb-2">
          <span class="text-sm font-semibold text-blue-900">ë ˆë²¨:</span>
          <span id="sentence-level" class="text-sm text-blue-800 ml-2"></span>
        </div>
        <div class="mb-2">
          <span class="text-sm font-semibold text-blue-900">ë‚œì´ë„:</span>
          <span
            id="sentence-difficulty"
            class="text-sm text-blue-800 ml-2"
          ></span>
        </div>
        <div class="mb-2">
          <span class="text-sm font-semibold text-blue-900">ì¹´í…Œê³ ë¦¬:</span>
          <span
            id="sentence-category"
            class="text-sm text-blue-800 ml-2"
          ></span>
        </div>
        <div class="mb-2">
          <span class="text-sm font-semibold text-blue-900">ì˜ì–´:</span>
          <span id="sentence-en" class="text-sm text-blue-800 ml-2"></span>
        </div>
        <div>
          <span class="text-sm font-semibold text-blue-900">íŒ:</span>
          <span
            id="sentence-tips"
            class="text-sm text-blue-800 ml-2 italic"
          ></span>
        </div>
      </div>

      <!-- ë ˆì½”ë”© ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-4">
          ìŒì„± ë…¹ìŒ
        </label>

        <div
          class="border-2 border-dashed border-[var(--accent)] rounded-lg p-8 text-center bg-gray-50"
        >
          <div id="recording-status" class="mb-4">
            <div class="text-6xl mb-2">ğŸ¤</div>
            <p class="text-gray-600">ë…¹ìŒ ì¤€ë¹„ ì™„ë£Œ</p>
          </div>

          <!-- ë…¹ìŒ ì‹œê°„ í‘œì‹œ -->
          <div
            id="recording-timer"
            class="text-2xl font-mono text-[var(--accent)] mb-4 hidden"
          >
            00:00
          </div>

          <!-- ë…¹ìŒ ë²„íŠ¼ë“¤ -->
          <div class="flex justify-center gap-3 flex-wrap">
            <button
              id="start-recording"
              onclick="startRecording()"
              class="px-6 py-3 bg-[var(--accent)] text-white rounded-lg font-semibold hover:opacity-90 transition"
            >
              â–¶ï¸ ë…¹ìŒ ì‹œì‘
            </button>
            <button
              id="stop-recording"
              onclick="stopRecording()"
              class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:opacity-90 transition hidden"
            >
              â¹ï¸ ë…¹ìŒ ì¤‘ì§€
            </button>
            <button
              id="clear-recording"
              onclick="clearRecording()"
              class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:opacity-90 transition hidden"
            >
              ğŸ—‘ï¸ ì´ˆê¸°í™”
            </button>
          </div>

          <!-- ì¬ìƒ ë²„íŠ¼ -->
          <div id="playback-section" class="mt-6 hidden">
            <p class="text-sm text-gray-600 mb-3">ë…¹ìŒëœ ìŒì„±:</p>
            <audio
              id="audio-playback"
              controls
              class="w-full mb-3 rounded-lg"
            ></audio>
          </div>
        </div>
      </div>

      <!-- í‰ê°€ ë²„íŠ¼ -->
      <div class="flex justify-center gap-3">
        <button
          id="evaluate-button"
          onclick="evaluatePronunciation()"
          class="px-8 py-4 bg-gradient-to-r from-[var(--accent)] to-orange-500 text-white rounded-lg font-semibold text-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          ğŸ¯ ë°œìŒ í‰ê°€í•˜ê¸°
        </button>
      </div>
    </div>

    <!-- ê²°ê³¼ ëª¨ë‹¬ -->
    <div
      id="results-modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
    >
      <div
        class="relative w-full max-w-3xl max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-2xl p-8"
      >
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl"
          onclick="closeResults()"
          aria-label="ë‹«ê¸°"
        >
          âœ•
        </button>

        <h2 class="text-2xl font-bold text-[var(--text-main)] mb-6">
          ğŸ“Š í‰ê°€ ê²°ê³¼
        </h2>

        <!-- ì ìˆ˜ ì¹´ë“œ -->
        <div id="score-card" class="bg-white rounded-2xl shadow p-6 mb-6">
          <!-- ì „ì²´ ì ìˆ˜ -->
          <div class="mb-6">
            <div class="text-center">
              <div class="text-6xl font-bold text-[var(--accent)] mb-2">
                <span id="overall-score">0</span>/100
              </div>
              <p
                id="score-feedback"
                class="text-lg text-[var(--text-sub)] font-semibold"
              ></p>
            </div>

            <!-- ì ìˆ˜ ê²Œì´ì§€ -->
            <div class="mt-6">
              <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div
                  id="score-bar"
                  class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>

          <!-- ìƒì„¸ ì •ë³´ -->
          <div id="details-section" class="border-t pt-6">
            <h3 class="text-lg font-semibold text-[var(--text-main)] mb-4">
              ìƒì„¸ ë¶„ì„
            </h3>
            <div id="details-content" class="space-y-3 text-[var(--text-sub)]">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <!-- SpeechPro ë¶„ì„ -->
          <div class="border-t pt-6 mt-6">
            <h3
              class="text-lg font-semibold text-orange-900 mb-4 flex items-center gap-2"
            >
              <span class="text-2xl">ğŸ¯</span> SpeechPro ì •í™•ë„ ë¶„ì„
            </h3>
            <div
              id="speechpro-content"
              class="bg-orange-50 border-l-4 border-orange-400 rounded-lg p-4 space-y-2 text-orange-800"
            >
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <!-- FluencyPro ë¶„ì„ -->
          <div class="border-t pt-6 mt-6">
            <h3
              class="text-lg font-semibold text-purple-900 mb-4 flex items-center gap-2"
            >
              <span class="text-2xl">ğŸŒŠ</span> FluencyPro ìœ ì°½ì„± ë¶„ì„
            </h3>
            <div
              id="fluencypro-content"
              class="bg-purple-50 border-l-4 border-purple-400 rounded-lg p-4 space-y-2 text-purple-800"
            >
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </div>

        <!-- í”¼ë“œë°± ì„¹ì…˜ -->
        <div
          class="bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-600 rounded-lg p-8 mb-6 shadow-md"
        >
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">ğŸ¤–</span>
            <h3 class="text-xl font-bold text-blue-900">AI ì¢…í•© í”¼ë“œë°±</h3>
          </div>
          <div
            id="feedback-content"
            class="text-blue-800 space-y-3 leading-relaxed text-base"
          >
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <button
            onclick="closeResults()"
            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
          >
            ë‹«ê¸°
          </button>
          <button
            onclick="resetEvaluation()"
            class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:opacity-90 transition"
          >
            ğŸ”„ ë‹¤ì‹œ í‰ê°€í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div
      id="error-section"
      class="hidden bg-red-50 border-l-4 border-red-500 rounded-lg p-6"
    >
      <h3 class="text-lg font-semibold text-red-900 mb-2">âŒ ì˜¤ë¥˜</h3>
      <p id="error-message" class="text-red-800"></p>
    </div>

    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="loading-section" class="hidden text-center py-12">
      <div class="inline-block">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-[var(--accent)] border-t-transparent mb-4"
        ></div>
        <p class="text-[var(--text-sub)] font-semibold">í‰ê°€ ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // ì „ì—­ ë³€ìˆ˜
  let mediaRecorder = null;
  let recordedChunks = [];
  let recordingStartTime = null;
  let recordingTimer = null;
  let selectedSentence = null;

  // ë…¹ìŒ ì‹œì‘
  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      recordingStartTime = Date.now();

      mediaRecorder.ondataavailable = (event) => {
        recordedChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(recordedChunks, { type: "audio/wav" });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById("audio-playback").src = audioUrl;
        document.getElementById("playback-section").classList.remove("hidden");
        document.getElementById("evaluate-button").disabled = false;
      };

      mediaRecorder.start();

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("start-recording").classList.add("hidden");
      document.getElementById("stop-recording").classList.remove("hidden");
      document.getElementById("clear-recording").classList.remove("hidden");
      document.getElementById("recording-status").innerHTML =
        'ğŸ”´ <p class="text-red-600 font-semibold">ë…¹ìŒ ì¤‘...</p>';
      document.getElementById("recording-timer").classList.remove("hidden");

      // íƒ€ì´ë¨¸ ì‹œì‘
      startTimer();

      showMessage("ë…¹ìŒì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤", "info");
    } catch (error) {
      showError(`ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`);
    }
  }

  // ë…¹ìŒ ì¤‘ì§€
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach((track) => track.stop());

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("start-recording").classList.remove("hidden");
      document.getElementById("stop-recording").classList.add("hidden");
      document.getElementById("recording-status").innerHTML =
        'âœ… <p class="text-green-600 font-semibold">ë…¹ìŒ ì™„ë£Œ</p>';
      document.getElementById("recording-timer").classList.add("hidden");

      // íƒ€ì´ë¨¸ ì¤‘ì§€
      stopTimer();

      showMessage("ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤", "success");
    }
  }

  // ë…¹ìŒ ì´ˆê¸°í™”
  function clearRecording() {
    mediaRecorder = null;
    recordedChunks = [];
    recordingStartTime = null;

    document.getElementById("audio-playback").src = "";
    document.getElementById("playback-section").classList.add("hidden");
    document.getElementById("recording-status").innerHTML =
      'ğŸ¤ <p class="text-gray-600">ë…¹ìŒ ì¤€ë¹„ ì™„ë£Œ</p>';
    document.getElementById("recording-timer").classList.add("hidden");
    document.getElementById("start-recording").classList.remove("hidden");
    document.getElementById("stop-recording").classList.add("hidden");
    document.getElementById("clear-recording").classList.add("hidden");
    document.getElementById("evaluate-button").disabled = true;

    hideError();
  }

  // íƒ€ì´ë¨¸ ê´€ë ¨
  function startTimer() {
    recordingTimer = setInterval(() => {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById("recording-timer").textContent = `${String(
        minutes
      ).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }, 100);
  }

  function stopTimer() {
    if (recordingTimer) {
      clearInterval(recordingTimer);
    }
  }

  // ë°œìŒ í‰ê°€ ì‹¤í–‰
  async function evaluatePronunciation() {
    const text = document.getElementById("evaluation-text").value.trim();
    const audioElement = document.getElementById("audio-playback");

    if (!text) {
      showError("í‰ê°€í•  ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    if (!audioElement.src) {
      showError("ìŒì„±ì„ ë…¹ìŒí•˜ì„¸ìš”");
      return;
    }

    // ë¡œë”© í‘œì‹œ
    showLoading();
    hideError();

    const controller = new AbortController();
    const timeoutMs = 25000;
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
      // ì˜¤ë””ì˜¤ ë°ì´í„° ìˆ˜ì§‘
      const audio = new Audio(audioElement.src);
      const audioBlob = await fetch(audioElement.src).then((r) => r.blob());

      // FormData ìƒì„±
      const formData = new FormData();
      formData.append("text", text);
      formData.append("audio", audioBlob, "recording.wav");

      // í”„ë¦¬ì…‹ ë¬¸ì¥ì¸ ê²½ìš° ì‚¬ì „ ê³„ì‚° ì •ë³´ ì „ì†¡
      if (
        selectedSentence &&
        selectedSentence.syll_ltrs &&
        selectedSentence.syll_phns &&
        selectedSentence.fst
      ) {
        formData.append("syll_ltrs", selectedSentence.syll_ltrs);
        formData.append("syll_phns", selectedSentence.syll_phns);
        formData.append("fst", selectedSentence.fst);
      }

      // API í˜¸ì¶œ
      const response = await fetch("/api/speechpro/evaluate", {
        method: "POST",
        body: formData,
        signal: controller.signal,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || "í‰ê°€ ì‹¤íŒ¨");
      }

      const result = await response.json();

      if (result.success) {
        displayResults(result);
      } else {
        showError(result.error || "í‰ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      }
    } catch (error) {
      if (error.name === "AbortError") {
        showError("ìš”ì²­ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      } else {
        showError(`í‰ê°€ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
      }
    } finally {
      clearTimeout(timeoutId);
      hideLoading();
    }
  }

  // ê²°ê³¼ í‘œì‹œ
  function displayResults(result) {
    const score = Math.round(result.overall_score || 0);

    // ì ìˆ˜ ì—…ë°ì´íŠ¸
    document.getElementById("overall-score").textContent = score;

    // í”¼ë“œë°± ë©”ì‹œì§€
    let feedback = "";
    if (score >= 90) feedback = "ì™„ë²½í•œ ë°œìŒì…ë‹ˆë‹¤! ğŸŒŸ";
    else if (score >= 80) feedback = "ë§¤ìš° ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤! ğŸ‘";
    else if (score >= 70)
      feedback = "ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ì—°ìŠµí•˜ë©´ ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš” ğŸ’ª";
    else if (score >= 60)
      feedback = "ë” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì†í•´ì„œ ë…¸ë ¥í•´ë³´ì„¸ìš” ğŸ“š";
    else feedback = "ë§ì€ ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. ì²œì²œíˆ ë”°ë¼í•´ë³´ì„¸ìš” ğŸ¯";

    document.getElementById("score-feedback").textContent = feedback;

    // ì ìˆ˜ ë°” ì—…ë°ì´íŠ¸
    document.getElementById("score-bar").style.width = score + "%";

    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    let detailsHtml = "";
    if (result.score && result.score.details) {
      const details = result.score.details;

      // fluency ì •ë³´
      if (details.fluency) {
        const f = details.fluency;
        detailsHtml += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">ğŸ¯ ìœ ì°½ì„± (Fluency)</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>ë°œí™” ì†ë„: <span class="font-medium">${(
                f["speech rate"] || 0
              ).toFixed(1)} ìŒì ˆ/ì´ˆ</span></div>
              <div>ì¡°ìŒ ì†ë„: <span class="font-medium">${(
                f["articulation rate"] || 0
              ).toFixed(1)} ìŒì ˆ/ì´ˆ</span></div>
              <div>ë°œí™” ê¸¸ì´: <span class="font-medium">${(
                f["articulation length"] || 0
              ).toFixed(2)}ì´ˆ</span></div>
              <div>ì´ ê¸¸ì´: <span class="font-medium">${(
                f.duration || 0
              ).toFixed(2)}ì´ˆ</span></div>
              <div>ì •í™• ìŒì ˆ: <span class="font-medium">${
                f["correct syllable count"] || 0
              }/${f["syllable count"] || 0}</span></div>
              <div>ì •í™• ë‹¨ì–´: <span class="font-medium">${
                f["correct word count"] || 0
              }/${f["word count"] || 0}</span></div>
            </div>
          </div>
        `;
      }

      // quality ì •ë³´ - ë¬¸ì¥ë³„ ì ìˆ˜
      if (details.quality && details.quality.sentences) {
        const sentences = details.quality.sentences.filter(
          (s) => s.text !== "!SIL"
        );
        if (sentences.length > 0) {
          detailsHtml += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ ë¬¸ì¥ë³„ í‰ê°€</h4>
              <div class="space-y-2">
          `;

          sentences.forEach((sent) => {
            const sentScore = Math.round(sent.score || 0);
            const barColor =
              sentScore >= 80
                ? "bg-green-500"
                : sentScore >= 60
                ? "bg-yellow-500"
                : "bg-red-500";
            detailsHtml += `
              <div class="text-sm">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-medium">${sent.text || "(ë¬¸ì¥)"}</span>
                  <span class="text-gray-600">${sentScore}ì </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="${barColor} h-2 rounded-full" style="width: ${sentScore}%"></div>
                </div>
              </div>
            `;
          });

          detailsHtml += `
              </div>
            </div>
          `;
        }
      }

      // ë‹¨ì–´ë³„ ìƒì„¸ ë¶„ì„ (ëª¨ë“  ë¬¸ì¥ì˜ ë‹¨ì–´ë“¤)
      if (details.quality && details.quality.sentences) {
        const allWords = [];
        details.quality.sentences.forEach((sent) => {
          if (sent.text !== "!SIL" && sent.words && sent.words.length > 0) {
            sent.words.forEach((word) => {
              if (word.text && word.text !== "!SIL") {
                allWords.push(word);
              }
            });
          }
        });

        if (allWords.length > 0) {
          detailsHtml += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">ğŸ” ë‹¨ì–´ë³„ ë¶„ì„</h4>
              <div class="space-y-3">
          `;

          allWords.forEach((word) => {
            const wordScore = Math.round(word.score || 0);
            const scoreColor =
              wordScore >= 90
                ? "text-green-600"
                : wordScore >= 70
                ? "text-yellow-600"
                : "text-red-600";
            const barColor =
              wordScore >= 90
                ? "bg-green-500"
                : wordScore >= 70
                ? "bg-yellow-500"
                : "bg-red-500";

            detailsHtml += `
              <div class="border-l-4 ${barColor.replace(
                "bg-",
                "border-"
              )} pl-3 py-2 bg-gray-50 rounded">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-bold text-lg">${word.text || ""}</span>
                  <span class="${scoreColor} font-semibold">${wordScore}ì </span>
                </div>
            `;

            // ìŒì ˆë³„ ë¶„ì„
            if (word.syll && word.syll.length > 0) {
              detailsHtml += `<div class="ml-2 space-y-2 text-sm">`;

              word.syll.forEach((syll) => {
                const syllScore = Math.round(syll.score || 0);
                const syllColor =
                  syllScore >= 90
                    ? "text-green-600"
                    : syllScore >= 70
                    ? "text-yellow-600"
                    : "text-red-600";

                detailsHtml += `
                  <div class="bg-white rounded p-2">
                    <div class="flex justify-between items-center mb-1">
                      <span class="font-semibold text-gray-700">ìŒì ˆ: <span class="text-gray-900">${
                        syll.text || ""
                      }</span></span>
                      <span class="${syllColor}">${syllScore}ì </span>
                    </div>
                `;

                // ìŒì†Œë³„ ë¶„ì„
                if (syll.phones && syll.phones.length > 0) {
                  detailsHtml += `<div class="ml-3 mt-1 space-y-1 text-xs">`;

                  syll.phones.forEach((phone) => {
                    const phoneScore = Math.round(phone.score || 0);
                    const phoneColor =
                      phoneScore >= 90
                        ? "text-green-600"
                        : phoneScore >= 70
                        ? "text-yellow-600"
                        : "text-red-600";

                    detailsHtml += `
                      <div class="flex items-center justify-between border-l-2 border-gray-300 pl-2 py-1">
                        <div class="flex items-center gap-2">
                          <span class="font-mono font-bold">${
                            phone.symbol || ""
                          }</span>
                          <span class="text-gray-500">(${
                            phone.text || ""
                          })</span>
                        </div>
                        <span class="${phoneColor} font-semibold">${phoneScore}ì </span>
                      </div>
                    `;
                  });

                  detailsHtml += `</div>`;
                }

                detailsHtml += `</div>`;
              });

              detailsHtml += `</div>`;
            }

            detailsHtml += `</div>`;
          });

          detailsHtml += `
              </div>
            </div>
          `;
        }
      }
    }

    if (!detailsHtml) {
      detailsHtml = "<div>ë°œìŒ í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>";
    }

    document.getElementById("details-content").innerHTML = detailsHtml;

    // SpeechPro ë¶„ì„ í‘œì‹œ
    let speechproHtml = "";
    const quality = details.quality || {};
    if (quality.sentences && quality.sentences.length > 0) {
      const sent = quality.sentences[0];
      speechproHtml += `<div class="text-sm space-y-1">`;
      if (sent.accuracy_percentage !== undefined) {
        speechproHtml += `<div>âœ“ ì •í™• ë°œìŒ: <strong>${sent.accuracy_percentage.toFixed(
          1
        )}%</strong></div>`;
      }
      if (sent.completeness_percentage !== undefined) {
        speechproHtml += `<div>âœ“ ì™„ì„±ë„: <strong>${sent.completeness_percentage.toFixed(
          1
        )}%</strong></div>`;
      }
      if (sent.syllable_count !== undefined) {
        speechproHtml += `<div>âœ“ ìŒì ˆ ìˆ˜: <strong>${sent.syllable_count}</strong></div>`;
      }
      speechproHtml += `</div>`;
    }
    if (!speechproHtml) {
      speechproHtml = "<div class='text-sm'>SpeechPro ìƒì„¸ ë°ì´í„° ì—†ìŒ</div>";
    }
    document.getElementById("speechpro-content").innerHTML = speechproHtml;

    // FluencyPro ë¶„ì„ í‘œì‹œ
    let fluencyHtml = "";
    const fluency = details.fluency || {};
    if (Object.keys(fluency).length > 0) {
      fluencyHtml += `<div class="text-sm space-y-1">`;
      const speechRate = fluency["speech rate"] || fluency.speech_rate || 0;
      const correctSyll =
        fluency["correct syllable count"] || fluency.correct_syllables || 0;
      const totalSyll =
        fluency["syllable count"] || fluency.total_syllables || 1;
      const syllAcc = ((correctSyll / totalSyll) * 100).toFixed(1);

      if (speechRate > 0) {
        fluencyHtml += `<div>ğŸ¯ ë°œí™” ì†ë„: <strong>${speechRate.toFixed(
          1
        )}</strong> ìŒì ˆ/ì´ˆ</div>`;
      }
      fluencyHtml += `<div>âœ“ ì •í™• ìŒì ˆ: <strong>${correctSyll}/${totalSyll}</strong> (${syllAcc}%)</div>`;
      fluencyHtml += `</div>`;
    }
    if (!fluencyHtml) {
      fluencyHtml = "<div class='text-sm'>FluencyPro ìƒì„¸ ë°ì´í„° ì—†ìŒ</div>";
    }
    document.getElementById("fluencypro-content").innerHTML = fluencyHtml;

    // AI í”¼ë“œë°± í‘œì‹œ
    const feedbackContent = document.getElementById("feedback-content");
    if (result.ai_feedback) {
      feedbackContent.innerHTML = `
        <div class="whitespace-pre-wrap leading-relaxed">
          ${result.ai_feedback}
        </div>
      `;
    } else {
      // ê¸°ë³¸ í”¼ë“œë°±
      let defaultFeedback = "";
      if (score >= 90) {
        defaultFeedback = "ì™„ë²½í•œ ë°œìŒì…ë‹ˆë‹¤! ê³„ì† ì´ë ‡ê²Œ ì—°ìŠµí•˜ì„¸ìš”.";
      } else if (score >= 80) {
        defaultFeedback =
          "ë§¤ìš° ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ì™„ë²½í•´ì§ˆ ê±°ì˜ˆìš”!";
      } else if (score >= 70) {
        defaultFeedback =
          "ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤. ì–´ë ¤ìš´ ë°œìŒì— ì¡°ê¸ˆ ë” ì§‘ì¤‘í•´ë³´ì„¸ìš”.";
      } else if (score >= 60) {
        defaultFeedback =
          "ë°œìŒì´ ë§ì´ ì¢‹ì•„ì§€ê³  ìˆì–´ìš”. ì²œì²œíˆ ì •í™•í•˜ê²Œ ë°œìŒí•´ë³´ì„¸ìš”.";
      } else {
        defaultFeedback =
          "ì²œì²œíˆ ë˜ë°•ë˜ë°• ë°œìŒí•˜ë©° ì—°ìŠµí•´ë³´ì„¸ìš”. ê¾¸ì¤€íˆ í•˜ë©´ ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”!";
      }
      feedbackContent.innerHTML = `<div>${defaultFeedback}</div>`;
    }

    // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
    document.getElementById("results-modal").classList.remove("hidden");
  }

  // í‰ê°€ ì´ˆê¸°í™”
  function resetEvaluation() {
    closeResults();
    document.getElementById("evaluation-text").value = "ì•ˆë…•í•˜ì„¸ìš”";
    document.getElementById("sentence-select").value = "";
    selectedSentence = null;
    document.getElementById("sentence-info-section").classList.add("hidden");
    document.getElementById("sentence-level").textContent = "";
    document.getElementById("sentence-difficulty").textContent = "";
    document.getElementById("sentence-category").textContent = "";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("sentence-tips").textContent = "";
    clearRecording();
  }

  function closeResults() {
    document.getElementById("results-modal").classList.add("hidden");
  }

  // ë©”ì‹œì§€ í‘œì‹œ
  function showMessage(message, type = "info") {
    // ê°„ë‹¨í•œ ë©”ì‹œì§€ í‘œì‹œ (í† ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥)
    console.log(`[${type.toUpperCase()}] ${message}`);
  }

  // ì—ëŸ¬ í‘œì‹œ
  function showError(message) {
    document.getElementById("error-section").classList.remove("hidden");
    document.getElementById("error-message").textContent = message;
  }

  function hideError() {
    document.getElementById("error-section").classList.add("hidden");
  }

  // ë¡œë”© í‘œì‹œ
  function showLoading() {
    document.getElementById("loading-section").classList.remove("hidden");
  }

  function hideLoading() {
    document.getElementById("loading-section").classList.add("hidden");
  }

  // ë¬¸ì¥ ë°ì´í„° ë¡œë“œ
  async function loadSentences() {
    try {
      showLoading();
      const response = await fetch("/api/speechpro/sentences");

      if (!response.ok) {
        throw new Error("ë¬¸ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      }

      const sentences = await response.json();
      const select = document.getElementById("sentence-select");

      // ì˜µì…˜ ì´ˆê¸°í™”
      select.innerHTML = '<option value="">-- ë¬¸ì¥ ì„ íƒ --</option>';

      // ë¬¸ì¥ ì˜µì…˜ ì¶”ê°€
      sentences.forEach((sentence) => {
        const option = document.createElement("option");
        option.value = JSON.stringify(sentence);
        const sourceLabel =
          sentence.source === "precomputed" ? "[í”„ë¦¬ì…‹] " : "";
        option.textContent = `${sourceLabel}[${sentence.level}] ${sentence.sentenceKr}`;
        select.appendChild(option);
      });

      hideError();
    } catch (error) {
      showError(`ë¬¸ì¥ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      hideLoading();
    }
  }

  // ë¬¸ì¥ ì„ íƒ
  function selectSentence() {
    const select = document.getElementById("sentence-select");

    if (!select.value) {
      // ì„ íƒ í•´ì œ
      selectedSentence = null;
      document.getElementById("sentence-level").textContent = "";
      document.getElementById("sentence-difficulty").textContent = "";
      document.getElementById("sentence-category").textContent = "";
      document.getElementById("sentence-en").textContent = "";
      document.getElementById("sentence-tips").textContent = "";
      document.getElementById("sentence-info-section").classList.add("hidden");
      return;
    }

    try {
      const sentence = JSON.parse(select.value);
      selectedSentence = sentence;

      // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      document.getElementById("evaluation-text").value = sentence.sentenceKr;

      // ì •ë³´ í‘œì‹œ
      document.getElementById("sentence-level").textContent =
        sentence.level || "";
      document.getElementById("sentence-difficulty").textContent =
        sentence.difficulty || "";
      document.getElementById("sentence-category").textContent =
        sentence.category || "";
      document.getElementById("sentence-en").textContent =
        sentence.sentenceEn || "";
      document.getElementById("sentence-tips").textContent =
        sentence.tips || "";
      document
        .getElementById("sentence-info-section")
        .classList.remove("hidden");

      hideError();
    } catch (error) {
      showError("ë¬¸ì¥ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
    }
  }

  // ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", () => {
    // í‰ê°€ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ
    document.getElementById("evaluate-button").disabled = true;

    // ë¬¸ì¥ ë°ì´í„° ë¡œë“œ
    loadSentences();
  });
</script>
{% endblock %}
