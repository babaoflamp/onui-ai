{% extends "base.html" %} {% block title %}ë°œìŒ ì •í™•ë„ í‰ê°€ - ì˜¤ëˆ„ì´ AI{%
endblock %} {% block content %}
<div
  class="min-h-screen bg-gradient-to-br from-[var(--bg1)] via-white to-[var(--bg2)] p-6"
>
  <div class="max-w-4xl mx-auto">
    <!-- í—¤ë” -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-[var(--text-main)] mb-2">
        ğŸ¤ ë°œìŒ ì •í™•ë„ í‰ê°€
      </h1>
      <p class="text-[var(--text-sub)] text-lg">
        í•œêµ­ì–´ ë°œìŒì˜ ì •í™•ë„ë¥¼ í‰ê°€ë°›ê³  ê°œë³„ ìŒì†Œë³„ í”¼ë“œë°±ì„ ì–»ì–´ë³´ì„¸ìš”
      </p>
    </div>

    <!-- SpeechPro ì¥ì  ëª¨ë‹¬ -->
    <div
      id="speechpro-advantages-modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
      aria-modal="true"
      role="dialog"
    >
      <div id="speechpro-advantages-overlay" class="absolute inset-0"></div>
      <div
        class="relative bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6 md:p-8 overflow-y-auto max-h-[90vh]"
      >
        <button
          id="speechpro-advantages-close"
          type="button"
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl"
          aria-label="ë‹«ê¸°"
        >
          Ã—
        </button>

        <h3 class="text-2xl font-bold text-blue-900 mb-4">
          ğŸ¤ SpeechPro ë°œìŒ ì •í™•ë„ í‰ê°€ì˜ ì¥ì 
        </h3>

        <div class="space-y-4">
          <div
            class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-lg shadow-md border-2 border-amber-400"
          >
            <div class="flex items-start gap-2">
              <span class="text-3xl">ğŸ¤–</span>
              <div class="flex-1">
                <h4 class="font-bold text-amber-900 text-lg">
                  AI ë³µí•© í”¼ë“œë°± (ì°¨ë³„í™” ê¸°ëŠ¥)
                </h4>
                <p class="text-sm text-amber-800 font-medium mb-2">
                  SpeechProì™€ FluencyPro í‰ê°€ë¥¼ AIê°€ ì¢…í•©í•˜ì—¬ ê°œì¸ë§ì¶¤í˜•
                  í”¼ë“œë°±ì„ ìƒì„±í•©ë‹ˆë‹¤!
                </p>
                <ul class="text-sm text-amber-800 space-y-1">
                  <li>
                    âœ¨ ì •í™•ë„ ë¶„ì„: ê° ìŒì†Œì˜ ë°œìŒ ì •í™•ë„ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ í‰ê°€
                  </li>
                  <li>ğŸ¯ ê°•ì  ì¸ì •: ì˜ ë°œìŒí•œ ìŒì†Œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬</li>
                  <li>ğŸ“ˆ ê°œì„  ì „ëµ: í‹€ë¦° ë°œìŒì„ êµì •í•˜ëŠ” ë‹¨ê³„ë³„ ë°©ë²• ì œì‹œ</li>
                  <li>ğŸ’ª ê²©ë ¤ì™€ ë°©í–¥ì œì‹œ: AIì˜ ë§ì¶¤í˜• ì‘ì›ê³¼ ë‹¤ìŒ í•™ìŠµ ëª©í‘œ</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div
              class="bg-white p-4 rounded-lg shadow-sm border border-gray-100"
            >
              <div class="flex items-start gap-2">
                <span class="text-2xl">âœ“</span>
                <div>
                  <h4 class="font-semibold text-gray-800">ê°œë³„ ìŒì†Œ ë¶„ì„</h4>
                  <p class="text-sm text-gray-600">
                    ê° ìŒì†Œë³„ ì •í™•ì„±ì„ ìƒì„¸íˆ ë¶„ì„í•˜ì—¬ ì–´ë–¤ ë°œìŒì´ í‹€ë ¸ëŠ”ì§€
                    ì •í™•íˆ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white p-4 rounded-lg shadow-sm border border-gray-100"
            >
              <div class="flex items-start gap-2">
                <span class="text-2xl">âœ“</span>
                <div>
                  <h4 class="font-semibold text-gray-800">AI ê¸°ë°˜ í”¼ë“œë°±</h4>
                  <p class="text-sm text-gray-600">
                    AIê°€ ë°œìŒì˜ íŠ¹ì • ë¬¸ì œì ì„ ë¶„ì„í•˜ê³  ê°œì„  ë°©ë²•ì„ ì œì‹œí•´ì¤ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white p-4 rounded-lg shadow-sm border border-gray-100"
            >
              <div class="flex items-start gap-2">
                <span class="text-2xl">âœ“</span>
                <div>
                  <h4 class="font-semibold text-gray-800">ìŒí–¥ íŠ¹ì„± ë¶„ì„</h4>
                  <p class="text-sm text-gray-600">
                    ê¸°ë³¸ì£¼íŒŒìˆ˜(F0)ì™€ ì—ë„ˆì§€ ê°™ì€ ìŒí–¥ íŠ¹ì„±ì„ ë¶„ì„í•˜ì—¬ ìŒì§ˆì„
                    í‰ê°€í•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white p-4 rounded-lg shadow-sm border border-gray-100"
            >
              <div class="flex items-start gap-2">
                <span class="text-2xl">âœ“</span>
                <div>
                  <h4 class="font-semibold text-gray-800">
                    ë°œìŒ ëª¨ë¸ ê¸°ë°˜ í‰ê°€
                  </h4>
                  <p class="text-sm text-gray-600">
                    FST(Finite State Transducer) ë°œìŒ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ê³¼í•™ì ì¸
                    í‰ê°€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded-lg border-t-2 border-blue-200">
            <p class="text-sm text-gray-700">
              <strong>ğŸ’¡ TIP:</strong> ì •í™•í•œ ë°œìŒ ê¸°ì´ˆë¥¼ ë‹¤ì§€ë ¤ë©´ SpeechProë¡œ
              ìŒì†Œë³„ ì •í™•ë„ë¥¼ ë¨¼ì € í™•ì¸í•˜ê³ , ê·¸ í›„ FluencyProë¡œ ìì—°ìŠ¤ëŸ¬ìš´
              ë°œí™”ë¥¼ ì—°ìŠµí•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- SpeechPro ì¥ì  ëª¨ë‹¬ íŠ¸ë¦¬ê±° -->
    <div
      class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-l-4 border-blue-500 mb-8 flex items-center justify-between gap-4"
    >
      <div>
        <h3 class="text-lg font-bold text-blue-900 mb-1">
          ğŸ¤ SpeechPro ë°œìŒ ì •í™•ë„ í‰ê°€ì˜ ì¥ì 
        </h3>
        <p class="text-sm text-blue-800">
          í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ëª¨ë‹¬ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”.
        </p>
      </div>
      <button
        id="open-speechpro-advantages"
        type="button"
        class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
      >
        ì¥ì  ë³´ê¸°
      </button>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
      <!-- í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-3">
          ğŸ“š í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥
        </label>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <select
            id="evaluation-text"
            onchange="selectEvaluationSentence()"
            class="flex-1 px-4 py-3 border-2 border-[var(--accent)] rounded-lg focus:outline-none focus:border-[var(--accent)] transition"
          >
            <option value="">-- ë¬¸ì¥ ì„ íƒ --</option>
          </select>
        </div>
      </div>

      <!-- ë ˆì½”ë”© ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-4">
          ğŸ™ï¸ ìŒì„± ë…¹ìŒ
        </label>

        <div
          class="border-2 border-dashed border-[var(--accent)] rounded-lg p-8 text-center bg-gray-50"
        >
          <div id="recording-status" class="mb-4">
            <p class="text-gray-600 text-sm">ë§ˆì´í¬ë¥¼ í†µí•´ ë¬¸ì¥ì„ ì½ì–´ì£¼ì„¸ìš”</p>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 justify-center mb-4">
            <button
              id="start-recording"
              onclick="startRecording()"
              class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition flex-1 sm:flex-none"
            >
              ğŸ™ï¸ ë…¹ìŒ ì‹œì‘
            </button>
            <button
              id="stop-recording"
              onclick="stopRecording()"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition flex-1 sm:flex-none hidden"
            >
              â¹ï¸ ë…¹ìŒ ì¤‘ì§€
            </button>
            <button
              id="play-recording"
              onclick="playRecording()"
              class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition flex-1 sm:flex-none disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              â–¶ï¸ ì¬ìƒ
            </button>
            <button
              id="clear-recording"
              onclick="clearRecording()"
              class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition flex-1 sm:flex-none"
            >
              ğŸ—‘ï¸ ì´ˆê¸°í™”
            </button>
          </div>

          <!-- ë…¹ìŒ ì‹œê°„ í‘œì‹œ (ìˆ¨ê¹€) -->
          <div
            id="recording-timer"
            class="text-2xl font-mono text-[var(--accent)] mb-4 hidden"
          >
            00:00
          </div>

          <!-- ì¬ìƒ ì„¹ì…˜ -->
          <div id="playback-section" class="mt-6 hidden">
            <p class="text-sm text-gray-600 mb-3">ë…¹ìŒëœ ìŒì„±:</p>
            <audio
              id="audio-playback"
              controls
              class="w-full mb-3 rounded-lg"
            ></audio>
          </div>
        </div>
      </div>

      <!-- í‰ê°€ ë²„íŠ¼ -->
      <div class="flex flex-col sm:flex-row gap-4 mb-8">
        <button
          id="evaluate-button"
          onclick="evaluatePronunciation()"
          class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ğŸ¤ ë°œìŒ ì •í™•ë„ í‰ê°€í•˜ê¸°
        </button>
      </div>
    </div>

    <!-- ê²°ê³¼ ëª¨ë‹¬ -->
    <div
      id="results-modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
    >
      <div
        class="relative w-full max-w-3xl max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-2xl p-8"
      >
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl"
          onclick="closeResults()"
          aria-label="ë‹«ê¸°"
        >
          âœ•
        </button>

        <h2 class="text-2xl font-bold text-[var(--text-main)] mb-6">
          ğŸ“Š í‰ê°€ ê²°ê³¼
        </h2>

        <!-- ì ìˆ˜ ì¹´ë“œ -->
        <div id="score-card" class="bg-white rounded-2xl shadow p-6 mb-6">
          <!-- ì „ì²´ ì ìˆ˜ -->
          <div class="mb-6">
            <div class="text-center">
              <div class="text-6xl font-bold text-[var(--accent)] mb-2">
                <span id="overall-score">0</span>/100
              </div>
              <p
                id="score-feedback"
                class="text-lg text-[var(--text-sub)] font-semibold"
              ></p>
            </div>

            <!-- ì ìˆ˜ ê²Œì´ì§€ -->
            <div class="mt-6">
              <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div
                  id="score-bar"
                  class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>

          <!-- AI ì¢…í•© í”¼ë“œë°± ì„¹ì…˜ (ì ìˆ˜ ì§í›„) -->
          <div class="border-t pt-6 mt-6">
            <div
              class="relative overflow-hidden bg-gradient-to-br from-blue-50 via-indigo-50 to-slate-50 border border-blue-100 rounded-2xl p-8 shadow-lg"
            >
              <div
                class="absolute -right-10 -top-10 w-48 h-48 bg-blue-200/30 rounded-full blur-3xl"
              ></div>
              <div
                class="absolute -left-8 -bottom-12 w-52 h-52 bg-indigo-200/30 rounded-full blur-3xl"
              ></div>

              <div class="flex items-center justify-between mb-4 relative">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">ğŸ¤–</span>
                  <div>
                    <p
                      class="text-xs font-semibold text-blue-600 uppercase tracking-wide"
                    >
                      AI Insight
                    </p>
                    <h3 class="text-xl font-extrabold text-blue-900">
                      AI ì¢…í•© í”¼ë“œë°±
                    </h3>
                  </div>
                </div>
                <div
                  class="flex items-center gap-2 text-xs font-semibold text-blue-800"
                >
                  <span
                    class="px-3 py-1 rounded-full bg-white border border-blue-100 shadow-sm"
                  >
                    ğŸ” ê°œì„  í¬ì¸íŠ¸ ìŠ¤ìº” ì™„ë£Œ
                  </span>
                </div>
              </div>

              <div
                id="feedback-content"
                class="relative text-blue-900 leading-loose text-base bg-white/70 border border-blue-100 rounded-xl p-6 shadow-inner"
                style="line-height: 1.8"
              >
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>

              <div
                class="mt-4 flex flex-wrap gap-2 text-xs font-medium text-blue-700"
              >
                <span
                  class="px-3 py-1 rounded-full bg-blue-100 border border-blue-200"
                  >ë°œìŒ ì •í™•ë„</span
                >
                <span
                  class="px-3 py-1 rounded-full bg-indigo-100 border border-indigo-200"
                  >ë¦¬ë“¬ Â· ì–µì–‘</span
                >
                <span
                  class="px-3 py-1 rounded-full bg-sky-100 border border-sky-200"
                  >ê°œì„  ë°©í–¥</span
                >
              </div>
            </div>
          </div>

          <!-- ìƒì„¸ ì •ë³´ -->
          <div id="details-section" class="border-t pt-6 mt-6">
            <h3 class="text-lg font-semibold text-[var(--text-main)] mb-4">
              ìƒì„¸ ë¶„ì„
            </h3>
            <div id="details-content" class="space-y-3 text-[var(--text-sub)]">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <!-- SpeechPro ë¶„ì„ -->
          <div class="border-t pt-6 mt-6">
            <h3
              class="text-lg font-semibold text-orange-900 mb-4 flex items-center gap-2"
            >
              <span class="text-2xl">ğŸ¯</span> SpeechPro ì •í™•ë„ ë¶„ì„
            </h3>
            <div
              id="speechpro-content"
              class="bg-orange-50 border-l-4 border-orange-400 rounded-lg p-4 space-y-2 text-orange-800"
            >
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <!-- FluencyPro ë¶„ì„ -->
          <div class="border-t pt-6 mt-6">
            <h3
              class="text-lg font-semibold text-purple-900 mb-4 flex items-center gap-2"
            >
              <span class="text-2xl">ğŸŒŠ</span> FluencyPro ìœ ì°½ì„± ë¶„ì„
            </h3>
            <div
              id="fluencypro-content"
              class="bg-purple-50 border-l-4 border-purple-400 rounded-lg p-4 space-y-2 text-purple-800"
            >
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <button
            onclick="closeResults()"
            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
          >
            ë‹«ê¸°
          </button>
          <button
            onclick="resetEvaluation()"
            class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:opacity-90 transition"
          >
            ğŸ”„ ë‹¤ì‹œ í‰ê°€í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div
      id="error-section"
      class="hidden bg-red-50 border-l-4 border-red-500 rounded-lg p-6"
    >
      <h3 class="text-lg font-semibold text-red-900 mb-2">âŒ ì˜¤ë¥˜</h3>
      <p id="error-message" class="text-red-800"></p>
    </div>

    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="loading-section" class="hidden text-center py-12">
      <div class="inline-block">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-[var(--accent)] border-t-transparent mb-4"
        ></div>
        <p class="text-[var(--text-sub)] font-semibold">í‰ê°€ ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Lightweight Markdown + sanitizer ë¡œë”
  (function loadMarkdownLibs() {
    const libs = [
      "https://cdn.jsdelivr.net/npm/marked/marked.min.js",
      "https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js",
    ];
    libs.forEach((src) => {
      const s = document.createElement("script");
      s.src = src;
      s.defer = true; // ë Œë” ìˆœì„œ ë³´ì¥ì— ë„ì›€
      document.head.appendChild(s);
    });
  })();

  // Markdown ì•ˆì „ ë Œë”ëŸ¬ (ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ í›„ sanitize)
  function renderMarkdownSafe(targetEl, text) {
    if (!targetEl) return;
    const safeText = typeof text === "string" ? text : "";

    // 1) marked + DOMPurifyê°€ ì¤€ë¹„ëœ ê²½ìš°
    if (window.marked && window.DOMPurify) {
      try {
        let html = DOMPurify.sanitize(marked.parse(safeText));
        // li í•­ëª©ë“¤ ì‚¬ì´ì— margin ì¶”ê°€
        html = html.replace(/<li>/g, '<li style="margin-bottom: 0.75rem;">');
        // ë‹¨ë½ ì‚¬ì´ì— ë” í° ì—¬ë°± ì¶”ê°€
        html = html.replace(/<p>/g, '<p style="margin-bottom: 0.75rem;">');
        targetEl.innerHTML = html;
        return;
      } catch (e) {
        // fall through
      }
    }

    // 2) ìµœì†Œ í´ë°± ë Œë”ë§ (ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ë§Œ)
    const escapeHtml = (s) =>
      s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    let html = escapeHtml(safeText);

    // **bold** -> <strong>
    html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    // *italic* or _italic_ -> <em>
    html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
    html = html.replace(/_(.+?)_/g, "<em>$1</em>");
    // ì¤„ë°”ê¿ˆ -> <br> (ê·¸ ì‚¬ì´ì— ì—¬ë°± ì¶”ê°€)
    html = html
      .split("\n")
      .map((line) => {
        if (line.trim()) {
          return `<div style="margin-bottom: 0.75rem;">${line}</div>`;
        }
        return "";
      })
      .join("");

    targetEl.innerHTML = html;
  }

  // AI í”¼ë“œë°±ì„ ê¾¸ë©°ì£¼ëŠ” í—¬í¼ (ëª¨ë“  ì¤„ì— ì´ëª¨ì§€ ë³´ì¥)
  function formatAiFeedback(raw, score) {
    const txt = (raw || "").trim();
    if (!txt) return "";

    const emojis = ["âœ…", "ğŸ’¡", "ğŸ¯", "ğŸš€", "ğŸ”", "âœ¨", "ğŸ“Œ", "ğŸŒŸ", "ğŸª„"];
    const hasEmoji = (s) => /[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/u.test(s);
    const ensureEmojiLine = (line, idx) => {
      if (!line.trim()) return "";
      if (hasEmoji(line)) return line;
      const icon = emojis[idx % emojis.length];
      return `${icon} ${line}`;
    };

    let lines = txt
      .split(/\n+/)
      .map((l) => l.trim())
      .filter(Boolean);

    // ### ì œê±°
    lines = lines
      .map((line) => line.replace(/^#+\s*/, "").trim())
      .filter(Boolean);

    const hasMdStructure = /(^\s*[-*+]\s)|(^\s*\d+\.\s)/m.test(txt);

    if (lines.length === 1 && !hasMdStructure) {
      return ensureEmojiLine(lines[0], 0);
    }

    const header = " âœ¨ AI í”¼ë“œë°±";
    const scoreLine = typeof score === "number" ? `> ì ìˆ˜: ${score}ì ` : "";

    const normalized = lines.map((line, idx) => {
      const listMatch = line.match(/^[-*+]\s+(.*)$/);
      const orderedMatch = line.match(/^\d+\.\s+(.*)$/);
      const content = listMatch
        ? listMatch[1]
        : orderedMatch
        ? orderedMatch[1]
        : line;
      const withEmoji = ensureEmojiLine(content, idx);
      return `- ${withEmoji}`;
    });

    return [header, scoreLine, "", ...normalized].filter(Boolean).join("\n");
  }

  // ì „ì—­ ë³€ìˆ˜
  let mediaRecorder = null;
  let recordedChunks = [];
  let recordingStartTime = null;
  let recordingTimer = null;
  let selectedSentence = null;

  // ë…¹ìŒ ì‹œì‘
  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      recordingStartTime = Date.now();

      mediaRecorder.ondataavailable = (event) => {
        recordedChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(recordedChunks, { type: "audio/wav" });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById("audio-playback").src = audioUrl;
        document.getElementById("playback-section").classList.remove("hidden");
        document.getElementById("evaluate-button").disabled = false;
      };

      mediaRecorder.start();

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("start-recording").classList.add("hidden");
      document.getElementById("stop-recording").classList.remove("hidden");
      document.getElementById("clear-recording").classList.remove("hidden");
      document.getElementById("recording-status").innerHTML =
        'ğŸ”´ <p class="text-red-600 font-semibold">ë…¹ìŒ ì¤‘...</p>';
      document.getElementById("recording-timer").classList.remove("hidden");

      // íƒ€ì´ë¨¸ ì‹œì‘
      startTimer();

      showMessage("ë…¹ìŒì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤", "info");
    } catch (error) {
      showError(`ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`);
    }
  }

  // ë…¹ìŒ ì¤‘ì§€
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach((track) => track.stop());

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("start-recording").classList.remove("hidden");
      document.getElementById("stop-recording").classList.add("hidden");
      document.getElementById("play-recording").disabled = false;
      document.getElementById("recording-status").innerHTML =
        '<p class="text-green-600 font-semibold">âœ… ë…¹ìŒ ì™„ë£Œ</p>';
      document.getElementById("recording-timer").classList.add("hidden");

      // íƒ€ì´ë¨¸ ì¤‘ì§€
      stopTimer();

      showMessage("ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤", "success");
    }
  }

  // ë…¹ìŒ ì´ˆê¸°í™”
  function clearRecording() {
    mediaRecorder = null;
    recordedChunks = [];
    recordingStartTime = null;

    document.getElementById("audio-playback").src = "";
    document.getElementById("playback-section").classList.add("hidden");
    document.getElementById("recording-status").innerHTML =
      '<p class="text-gray-600 text-sm">ë§ˆì´í¬ë¥¼ í†µí•´ ë¬¸ì¥ì„ ì½ì–´ì£¼ì„¸ìš”</p>';
    document.getElementById("recording-timer").classList.add("hidden");
    document.getElementById("start-recording").classList.remove("hidden");
    document.getElementById("stop-recording").classList.add("hidden");
    document.getElementById("play-recording").disabled = true;
    document.getElementById("clear-recording").classList.add("hidden");
    document.getElementById("evaluate-button").disabled = true;

    hideError();
  }

  // ë…¹ìŒëœ ìŒì„± ì¬ìƒ
  function playRecording() {
    const audioPlayback = document.getElementById("audio-playback");
    if (audioPlayback.src) {
      audioPlayback.play();
    }
  }

  // íƒ€ì´ë¨¸ ê´€ë ¨
  function startTimer() {
    recordingTimer = setInterval(() => {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById("recording-timer").textContent = `${String(
        minutes
      ).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }, 100);
  }

  function stopTimer() {
    if (recordingTimer) {
      clearInterval(recordingTimer);
    }
  }

  // ë°œìŒ í‰ê°€ ì‹¤í–‰
  async function evaluatePronunciation() {
    const selectEl = document.getElementById("evaluation-text");
    let text = "";

    // ì„ íƒëœ ë¬¸ì¥ì´ ìˆìœ¼ë©´ JSON íŒŒì‹±, ì—†ìœ¼ë©´ ì§ì ‘ ì…ë ¥í•œ í…ìŠ¤íŠ¸
    if (selectEl.value && selectEl.tagName === "SELECT") {
      try {
        const sentence = JSON.parse(selectEl.value);
        text = sentence.sentenceKr;
      } catch {
        text = selectEl.value.trim();
      }
    } else {
      text = selectEl.value.trim();
    }

    const audioElement = document.getElementById("audio-playback");

    if (!text) {
      showError("í‰ê°€í•  ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”");
      return;
    }

    if (!audioElement.src) {
      alert("ìŒì„±ì„ ë…¹ìŒí•´ì£¼ì„¸ìš”.");
      return;
    }

    // ë¡œë”© í‘œì‹œ
    showLoading();
    hideError();

    const controller = new AbortController();
    const timeoutMs = 25000;
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
      // ì˜¤ë””ì˜¤ ë°ì´í„° ìˆ˜ì§‘
      const audio = new Audio(audioElement.src);
      const audioBlob = await fetch(audioElement.src).then((r) => r.blob());

      // FormData ìƒì„±
      const formData = new FormData();
      formData.append("text", text);
      formData.append("audio", audioBlob, "recording.wav");

      // í”„ë¦¬ì…‹ ë¬¸ì¥ì¸ ê²½ìš° ì‚¬ì „ ê³„ì‚° ì •ë³´ ì „ì†¡
      if (
        selectedSentence &&
        selectedSentence.syll_ltrs &&
        selectedSentence.syll_phns &&
        selectedSentence.fst
      ) {
        formData.append("syll_ltrs", selectedSentence.syll_ltrs);
        formData.append("syll_phns", selectedSentence.syll_phns);
        formData.append("fst", selectedSentence.fst);
      }

      // API í˜¸ì¶œ
      const response = await fetch("/api/speechpro/evaluate", {
        method: "POST",
        body: formData,
        signal: controller.signal,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || "í‰ê°€ ì‹¤íŒ¨");
      }

      const result = await response.json();

      if (result.success) {
        displayResults(result);
      } else {
        showError(result.error || "í‰ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      }
    } catch (error) {
      if (error.name === "AbortError") {
        showError("ìš”ì²­ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      } else {
        showError(`í‰ê°€ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
      }
    } finally {
      clearTimeout(timeoutId);
      hideLoading();
    }
  }

  // ê²°ê³¼ í‘œì‹œ
  function displayResults(result) {
    const score = Math.round(result.overall_score || 0);
    const details = result.details || {};

    // ë””ë²„ê¹…: ì „ì²´ ì‘ë‹µ êµ¬ì¡° í™•ì¸
    console.log("=== API Response Structure ===");
    console.log("Full result:", result);
    console.log("Details:", details);
    console.log("Score details:", result.score);
    console.log("Fluency:", details.fluency);
    console.log("Quality:", details.quality);

    // ì ìˆ˜ ì—…ë°ì´íŠ¸
    document.getElementById("overall-score").textContent = score;

    // í”¼ë“œë°± ë©”ì‹œì§€
    let feedback = "";
    if (score >= 90) feedback = "ì™„ë²½í•œ ë°œìŒì…ë‹ˆë‹¤! ğŸŒŸ";
    else if (score >= 80) feedback = "ë§¤ìš° ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤! ğŸ‘";
    else if (score >= 70)
      feedback = "ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ì—°ìŠµí•˜ë©´ ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš” ğŸ’ª";
    else if (score >= 60)
      feedback = "ë” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì†í•´ì„œ ë…¸ë ¥í•´ë³´ì„¸ìš” ğŸ“š";
    else feedback = "ë§ì€ ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. ì²œì²œíˆ ë”°ë¼í•´ë³´ì„¸ìš” ğŸ¯";

    document.getElementById("score-feedback").textContent = feedback;

    // ì ìˆ˜ ë°” ì—…ë°ì´íŠ¸
    document.getElementById("score-bar").style.width = score + "%";

    // Log pronunciation evaluation activity
    const nickname = localStorage.getItem("user_nickname");
    if (nickname && typeof logUserActivity === "function") {
      logUserActivity(nickname, "PRONUNCIATION_EVAL", "/speechpro-practice", {
        score: score,
        text: document
          .getElementById("evaluation-text")
          .value.trim()
          .substring(0, 50),
        scoreRange: score >= 80 ? "high" : score >= 60 ? "medium" : "low",
      });
    }

    // Send mail notification for high scores (80+)
    if (score >= 80 && typeof onScoreAchieved === "function") {
      onScoreAchieved(score);
    } else if (score >= 80) {
      // Fallback: directly add mail if onScoreAchieved not available
      if (typeof addMailNotification === "function") {
        addMailNotification(
          "ğŸ† ë†’ì€ ì ìˆ˜ ë‹¬ì„±!",
          `${score}ì ì„ ë‹¬ì„±í•˜ì…¨ìŠµë‹ˆë‹¤! ì •ë§ í›Œë¥­í•©ë‹ˆë‹¤! ì´ ê¸°ì„¸ë¥¼ ì´ì–´ê°€ì„¸ìš”!`,
          "ğŸŒŸ"
        );
      }
    }

    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    let detailsHtml = "";
    if (result.score && result.score.details) {
      const details = result.score.details;

      // fluency ì •ë³´
      if (details.fluency) {
        const f = details.fluency;
        detailsHtml += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">ğŸ¯ ìœ ì°½ì„± (Fluency)</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>ë°œí™” ì†ë„: <span class="font-medium">${(
                f["speech rate"] || 0
              ).toFixed(1)} ìŒì ˆ/ì´ˆ</span></div>
              <div>ì¡°ìŒ ì†ë„: <span class="font-medium">${(
                f["articulation rate"] || 0
              ).toFixed(1)} ìŒì ˆ/ì´ˆ</span></div>
              <div>ë°œí™” ê¸¸ì´: <span class="font-medium">${(
                f["articulation length"] || 0
              ).toFixed(2)}ì´ˆ</span></div>
              <div>ì´ ê¸¸ì´: <span class="font-medium">${(
                f.duration || 0
              ).toFixed(2)}ì´ˆ</span></div>
              <div>ì •í™• ìŒì ˆ: <span class="font-medium">${
                f["correct syllable count"] || 0
              }/${f["syllable count"] || 0}</span></div>
              <div>ì •í™• ë‹¨ì–´: <span class="font-medium">${
                f["correct word count"] || 0
              }/${f["word count"] || 0}</span></div>
            </div>
          </div>
        `;
      }

      // quality ì •ë³´ - ë¬¸ì¥ë³„ ì ìˆ˜
      if (details.quality && details.quality.sentences) {
        const sentences = details.quality.sentences.filter(
          (s) => s.text !== "!SIL"
        );
        if (sentences.length > 0) {
          detailsHtml += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ ë¬¸ì¥ë³„ í‰ê°€</h4>
              <div class="space-y-2">
          `;

          sentences.forEach((sent) => {
            const sentScore = Math.round(sent.score || 0);
            const barColor =
              sentScore >= 80
                ? "bg-green-500"
                : sentScore >= 60
                ? "bg-yellow-500"
                : "bg-red-500";
            detailsHtml += `
              <div class="text-sm">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-medium">${sent.text || "(ë¬¸ì¥)"}</span>
                  <span class="text-gray-600">${sentScore}ì </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="${barColor} h-2 rounded-full" style="width: ${sentScore}%"></div>
                </div>
              </div>
            `;
          });

          detailsHtml += `
              </div>
            </div>
          `;
        }
      }

      // ë‹¨ì–´ë³„ ìƒì„¸ ë¶„ì„ (ëª¨ë“  ë¬¸ì¥ì˜ ë‹¨ì–´ë“¤)
      if (details.quality && details.quality.sentences) {
        const allWords = [];
        details.quality.sentences.forEach((sent) => {
          if (sent.text !== "!SIL" && sent.words && sent.words.length > 0) {
            sent.words.forEach((word) => {
              if (word.text && word.text !== "!SIL") {
                allWords.push(word);
              }
            });
          }
        });

        if (allWords.length > 0) {
          detailsHtml += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">ğŸ” ë‹¨ì–´ë³„ ë¶„ì„</h4>
              <div class="space-y-3">
          `;

          allWords.forEach((word) => {
            const wordScore = Math.round(word.score || 0);
            const scoreColor =
              wordScore >= 90
                ? "text-green-600"
                : wordScore >= 70
                ? "text-yellow-600"
                : "text-red-600";
            const barColor =
              wordScore >= 90
                ? "bg-green-500"
                : wordScore >= 70
                ? "bg-yellow-500"
                : "bg-red-500";

            detailsHtml += `
              <div class="border-l-4 ${barColor.replace(
                "bg-",
                "border-"
              )} pl-3 py-2 bg-gray-50 rounded">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-bold text-lg">${word.text || ""}</span>
                  <span class="${scoreColor} font-semibold">${wordScore}ì </span>
                </div>
            `;

            // ìŒì ˆë³„ ë¶„ì„
            if (word.syll && word.syll.length > 0) {
              detailsHtml += `<div class="ml-2 space-y-2 text-sm">`;

              word.syll.forEach((syll) => {
                const syllScore = Math.round(syll.score || 0);
                const syllColor =
                  syllScore >= 90
                    ? "text-green-600"
                    : syllScore >= 70
                    ? "text-yellow-600"
                    : "text-red-600";

                detailsHtml += `
                  <div class="bg-white rounded p-2">
                    <div class="flex justify-between items-center mb-1">
                      <span class="font-semibold text-gray-700">ìŒì ˆ: <span class="text-gray-900">${
                        syll.text || ""
                      }</span></span>
                      <span class="${syllColor}">${syllScore}ì </span>
                    </div>
                `;

                // ìŒì†Œë³„ ë¶„ì„
                if (syll.phones && syll.phones.length > 0) {
                  detailsHtml += `<div class="ml-3 mt-1 space-y-1 text-xs">`;

                  syll.phones.forEach((phone) => {
                    const phoneScore = Math.round(phone.score || 0);
                    const phoneColor =
                      phoneScore >= 90
                        ? "text-green-600"
                        : phoneScore >= 70
                        ? "text-yellow-600"
                        : "text-red-600";

                    detailsHtml += `
                      <div class="flex items-center justify-between border-l-2 border-gray-300 pl-2 py-1">
                        <div class="flex items-center gap-2">
                          <span class="font-mono font-bold">${
                            phone.symbol || ""
                          }</span>
                          <span class="text-gray-500">(${
                            phone.text || ""
                          })</span>
                        </div>
                        <span class="${phoneColor} font-semibold">${phoneScore}ì </span>
                      </div>
                    `;
                  });

                  detailsHtml += `</div>`;
                }

                detailsHtml += `</div>`;
              });

              detailsHtml += `</div>`;
            }

            detailsHtml += `</div>`;
          });

          detailsHtml += `
              </div>
            </div>
          `;
        }
      }
    }

    if (!detailsHtml) {
      detailsHtml = "<div>ë°œìŒ í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>";
    }

    document.getElementById("details-content").innerHTML = detailsHtml;

    // SpeechPro ë¶„ì„ í‘œì‹œ
    let speechproHtml = "";
    const quality = details.quality || {};

    // SpeechPro ë°ì´í„° ì¶”ì¶œ (ì—¬ëŸ¬ í˜•ì‹ ì§€ì›)
    let speechproData = null;
    if (result.score && result.score.details && result.score.details.quality) {
      speechproData = result.score.details.quality;
    } else if (result.speechpro) {
      speechproData = result.speechpro;
    } else if (details.quality) {
      speechproData = details.quality;
    }

    console.log("SpeechPro Data:", speechproData);

    if (speechproData) {
      speechproHtml += `<div class="text-sm space-y-2">`;

      // ì—¬ëŸ¬ ê°€ëŠ¥í•œ í‚¤ ì¡°í•© ì‹œë„
      const accuracyKeys = [
        "accuracy_percentage",
        "overall_accuracy",
        "accuracy",
        "accuracy %",
        "accuracy%",
      ];
      const completenessKeys = [
        "completeness_percentage",
        "completeness",
        "completion",
        "completeness %",
        "completeness%",
      ];

      let accuracy = null;
      for (const key of accuracyKeys) {
        if (speechproData[key] !== undefined && speechproData[key] !== null) {
          accuracy = speechproData[key];
          console.log("Found accuracy with key:", key, "value:", accuracy);
          break;
        }
      }

      let completeness = null;
      for (const key of completenessKeys) {
        if (speechproData[key] !== undefined && speechproData[key] !== null) {
          completeness = speechproData[key];
          console.log(
            "Found completeness with key:",
            key,
            "value:",
            completeness
          );
          break;
        }
      }

      // ëª¨ë“  ê°ì²´ í‚¤ë¥¼ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
      console.log("All SpeechPro keys:", Object.keys(speechproData));
      for (const [key, value] of Object.entries(speechproData)) {
        if (typeof value === "number") {
          console.log(`  ${key}: ${value}`);
        }
      }

      // sentences ë°°ì—´ì—ì„œ ì •ë³´ ì¶”ì¶œ
      if (
        !accuracy &&
        speechproData.sentences &&
        speechproData.sentences.length > 0
      ) {
        const firstSentence = speechproData.sentences[0];
        if (firstSentence.score !== undefined) {
          accuracy = firstSentence.score;
          console.log("Found accuracy from sentences:", accuracy);
        }
      }

      if (accuracy !== null && accuracy !== undefined) {
        speechproHtml += `<div>âœ“ ì •í™•ë„: <strong>${
          typeof accuracy === "number" ? accuracy.toFixed(1) : accuracy
        }%</strong></div>`;
      }
      if (completeness !== null && completeness !== undefined) {
        speechproHtml += `<div>âœ“ ì™„ì„±ë„: <strong>${
          typeof completeness === "number"
            ? completeness.toFixed(1)
            : completeness
        }%</strong></div>`;
      }

      // ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê²½ê³ 
      if (
        (accuracy === null || accuracy === undefined) &&
        (completeness === null || completeness === undefined)
      ) {
        speechproHtml += `<div class="text-gray-600">ìƒì„¸ ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>`;
      }

      speechproHtml += `</div>`;
    } else {
      speechproHtml =
        "<div class='text-sm text-gray-600'>SpeechPro ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>";
    }
    document.getElementById("speechpro-content").innerHTML = speechproHtml;

    // FluencyPro ë¶„ì„ í‘œì‹œ
    let fluencyHtml = "";
    const fluency = details.fluency || {};

    // FluencyPro ë°ì´í„° ì¶”ì¶œ (ì—¬ëŸ¬ í˜•ì‹ ì§€ì›)
    let fluencyData = fluency;
    if (result.fluency && result.fluency.details) {
      fluencyData = result.fluency.details;
    } else if (
      result.score &&
      result.score.details &&
      result.score.details.fluency
    ) {
      fluencyData = result.score.details.fluency;
    }

    console.log("FluencyPro Data:", fluencyData);
    console.log("All FluencyPro keys:", Object.keys(fluencyData));

    if (Object.keys(fluencyData).length > 0) {
      fluencyHtml += `<div class="text-sm space-y-2">`;

      // ì—¬ëŸ¬ ê°€ëŠ¥í•œ í‚¤ ì¡°í•© ì‹œë„
      const speechRateKeys = [
        "speech rate",
        "speech_rate",
        "speechRate",
        "rate",
      ];
      const correctSyllKeys = [
        "correct syllable count",
        "correct_syllables",
        "correctSyllables",
        "correct_syll",
      ];
      const totalSyllKeys = [
        "syllable count",
        "syllables",
        "totalSyllables",
        "total_syll",
      ];

      let speechRate = null;
      for (const key of speechRateKeys) {
        if (fluencyData[key] !== undefined) {
          speechRate = fluencyData[key];
          break;
        }
      }

      let correctSyll = null;
      for (const key of correctSyllKeys) {
        if (fluencyData[key] !== undefined) {
          correctSyll = fluencyData[key];
          break;
        }
      }

      let totalSyll = null;
      for (const key of totalSyllKeys) {
        if (fluencyData[key] !== undefined) {
          totalSyll = fluencyData[key];
          break;
        }
      }

      if (speechRate !== null && speechRate > 0) {
        fluencyHtml += `<div>ğŸ¯ ë°œí™” ì†ë„: <strong>${
          typeof speechRate === "number" ? speechRate.toFixed(1) : speechRate
        }</strong> ìŒì ˆ/ì´ˆ</div>`;
      }

      if (correctSyll !== null && totalSyll !== null) {
        const syllAcc = ((correctSyll / (totalSyll || 1)) * 100).toFixed(1);
        fluencyHtml += `<div>âœ“ ìŒì ˆ ì •í™•ë„: <strong>${correctSyll}/${totalSyll}</strong> (${syllAcc}%)</div>`;
      }

      // ë¦¬ë“¬, ì–µì–‘ ë“± ì¶”ê°€ ì§€í‘œ
      const rhythmKeys = ["rhythm", "rhythm_score", "rhythmScore"];
      const intonationKeys = [
        "intonation",
        "intonation_score",
        "intonationScore",
      ];

      for (const key of rhythmKeys) {
        if (fluencyData[key] !== undefined && fluencyData[key] !== null) {
          fluencyHtml += `<div>ğŸµ ë¦¬ë“¬: <strong>${
            typeof fluencyData[key] === "number"
              ? fluencyData[key].toFixed(1)
              : fluencyData[key]
          }%</strong></div>`;
          break;
        }
      }

      for (const key of intonationKeys) {
        if (fluencyData[key] !== undefined && fluencyData[key] !== null) {
          fluencyHtml += `<div>ğŸ“Š ì–µì–‘: <strong>${
            typeof fluencyData[key] === "number"
              ? fluencyData[key].toFixed(1)
              : fluencyData[key]
          }%</strong></div>`;
          break;
        }
      }

      // ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê²½ê³ 
      if (speechRate === null && correctSyll === null && totalSyll === null) {
        fluencyHtml += `<div class="text-gray-600">ìƒì„¸ ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>`;
      }

      fluencyHtml += `</div>`;
    } else {
      fluencyHtml =
        "<div class='text-sm text-gray-600'>FluencyPro ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>";
    }
    document.getElementById("fluencypro-content").innerHTML = fluencyHtml;

    // AI í”¼ë“œë°± í‘œì‹œ
    const feedbackContent = document.getElementById("feedback-content");

    // AI ì¢…í•© í”¼ë“œë°±: ë‹¤ì–‘í•œ í•„ë“œëª… ëŒ€ì‘ + ì ìˆ˜ ê¸°ë°˜ ê¸°ë³¸ ì½”ë©˜íŠ¸
    const rawAiFeedback =
      (result &&
        (result.ai_feedback || result.feedback || result.feedback_text)) ||
      "";

    let aiFeedbackText = "";
    if (typeof rawAiFeedback === "string" && rawAiFeedback.trim()) {
      aiFeedbackText = rawAiFeedback.trim();
    } else {
      if (score >= 90) {
        aiFeedbackText =
          "ğŸŒŸ ì™„ë²½ì— ê°€ê¹ìŠµë‹ˆë‹¤! ë¦¬ë“¬ê³¼ ì–µì–‘ì„ ìœ ì§€í•œ ì±„ ë” ê¸´ ë¬¸ì¥ì—ë„ ë„ì „í•´ ë³´ì„¸ìš”.";
      } else if (score >= 80) {
        aiFeedbackText =
          "âœ… ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤. ë¯¸ë¬˜í•œ ì–µì–‘Â·ê°•ì„¸ë¥¼ í•œ ë²ˆì”© ì ê²€í•˜ë©´ ë” ìì—°ìŠ¤ëŸ¬ì›Œì§‘ë‹ˆë‹¤.";
      } else if (score >= 70) {
        aiFeedbackText =
          "ğŸ’¡ ì¢‹ì€ í¸ì´ì—ìš”. ì–´ë ¤ìš´ ììŒÂ·ëª¨ìŒ ì¡°í•©ì„ ëŠë¦¬ê²Œ ë°˜ë³µí•˜ë©° ì •í™•ë„ë¥¼ ë¨¼ì € ëŒì–´ì˜¬ë ¤ ë³´ì„¸ìš”.";
      } else if (score >= 60) {
        aiFeedbackText =
          "ğŸ¯ ê¸°ë³¸ì€ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. ë¬¸ì¥ì„ ì§§ê²Œ ëŠì–´ ì½ìœ¼ë©° ë°œí™” ì†ë„ë¥¼ ë‚®ì¶”ê³  ì •í™•ë„ì— ì§‘ì¤‘í•´ ë³´ì„¸ìš”.";
      } else {
        aiFeedbackText =
          "ğŸš€ ì¡°ê¸ˆ ë” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. ì§§ì€ ë¬¸ì¥ì„ ë°˜ë³µ ë…¹ìŒí•˜ë©´ì„œ ë¦¬ë“¬ê³¼ ê°•ì„¸ë¥¼ ìµíˆë©´ ë¹ ë¥´ê²Œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.";
      }
    }

    if (feedbackContent) {
      const decorated = formatAiFeedback(aiFeedbackText, score);
      // ë§ˆì§€ë§‰ ì•ˆì „ë§: ì´ëª¨ì§€ê°€ ì „í˜€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê°•ì¡° ì´ëª¨ì§€ ì¶”ê°€
      const finalText = decorated || aiFeedbackText;
      const hasEmoji = /[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/u.test(
        finalText
      );
      renderMarkdownSafe(
        feedbackContent,
        hasEmoji ? finalText : `âœ¨ ${finalText}`
      );
    }

    // í•™ìŠµ ì§„ë„ ê¸°ë¡ ë° Pop-Up í‘œì‹œ
    recordLearningProgress(score);

    // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
    document.getElementById("results-modal").classList.remove("hidden");
  }

  // í‰ê°€ ì´ˆê¸°í™”
  function resetEvaluation() {
    closeResults();
    document.getElementById("evaluation-text").value = "ì•ˆë…•í•˜ì„¸ìš”";
    document.getElementById("sentence-select").value = "";
    selectedSentence = null;
    document.getElementById("sentence-info-section").classList.add("hidden");
    document.getElementById("sentence-level").textContent = "";
    document.getElementById("sentence-difficulty").textContent = "";
    document.getElementById("sentence-category").textContent = "";
    document.getElementById("sentence-en").textContent = "";
    document.getElementById("sentence-tips").textContent = "";
    clearRecording();
  }

  function closeResults() {
    document.getElementById("results-modal").classList.add("hidden");
  }

  // ë©”ì‹œì§€ í‘œì‹œ
  function showMessage(message, type = "info") {
    // ê°„ë‹¨í•œ ë©”ì‹œì§€ í‘œì‹œ (í† ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥)
    console.log(`[${type.toUpperCase()}] ${message}`);
  }

  // ì—ëŸ¬ í‘œì‹œ
  function showError(message) {
    document.getElementById("error-section").classList.remove("hidden");
    document.getElementById("error-message").textContent = message;
  }

  function hideError() {
    document.getElementById("error-section").classList.add("hidden");
  }

  // ë¡œë”© í‘œì‹œ
  function showLoading() {
    document.getElementById("loading-section").classList.remove("hidden");
  }

  function hideLoading() {
    document.getElementById("loading-section").classList.add("hidden");
  }

  // ë¬¸ì¥ ë°ì´í„° ë¡œë“œ
  async function loadSentences() {
    try {
      showLoading();
      const response = await fetch("/api/speechpro/sentences");

      if (!response.ok) {
        throw new Error("ë¬¸ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      }

      const sentences = await response.json();
      const select = document.getElementById("evaluation-text");

      // ì˜µì…˜ ì´ˆê¸°í™”
      select.innerHTML = '<option value="">-- ë¬¸ì¥ ì„ íƒ --</option>';

      // í”„ë¦¬ì…‹ ë¬¸ì¥ ì¹´ìš´íŠ¸
      let presetCount = 0;

      // ë¬¸ì¥ ì˜µì…˜ ì¶”ê°€
      sentences.forEach((sentence) => {
        const option = document.createElement("option");
        option.value = JSON.stringify(sentence);
        let sourceLabel = "";

        if (sentence.source === "precomputed") {
          presetCount++;
          sourceLabel = `#${presetCount} `;
        }

        option.textContent = `${sourceLabel}[${sentence.level}] ${sentence.sentenceKr}`;
        select.appendChild(option);
      });

      hideError();
    } catch (error) {
      showError(`ë¬¸ì¥ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      hideLoading();
    }
  }

  // í‰ê°€í•  ë¬¸ì¥ ì„ íƒ
  function selectEvaluationSentence() {
    const select = document.getElementById("evaluation-text");

    if (!select.value) {
      // ì„ íƒ í•´ì œ
      selectedSentence = null;
      return;
    }

    try {
      const sentence = JSON.parse(select.value);
      selectedSentence = sentence;
      hideError();
    } catch (error) {
      showError("ë¬¸ì¥ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
    }
  }

  // í•™ìŠµ ì§„ë„ ê¸°ë¡ ë° ìºë¦­í„° Pop-Up í‘œì‹œ
  async function recordLearningProgress(score) {
    try {
      const nickname = localStorage.getItem("user_nickname");
      console.log("Recording progress for user:", nickname, "score:", score);

      if (!nickname) {
        console.warn("No user nickname found in localStorage");
        return;
      }

      // 1. í•™ìŠµ ì§„ë„ ê¸°ë¡
      console.log("Calling pronunciation-completed API...");
      const progressResponse = await fetch(
        "/api/learning/pronunciation-completed",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: nickname,
            score: score,
            timestamp: new Date().toISOString(),
          }),
        }
      );

      console.log("Progress response status:", progressResponse.status);

      if (!progressResponse.ok) {
        const errorText = await progressResponse.text();
        console.error("Failed to record learning progress:", errorText);
        return;
      }

      const progressData = await progressResponse.json();
      console.log("Progress data saved:", progressData);

      // 2. Pop-Up í‘œì‹œ ì—¬ë¶€ í™•ì¸
      console.log("Checking popup trigger...");
      const popupCheckResponse = await fetch(
        `/api/learning/check-popup/${nickname}`,
        { method: "POST" }
      );

      console.log("Popup check response status:", popupCheckResponse.status);

      if (!popupCheckResponse.ok) {
        const errorText = await popupCheckResponse.text();
        console.error("Failed to check popup:", errorText);
        return;
      }

      const popupData = await popupCheckResponse.json();
      console.log("Popup data:", popupData);

      if (popupData.should_show_popup && popupData.popup_message) {
        console.log(
          "Showing popup:",
          popupData.character,
          popupData.popup_message
        );
        // Pop-Up í‘œì‹œ
        showCharacterPopup(
          popupData.character || "ì˜¤ë¹ ",
          popupData.popup_message,
          popupData.popup_type || "info"
        );

        // Pop-Up í‘œì‹œ ê¸°ë¡
        await fetch("/api/learning/popup-shown", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: nickname,
            character: popupData.character || "ì˜¤ë¹ ",
            popup_type: popupData.popup_type || "info",
          }),
        });
      }
    } catch (error) {
      console.error("Error recording learning progress:", error);
    }
  }

  // ìºë¦­í„°ë³„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì •ì˜
  const CHARACTER_STYLES = {
    ì˜¤ë¹ : {
      emoji: "ğŸ§‘",
      color: "bg-blue-100",
      sealColor: "bg-blue-500",
      borderColor: "border-blue-900",
      role: "í˜„ì¬ ìƒí™© ì•ˆë‚´",
    },
    í˜¸ë‘ì´: {
      emoji: "ğŸ¯",
      color: "bg-orange-100",
      sealColor: "bg-orange-500",
      borderColor: "border-orange-900",
      role: "ê²½ê³ ì™€ ë…ë ¤",
    },
    ë™ìƒ: {
      emoji: "ğŸ‘§",
      color: "bg-pink-100",
      sealColor: "bg-pink-500",
      borderColor: "border-pink-900",
      role: "ì¹­ì°¬",
    },
  };

  // ìºë¦­í„° Pop-Up í‘œì‹œ í•¨ìˆ˜
  function showCharacterPopup(character, message, popupType = "info") {
    const style = CHARACTER_STYLES[character] || CHARACTER_STYLES["ì˜¤ë¹ "];

    // Pop-Up ìš”ì†Œ ì—…ë°ì´íŠ¸
    const modal = document.getElementById("character-popup-modal");
    const letter = document.getElementById("popup-letter");
    const charDiv = document.getElementById("popup-character");
    const senderDiv = document.getElementById("popup-sender");
    const messageDiv = document.getElementById("popup-message");
    const sealDiv = document.getElementById("popup-seal");
    const dateDiv = document.getElementById("popup-date");

    if (modal && letter && charDiv && senderDiv && messageDiv && sealDiv) {
      // ìƒ‰ìƒ ë° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      letter.className = `bg-yellow-50 rounded-none border-8 ${style.borderColor} p-8 shadow-2xl relative`;
      sealDiv.className = `absolute -top-4 -right-4 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl font-bold ${style.sealColor} text-white`;

      // ìºë¦­í„° ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      charDiv.textContent = style.emoji;
      senderDiv.textContent = `${character}ë¡œë¶€í„°`;
      messageDiv.textContent = message;

      if (dateDiv) {
        const today = new Date().toLocaleDateString("ko-KR");
        dateDiv.textContent = today;
      }

      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.remove("hidden");
      modal.addEventListener("click", closeCharacterPopup);
    }
  }

  // Pop-Up ë‹«ê¸°
  function closeCharacterPopup(event) {
    if (event && event.target.id !== "character-popup-modal") return;
    const modal = document.getElementById("character-popup-modal");
    if (modal) {
      modal.classList.add("hidden");
    }
  }

  // ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", () => {
    // ë¬¸ì¥ ë°ì´í„° ë¡œë“œ
    loadSentences();

    // SpeechPro ì¥ì  ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const openAdvBtn = document.getElementById("open-speechpro-advantages");
    const advModal = document.getElementById("speechpro-advantages-modal");
    const advClose = document.getElementById("speechpro-advantages-close");
    const advOverlay = document.getElementById("speechpro-advantages-overlay");

    const openAdvModal = () => {
      if (advModal) advModal.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    };

    const closeAdvModal = () => {
      if (advModal) advModal.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    };

    if (openAdvBtn) openAdvBtn.addEventListener("click", openAdvModal);
    if (advClose) advClose.addEventListener("click", closeAdvModal);
    if (advOverlay)
      advOverlay.addEventListener("click", (e) => {
        if (e.target === advOverlay) closeAdvModal();
      });

    // ì²« ë°©ë¬¸ í™˜ì˜ íŒì—… (í˜ì´ì§€ë³„ë¡œ í•œ ë²ˆì”© ë…¸ì¶œ)
    try {
      const nickname = localStorage.getItem("user_nickname") || "ìƒˆ í•™ìŠµì";
      const pageFlagKey = `welcome_popup_shown_${nickname}_speechpro`;
      const alreadyShown = localStorage.getItem(pageFlagKey) === "true";
      if (!alreadyShown) {
        showCharacterPopup(
          "ì˜¤ë¹ ",
          "ì˜¤ëˆ„ì´ í•œêµ­ì–´ í•™ìŠµ í”Œë«í¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! AIì™€ í•¨ê»˜ ë°œìŒÂ·ìœ ì°½ì„± ì—°ìŠµì„ ë°”ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”.",
          "info"
        );
        localStorage.setItem(pageFlagKey, "true");
      }
    } catch (err) {
      console.warn("Failed to show welcome popup:", err);
    }

    // Pop-Up ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    const modal = document.getElementById("character-popup-modal");
    if (modal) {
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          closeCharacterPopup();
        }
      });
    }
  });
</script>

<!-- ìºë¦­í„° íŒì—… ëª¨ë‹¬ -->
<div
  id="character-popup-modal"
  class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm"
  onclick="closeCharacterPopup(event)"
>
  <div
    class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full mx-4 relative animate-bounce-in"
    id="character-modal-box"
  >
    <button
      class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl"
      onclick="closeCharacterPopup()"
    >
      Ã—
    </button>

    <div class="text-center mb-6">
      <h2 class="text-3xl font-bold text-gray-900 mb-2">
        <span class="inline-block mr-2">ğŸ’Œ</span>í¸ì§€ê°€ ë„ì°©í–ˆì–´ìš”!
      </h2>
    </div>

    <div class="flex gap-4">
      <!-- Character Avatar -->
      <div class="flex flex-col items-center flex-shrink-0">
        <div
          id="popup-character"
          class="w-24 h-24 rounded-full flex items-center justify-center text-5xl font-bold border-4 flex-shrink-0"
        >
          ğŸ§‘
        </div>
        <p id="popup-sender" class="mt-2 text-sm font-semibold text-gray-600">
          ì˜¤ë¹ 
        </p>
      </div>

      <!-- Message -->
      <div class="flex-1">
        <div class="bg-gray-50 rounded-2xl p-4 rounded-tl-none">
          <p id="popup-message" class="text-gray-800 text-base leading-relaxed">
            ë©”ì‹œì§€
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes bounce-in {
    0% {
      transform: scale(0.7);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }
  .animate-bounce-in {
    animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
</style>

{% endblock %}
