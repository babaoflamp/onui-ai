<!-- ìºë¦­í„° Pop-Up ëª¨ë‹¬ -->
<div
  id="character-popup-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
>
  <div class="relative w-full max-w-2xl">
    <!-- ì¡°ì„ ì‹œëŒ€ í¸ì§€ ìŠ¤íƒ€ì¼ ë°•ìŠ¤ -->
    <div
      id="popup-letter"
      class="bg-yellow-50 rounded-none border-8 border-yellow-900 p-8 shadow-2xl relative"
    >
      <!-- ì™ìŠ¤ ì”° (ìƒë‹¨ ìš°ì¸¡) -->
      <div
        id="popup-seal"
        class="absolute -top-4 -right-4 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl font-bold"
      ></div>

      <!-- ìºë¦­í„° ì˜ì—­ -->
      <div class="flex items-start gap-6 mb-6">
        <div id="popup-character" class="text-8xl flex-shrink-0">
          <!-- ìºë¦­í„° ì´ëª¨ì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="flex-1">
          <!-- ë°œì‹ ì ì •ë³´ -->
          <div
            id="popup-header"
            class="text-sm text-gray-700 mb-4 pb-3 border-b-2 border-yellow-900"
          >
            <div id="popup-sender" class="font-semibold">ì˜¤ë¹ ë¡œë¶€í„°</div>
            <div id="popup-date" class="text-xs text-gray-500"></div>
          </div>

          <!-- ë©”ì‹œì§€ ë³¸ë¬¸ -->
          <div
            id="popup-message"
            class="text-lg leading-loose text-gray-800 font-serif mb-6"
          >
            <!-- ë©”ì‹œì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
          </div>

          <!-- ì„œëª… -->
          <div
            id="popup-signature"
            class="text-right text-sm text-gray-700 italic"
          >
            â€” ë„ˆì˜ í•œêµ­ì–´ í•™ìŠµ ë„ìš°ë¯¸ â€”
          </div>
        </div>
      </div>

      <!-- ë²„íŠ¼ë“¤ -->
      <div
        class="flex justify-end gap-3 mt-8 pt-4 border-t-2 border-yellow-900"
      >
        <button
          onclick="dismissCharacterPopup()"
          class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition"
        >
          ë‹¤ìŒì— ë³´ê¸°
        </button>
        <button
          onclick="closeCharacterPopup()"
          class="px-6 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition font-semibold"
        >
          í™•ì¸í–ˆì–´ìš”!
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ìºë¦­í„° Pop-Up ìŠ¤íƒ€ì¼ */
  #popup-letter {
    font-family: "Georgia", "Noto Serif KR", serif;
    background: linear-gradient(135deg, #fef8f0 0%, #fef3e6 100%);
    position: relative;
  }

  #popup-seal {
    background: radial-gradient(circle at 30% 30%, #ff6b6b, #cc0000);
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2);
  }

  /* ìºë¦­í„°ë³„ ìƒ‰ìƒ */
  .popup-oppa #popup-seal {
    background: radial-gradient(circle at 30% 30%, #4a90e2, #1f4788);
  }

  .popup-tiger #popup-seal {
    background: radial-gradient(circle at 30% 30%, #ff9500, #e67e00);
  }

  .popup-sister #popup-seal {
    background: radial-gradient(circle at 30% 30%, #e84c89, #c91e63);
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes popupSlide {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  #character-popup-modal:not(.hidden) #popup-letter {
    animation: popupSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* ì¢…ì´ ì§ˆê° */
  #popup-letter::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.02) 2px,
        rgba(0, 0, 0, 0.02) 4px
      ),
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.02) 2px,
        rgba(0, 0, 0, 0.02) 4px
      );
    pointer-events: none;
  }
</style>

<script>
  // ìºë¦­í„° ì •ë³´
  const characterInfo = {
    oppa: {
      emoji: "ğŸ§‘",
      name: "ì˜¤ë¹ ",
      color: "blue",
      style: "popup-oppa",
      messages: [
        "ì•ˆë…•! ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ ê³µë¶€í•˜ê³  ìˆë„¤ìš”.",
        "ë°œìŒ ì—°ìŠµ ì¢‹ì•„ìš”! ê³„ì† í™”ì´íŒ…!",
        "ì˜¤ëŠ˜ í•™ìŠµì„ ì‹œì‘í–ˆë„¤ìš”. í™”ì´íŒ…!",
      ],
    },
    tiger: {
      emoji: "ğŸ¯",
      name: "í˜¸ë‘ì´",
      color: "orange",
      style: "popup-tiger",
      messages: [
        "ì•¼! ë„ˆëŠ” í•  ìˆ˜ ìˆì–´!",
        "ê³„ì† ì—°ìŠµí•´ë´. ë„ˆë¼ë©´ ë˜ì§€!",
        "ê²½ê³ : ì´ëŒ€ë¡œëŠ” ì§„í–‰ì´ ëŠë ¤. ì¢€ ë” ì—´ì‹¬íˆ!",
      ],
    },
    sister: {
      emoji: "ğŸ‘§",
      name: "ë™ìƒ",
      color: "pink",
      style: "popup-sister",
      messages: [
        "ì˜¤ë¹ /ì–¸ë‹ˆ, ë°œìŒì´ ì¢‹ì•„ì¡Œì–´!",
        "ëŒ€ë‹¨í•´! ì •ë§ ì˜í•˜ê³  ìˆì–´!",
        "ì¹­ì°¬í•´! ë„ˆ ì •ë§ ë©‹ìˆì–´!",
      ],
    },
  };

  function showCharacterPopup(character, message, popupType) {
    const modal = document.getElementById("character-popup-modal");
    const letter = document.getElementById("popup-letter");
    const charInfo = characterInfo[character];

    if (!charInfo) return;

    // ìŠ¤íƒ€ì¼ ì ìš©
    letter.className = charInfo.style;

    // ìºë¦­í„° ì„¤ì •
    document.getElementById("popup-character").textContent = charInfo.emoji;
    document.getElementById(
      "popup-sender"
    ).textContent = `${charInfo.name}ë¡œë¶€í„°`;
    document.getElementById("popup-message").textContent = message;

    // ë‚ ì§œ
    const today = new Date().toLocaleDateString("ko-KR");
    document.getElementById("popup-date").textContent = today;

    // ìƒ‰ìƒ í…Œë§ˆ
    const sealElement = document.getElementById("popup-seal");
    sealElement.textContent = charInfo.emoji;

    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove("hidden");

    // íŒì—… í‘œì‹œ ê¸°ë¡ (ì„œë²„ì—)
    recordPopupShown(character, popupType, message);
  }

  function closeCharacterPopup() {
    const modal = document.getElementById("character-popup-modal");
    modal.classList.add("hidden");
  }

  function dismissCharacterPopup() {
    const modal = document.getElementById("character-popup-modal");
    modal.classList.add("hidden");
    // ë‚˜ì¤‘ì— ë‹¤ì‹œ ë³´ì—¬ì£¼ë„ë¡ ì²˜ë¦¬
  }

  async function recordPopupShown(character, popupType, message) {
    try {
      await fetch("/api/learning/popup-shown", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          character,
          popup_type: popupType,
          message,
          trigger_reason: "user_activity",
        }),
      });
    } catch (error) {
      console.error("Failed to record popup:", error);
    }
  }
</script>
