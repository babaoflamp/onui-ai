<!-- ìºë¦­í„° Pop-Up ëª¨ë‹¬ -->
<div
  id="character-popup-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
>
  <div class="relative w-full max-w-2xl">
    <!-- ì¡°ì„ ì‹œëŒ€ í¸ì§€ ìŠ¤íƒ€ì¼ ë°•ìŠ¤ -->
    <div
      id="popup-letter"
      class="bg-yellow-50 rounded-none border-8 border-yellow-900 p-8 shadow-2xl relative"
    >
      <!-- ì™ìŠ¤ ì”° (ìƒë‹¨ ìš°ì¸¡) -->
      <div
        id="popup-seal"
        class="absolute -top-4 -right-4 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl font-bold"
      ></div>

      <!-- ìºë¦­í„° ì˜ì—­ -->
      <div class="flex items-start gap-6 mb-6">
        <div id="popup-character" class="text-8xl flex-shrink-0">
          <!-- ìºë¦­í„° ì´ëª¨ì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="flex-1">
          <!-- ë°œì‹ ì ì •ë³´ -->
          <div
            id="popup-header"
            class="text-sm text-gray-700 mb-4 pb-3 border-b-2 border-yellow-900"
          >
            <div id="popup-sender" class="font-semibold">ì˜¤ë¹ ë¡œë¶€í„°</div>
            <div id="popup-date" class="text-xs text-gray-500"></div>
          </div>

          <!-- ë©”ì‹œì§€ ë³¸ë¬¸ -->
          <div
            id="popup-message"
            class="text-lg leading-loose text-gray-800 font-serif mb-6"
          >
            <!-- ë©”ì‹œì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
          </div>

          <!-- ì„œëª… -->
          <div
            id="popup-signature"
            class="text-right text-sm text-gray-700 italic"
          >
            â€” ë„ˆì˜ í•œêµ­ì–´ í•™ìŠµ ë„ìš°ë¯¸ â€”
          </div>
        </div>
      </div>

      <!-- ë²„íŠ¼ë“¤ -->
      <div
        class="flex justify-end gap-3 mt-8 pt-4 border-t-2 border-yellow-900"
      >
        <button
          onclick="dismissCharacterPopup()"
          class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition"
        >
          ë‹¤ìŒì— ë³´ê¸°
        </button>
        <button
          onclick="closeCharacterPopup()"
          class="px-6 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition font-semibold"
        >
          í™•ì¸í–ˆì–´ìš”!
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ìºë¦­í„° Pop-Up ìŠ¤íƒ€ì¼ */
  #popup-letter {
    font-family: "Georgia", "Noto Serif KR", serif;
    background: linear-gradient(135deg, #fef8f0 0%, #fef3e6 100%);
    position: relative;
  }

  #popup-seal {
    background: radial-gradient(circle at 30% 30%, #ff6b6b, #cc0000);
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2);
  }

  /* ìºë¦­í„°ë³„ ìƒ‰ìƒ */
  .popup-oppa #popup-seal {
    background: radial-gradient(circle at 30% 30%, #4a90e2, #1f4788);
  }

  .popup-tiger #popup-seal {
    background: radial-gradient(circle at 30% 30%, #ff9500, #e67e00);
  }

  .popup-sister #popup-seal {
    background: radial-gradient(circle at 30% 30%, #e84c89, #c91e63);
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes popupSlide {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  #character-popup-modal:not(.hidden) #popup-letter {
    animation: popupSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* ì¢…ì´ ì§ˆê° */
  #popup-letter::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.02) 2px,
        rgba(0, 0, 0, 0.02) 4px
      ),
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.02) 2px,
        rgba(0, 0, 0, 0.02) 4px
      );
    pointer-events: none;
  }
</style>

<script>
  // ìºë¦­í„° ì •ë³´
  const characterInfo = {
    oppa: {
      emoji: "ğŸ‘¦",
      name: "ì˜¤ë¹  (ë‚¨ë™ìƒ)",
      style: "popup-oppa",
    },
    tiger: {
      emoji: "ğŸ¯",
      name: "í˜¸ë‘ì´",
      style: "popup-tiger",
    },
    sister: {
      emoji: "ğŸ‘§",
      name: "ì—¬ë™ìƒ",
      style: "popup-sister",
    },
  };

  // íŒì—… ë°ì´í„° ì €ì¥
  let currentPopupData = null;

  /**
   * ìºë¦­í„° íŒì—… í‘œì‹œ (ë°±ì—”ë“œ ë°ì´í„° ì‚¬ìš©)
   * @param {Object} popupData - ë°±ì—”ë“œì—ì„œ ë°›ì€ íŒì—… ë°ì´í„°
   */
  function showCharacterPopup(popupData) {
    if (!popupData || !popupData.should_show) return;

    currentPopupData = popupData;
    const character = popupData.character;
    const charInfo = characterInfo[character];

    if (!charInfo) {
      console.error('Unknown character:', character);
      return;
    }

    const modal = document.getElementById("character-popup-modal");
    const letter = document.getElementById("popup-letter");

    // ìŠ¤íƒ€ì¼ ì ìš©
    letter.className = `bg-yellow-50 rounded-none border-8 border-yellow-900 p-8 shadow-2xl relative ${charInfo.style}`;

    // ìºë¦­í„° ì„¤ì •
    document.getElementById("popup-character").textContent = charInfo.emoji;
    document.getElementById("popup-sender").textContent = `${charInfo.name}ë¡œë¶€í„°`;
    document.getElementById("popup-message").textContent = popupData.message;

    // ë‚ ì§œ ì„¤ì •
    const today = new Date().toLocaleDateString("ko-KR", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
    document.getElementById("popup-date").textContent = today;

    // ìƒ‰ìƒ í…Œë§ˆ (ì™ìŠ¤ ì”°)
    const sealElement = document.getElementById("popup-seal");
    sealElement.textContent = charInfo.emoji;

    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove("hidden");

    // íŒì—… í‘œì‹œ ê¸°ë¡ (ì„œë²„ì—)
    recordPopupShown(popupData);
  }

  /**
   * ì„œë²„ì—ì„œ íŒì—… íŠ¸ë¦¬ê±° í™•ì¸
   */
  async function checkPopupTrigger() {
    try {
      const token = localStorage.getItem('session_token');
      if (!token) return;

      const response = await fetch('/api/learning/check-popup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) return;

      const data = await response.json();
      if (data.popup) {
        showCharacterPopup(data.popup);
      }
    } catch (error) {
      console.error('íŒì—… í™•ì¸ ì‹¤íŒ¨:', error);
    }
  }

  /**
   * íŒì—… ë‹«ê¸°
   */
  function closeCharacterPopup() {
    const modal = document.getElementById("character-popup-modal");
    modal.classList.add("hidden");
    currentPopupData = null;
  }

  /**
   * íŒì—… ë‹¤ìŒì— ë³´ê¸° (ë‚˜ì¤‘ì— ë‹¤ì‹œ í‘œì‹œ)
   */
  function dismissCharacterPopup() {
    const modal = document.getElementById("character-popup-modal");
    modal.classList.add("hidden");
    // TODO: ë‹¤ìŒì— ë‹¤ì‹œ ë³´ê¸° ê¸°ëŠ¥ êµ¬í˜„
    currentPopupData = null;
  }

  /**
   * íŒì—… í‘œì‹œ ê¸°ë¡
   */
  async function recordPopupShown(popupData) {
    try {
      const token = localStorage.getItem('session_token');
      if (!token) return;

      await fetch("/api/learning/popup-shown", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          popup_type: popupData.type,
          character: popupData.character,
          message: popupData.message,
          trigger_reason: popupData.trigger,
        }),
      });
    } catch (error) {
      console.error("íŒì—… ê¸°ë¡ ì‹¤íŒ¨:", error);
    }
  }

  // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById("character-popup-modal");
      if (!modal.classList.contains('hidden')) {
        closeCharacterPopup();
      }
    }
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒì—… í™•ì¸ (ë¡œê·¸ì¸ëœ ê²½ìš°)
  window.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('session_token');
    if (token) {
      // 3ì´ˆ í›„ì— íŒì—… í™•ì¸ (í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„)
      setTimeout(checkPopupTrigger, 3000);
    }
  });
</script>
