{% extends "base.html" %} {% block title %}ë°œìŒ êµì • - ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock
%} {% block content %}
<div class="max-w-4xl mx-auto px-4">
  <div class="bg-white rounded-2xl p-6 shadow-lg">
    <!-- Header -->
    <header class="mb-6">
      <div
        class="inline-flex items-center gap-2 px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold mb-2"
      >
        <span class="w-2 h-2 bg-red-500 rounded-full"></span>
        ONUI Â· AI í•™ìŠµ ë„êµ¬
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <span class="text-2xl">ğŸ¤</span>
        ë°œìŒ êµì •
      </h1>
      <p class="text-sm text-gray-600">
        ë§ˆì´í¬ë¡œ ë…¹ìŒí•˜ê³  AIê°€ ë‹¹ì‹ ì˜ ë°œìŒì„ í‰ê°€í•´ì¤ë‹ˆë‹¤
      </p>
    </header>

    <!-- Pronunciation Check Section -->
    <section
      class="mb-6 p-4 bg-gradient-to-br from-red-50 to-orange-50 rounded-xl border border-red-200"
    >
      <h2
        class="text-lg font-semibold mb-3 text-gray-900 flex items-center gap-2"
      >
        <span class="text-2xl">âš™ï¸</span>
        ì—°ìŠµ ì„¤ì •
      </h2>

      <div class="bg-white p-4 rounded-lg shadow-sm">
        <div class="mb-4">
          <label
            for="practiceText"
            class="text-sm font-semibold text-gray-700 mb-2 block"
            >ì—°ìŠµí•  ë¬¸ì¥ ì…ë ¥</label
          >
          <div class="flex gap-2">
            <input
              id="practiceText"
              type="text"
              class="flex-1 border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
              placeholder="ì—°ìŠµí•  ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”)"
              onkeydown="if (event.key === 'Enter') { event.preventDefault(); setPracticeText(); }"
            />
            <button
              onclick="setPracticeText()"
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm"
            >
              ì„¤ì •
            </button>
          </div>
        </div>

        <div
          class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg"
        >
          <div>
            <div id="targetText" class="text-xl font-bold text-gray-900">
              ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ì„¤ì • ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”
            </div>
            <div id="targetRoman" class="text-sm text-gray-500 mt-1"></div>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="listenBtn"
              class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm"
            >
              ğŸ”Š ë‹¤ì‹œ ë“£ê¸°
            </button>
          </div>
        </div>

        <div class="flex gap-2 mb-4">
          <button
            id="recordBtn"
            class="flex-1 px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 text-sm font-medium"
          >
            ğŸ¤ ë…¹ìŒ ì‹œì‘
          </button>
          <button
            id="stopBtn"
            disabled
            class="flex-1 px-4 py-3 bg-gray-300 text-white rounded-lg opacity-50 cursor-not-allowed text-sm font-medium"
          >
            â¹ ì •ì§€ ë° ë¶„ì„
          </button>
        </div>

        <div id="pronResult" class="mt-3"></div>
      </div>
    </section>

    <!-- Tips Section -->
    <section class="p-4 bg-gray-50 rounded-xl border border-gray-200">
      <div class="text-sm font-semibold text-gray-900 mb-2">ğŸ’¡ ì‚¬ìš© íŒ</div>
      <div class="text-xs text-gray-700 space-y-1">
        <p>
          â€¢ <strong>ë§ˆì´í¬ ê¶Œí•œ</strong>: ì²˜ìŒ ë…¹ìŒí•  ë•Œ ë¸Œë¼ìš°ì €ì˜ ë§ˆì´í¬
          ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
        </p>
        <p>
          â€¢ <strong>ëª…í™•í•œ ë°œìŒ</strong>: ì •í™•í•œ í‰ê°€ë¥¼ ìœ„í•´ ëª…í™•í•˜ê³  ì²œì²œíˆ
          ë°œìŒí•´ì£¼ì„¸ìš”
        </p>
        <p>
          â€¢ <strong>ì¡°ìš©í•œ í™˜ê²½</strong>: ì£¼ë³€ ì†ŒìŒì´ ì ì€ í™˜ê²½ì—ì„œ ë…¹ìŒí•˜ëŠ”
          ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤
        </p>
        <p>
          â€¢ <strong>ìƒì„¸ ë¶„ì„</strong>: SpeechPro APIëŠ” ë¬¸ì¥ë³„, ë‹¨ì–´ë³„ ìƒì„¸
          ì ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤
        </p>
        <p>
          â€¢ <strong>AI í”¼ë“œë°±</strong>: ê°œì„ í•  ì ì— ëŒ€í•œ AIì˜ ì¹œì ˆí•œ í”¼ë“œë°±ì„
          ë°›ì•„ë³´ì„¸ìš”
        </p>
      </div>
    </section>
  </div>
</div>

<!-- SpeechPro ê²°ê³¼ ëª¨ë‹¬ -->
<div
  id="speechpro-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
>
  <div
    class="relative w-full max-w-3xl max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-2xl p-8"
  >
    <button
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl"
      onclick="closeSpeechProModal()"
      aria-label="ë‹«ê¸°"
    >
      âœ•
    </button>

    <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š ë°œìŒ í‰ê°€ ê²°ê³¼</h2>

    <!-- ì ìˆ˜ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow p-6 mb-6">
      <!-- ì „ì²´ ì ìˆ˜ -->
      <div class="mb-6">
        <div class="text-center">
          <div class="text-6xl font-bold text-blue-600 mb-2">
            <span id="sp-overall-score">0</span>/100
          </div>
          <p
            id="sp-score-feedback"
            class="text-lg text-gray-600 font-semibold"
          ></p>
        </div>

        <!-- ì ìˆ˜ ê²Œì´ì§€ -->
        <div class="mt-6">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div
              id="sp-score-bar"
              class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full transition-all duration-500"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- ìƒì„¸ ì •ë³´ -->
      <div class="border-t pt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">ìƒì„¸ ë¶„ì„</h3>
        <div id="sp-details-content" class="space-y-3 text-gray-700">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
    </div>

    <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
    <div
      id="sp-ai-feedback-section"
      class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-6 hidden"
    >
      <h3 class="text-lg font-semibold text-blue-900 mb-3">
        ğŸ¤– AI ê°œì„  í”¼ë“œë°±
      </h3>
      <div
        id="sp-ai-feedback-content"
        class="text-blue-800 whitespace-pre-wrap"
      >
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>

    <div class="flex justify-end gap-3">
      <button
        onclick="closeSpeechProModal()"
        class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
      >
        ë‹«ê¸°
      </button>
    </div>
  </div>
</div>

<script>
  // SpeechPro Modal functions
  function showSpeechProModal(data, targetText) {
    const modal = document.getElementById("speechpro-modal");
    const score = data.score || 0;

    document.getElementById("sp-overall-score").textContent = score;
    document.getElementById("sp-score-bar").style.width = score + "%";

    let feedback = "";
    if (score >= 90) feedback = "ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤!";
    else if (score >= 80) feedback = "ğŸ‘ ì•„ì£¼ ì¢‹ì•„ìš”!";
    else if (score >= 70) feedback = "ğŸ˜Š ì˜í•˜ê³  ìˆì–´ìš”!";
    else if (score >= 60) feedback = "ğŸ’ª ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•´ìš”!";
    else feedback = "ğŸ“š ì—°ìŠµì´ í•„ìš”í•´ìš”!";
    document.getElementById("sp-score-feedback").textContent = feedback;

    let detailsHtml = "";

    if (data.fluency !== undefined) {
      detailsHtml += `<div class="flex justify-between"><span>ğŸ¯ ìœ ì°½ì„±:</span><span class="font-semibold">${data.fluency}%</span></div>`;
    }

    if (data.sentence_scores && data.sentence_scores.length > 0) {
      detailsHtml += `<div class="mt-4"><p class="font-semibold mb-2">ë¬¸ì¥ë³„ ì ìˆ˜:</p>`;
      data.sentence_scores.forEach((s, idx) => {
        const barWidth = Math.round(s);
        detailsHtml += `
          <div class="mb-2">
            <div class="flex justify-between text-sm mb-1">
              <span>ë¬¸ì¥ ${idx + 1}</span>
              <span class="font-semibold">${s}ì </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full" style="width: ${barWidth}%"></div>
            </div>
          </div>
        `;
      });
      detailsHtml += `</div>`;
    }

    if (data.words && data.words.length > 0) {
      detailsHtml += `<div class="mt-4"><p class="font-semibold mb-2">ë‹¨ì–´ë³„ ë¶„ì„:</p><div class="space-y-2">`;
      data.words.forEach((word) => {
        if (word.text && word.text !== "!SIL") {
          detailsHtml += `<div class="text-sm"><span class="font-medium">${
            word.text
          }:</span> <span class="text-blue-600">${Math.round(
            word.score || 0
          )}ì </span></div>`;
        }
      });
      detailsHtml += `</div></div>`;
    }

    document.getElementById("sp-details-content").innerHTML =
      detailsHtml || "<p class='text-gray-500'>ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";

    if (data.ai_feedback) {
      document
        .getElementById("sp-ai-feedback-section")
        .classList.remove("hidden");
      document.getElementById("sp-ai-feedback-content").textContent =
        data.ai_feedback;
    } else {
      document.getElementById("sp-ai-feedback-section").classList.add("hidden");
    }

    modal.classList.remove("hidden");
  }

  function closeSpeechProModal() {
    document.getElementById("speechpro-modal").classList.add("hidden");
  }

  // Recording logic
  let mediaRecorder;
  let audioChunks = [];
  let mediaStream = null;

  function initializeRecordingButtons() {
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");

    if (!recordBtn || !stopBtn) {
      console.warn("Recording buttons not found");
      return;
    }

    recordBtn.onclick = async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        mediaRecorder = new MediaRecorder(mediaStream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.start();

        recordBtn.disabled = true;
        recordBtn.classList.add("opacity-50", "cursor-not-allowed");
        stopBtn.disabled = false;
        stopBtn.classList.remove(
          "opacity-50",
          "cursor-not-allowed",
          "bg-gray-300"
        );
        stopBtn.classList.add(
          "bg-gradient-to-r",
          "from-gray-600",
          "to-gray-700"
        );
        document.getElementById("pronResult").innerHTML =
          '<div class="flex items-center gap-2 text-sm text-gray-600"><div class="animate-pulse">ğŸ”´</div> ë…¹ìŒ ì¤‘...</div>';
        document.getElementById("pronResult").classList.remove("hidden");
      } catch (error) {
        console.error("ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:", error);
        alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        document.getElementById("pronResult").innerHTML =
          '<div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: ' +
          error.message +
          "</div>";
      }
    };

    stopBtn.onclick = async () => {
      try {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        recordBtn.classList.remove("opacity-50", "cursor-not-allowed");
        stopBtn.disabled = true;
        stopBtn.classList.add(
          "opacity-50",
          "cursor-not-allowed",
          "bg-gray-300"
        );
        stopBtn.classList.remove(
          "bg-gradient-to-r",
          "from-gray-600",
          "to-gray-700"
        );

        mediaRecorder.onstop = async () => {
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }

          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          const formData = new FormData();
          formData.append("file", audioBlob, "recording.wav");
          const targetText = document.getElementById("targetText").innerText;
          formData.append("text", targetText);

          document.getElementById("pronResult").innerHTML =
            '<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-orange-600"></div><span class="text-sm text-gray-600">SpeechPro APIë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span></div>';

          try {
            const res = await fetch("/api/speechpro/evaluate", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();

            if (data.error) {
              document.getElementById("pronResult").innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-red-700 font-semibold text-sm">âš ï¸ ì˜¤ë¥˜</p>
                  <p class="text-red-600 text-xs mt-1">${data.error}</p>
                  ${
                    data.details
                      ? '<p class="text-gray-600 text-xs mt-1">' +
                        data.details +
                        "</p>"
                      : ""
                  }
                </div>
              `;
            } else {
              showSpeechProModal(data, targetText);

              const score = data.score || 0;
              document.getElementById("pronResult").innerHTML = `
                <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                  <p class="text-sm text-gray-700">âœ… ë¶„ì„ ì™„ë£Œ! ìƒì„¸ ê²°ê³¼ëŠ” ëª¨ë‹¬ì°½ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                  <p class="text-lg font-bold text-green-700 mt-1">ìµœì¢… ì ìˆ˜: ${score}ì </p>
                </div>
              `;
            }
          } catch (error) {
            document.getElementById("pronResult").innerHTML = `
              <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-700 font-semibold text-sm">âš ï¸ ì˜¤ë¥˜</p>
                <p class="text-red-600 text-xs mt-1">ë°œìŒ ë¶„ì„ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
              </div>
            `;
          }
        };
      } catch (error) {
        console.error("ë…¹ìŒ ì¤‘ì§€ ì˜¤ë¥˜:", error);
        alert("ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };
  }

  // Speak text using Web Speech API
  function speakText(txt) {
    if (!txt) return;
    if ("speechSynthesis" in window) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = "ko-KR";
      u.rate = 0.95;
      const voices = window.speechSynthesis.getVoices() || [];
      for (const v of voices) {
        if (!v) continue;
        const lname = (v.lang || "").toLowerCase();
        const n = (v.name || "").toLowerCase();
        if (
          lname.startsWith("ko") ||
          n.includes("korean") ||
          n.includes("noto") ||
          n.includes("nanum")
        ) {
          u.voice = v;
          break;
        }
      }
      if (!u.voice) {
        window.speechSynthesis.onvoiceschanged = () => {
          const vs = window.speechSynthesis.getVoices() || [];
          for (const v of vs) {
            const lname = (v.lang || "").toLowerCase();
            const n = (v.name || "").toLowerCase();
            if (
              lname.startsWith("ko") ||
              n.includes("korean") ||
              n.includes("noto") ||
              n.includes("nanum")
            ) {
              u.voice = v;
              break;
            }
          }
          window.speechSynthesis.speak(u);
        };
      } else {
        window.speechSynthesis.speak(u);
      }
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  }

  // Set practice text from input
  function setPracticeText() {
    const input = document.getElementById("practiceText");
    const text = input.value.trim();

    if (!text) {
      alert("ì—°ìŠµí•  ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const targetText = document.getElementById("targetText");
    const targetRoman = document.getElementById("targetRoman");

    targetText.innerText = text;
    targetRoman.innerText = "";

    document.getElementById("pronResult").innerHTML = "";
  }

  window.addEventListener("DOMContentLoaded", () => {
    initializeRecordingButtons();
  });
</script>
{% endblock %}
