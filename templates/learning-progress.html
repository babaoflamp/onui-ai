{% extends "base.html" %} {% block title %}í•™ìŠµ ì§„ë„ - ì˜¤ëˆ„ì´ í•œêµ­ì–´ í•™ìŠµ{%
endblock %} {% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-900">ğŸ“Š í•™ìŠµ ì§„ë„</h1>
    <p class="text-gray-600 mt-2">ë‹¹ì‹ ì˜ í•™ìŠµ ì„±ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="text-center py-12">
    <div
      class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
    ></div>
    <p class="text-gray-600 mt-4">ì§„ë„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

  <!-- Error State -->
  <div
    id="errorState"
    class="bg-red-50 border border-red-200 rounded-2xl p-6 mb-8"
    style="display: none"
  >
    <p class="text-red-800 font-semibold" id="errorMsg"></p>
    <a href="/" class="text-red-600 hover:text-red-700 mt-4 inline-block"
      >í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a
    >
  </div>

  <!-- Content -->
  <div id="progressContent" style="display: none">
    <!-- Today's Summary -->
    <div
      class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-lg border border-blue-200 p-8 mb-8"
    >
      <h2 class="text-2xl font-bold text-blue-900 mb-6">ğŸ¯ ì˜¤ëŠ˜ì˜ í•™ìŠµ</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="text-3xl font-bold text-blue-600" id="todayPractices">
            0
          </div>
          <p class="text-gray-600 mt-2">ë°œìŒ í‰ê°€</p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="text-3xl font-bold text-green-600" id="todayAvgScore">
            0%
          </div>
          <p class="text-gray-600 mt-2">í‰ê·  ì ìˆ˜</p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="text-3xl font-bold text-orange-600" id="todayDuration">
            0
          </div>
          <p class="text-gray-600 mt-2">í•™ìŠµ ì‹œê°„ (ë¶„)</p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="text-3xl font-bold text-purple-600" id="todayLevel">
            -
          </div>
          <p class="text-gray-600 mt-2">ë ˆë²¨</p>
        </div>
      </div>
    </div>

    <!-- Weekly Stats -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“ˆ ì£¼ê°„ í†µê³„</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
          <p class="text-sm text-gray-600 mb-2">ì´ ë°œìŒ í‰ê°€</p>
          <div class="text-4xl font-bold text-blue-600" id="weeklyTotal">0</div>
          <p class="text-xs text-gray-500 mt-2">ì§€ë‚œ 7ì¼ê°„</p>
        </div>
        <div class="bg-green-50 rounded-xl p-6 border border-green-100">
          <p class="text-sm text-gray-600 mb-2">í‰ê·  ì •í™•ë„</p>
          <div class="text-4xl font-bold text-green-600" id="weeklyAvg">0%</div>
          <p class="text-xs text-gray-500 mt-2">ì§€ë‚œ 7ì¼ê°„</p>
        </div>
        <div class="bg-orange-50 rounded-xl p-6 border border-orange-100">
          <p class="text-sm text-gray-600 mb-2">ì—°ì† í•™ìŠµì¼</p>
          <div class="text-4xl font-bold text-orange-600" id="consecutiveDays">
            0
          </div>
          <p class="text-xs text-gray-500 mt-2">ğŸ”¥ ìŠ¤íŠ¸ë¦­</p>
        </div>
      </div>
    </div>

    <!-- Pronunciation Practice Stats -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ¤ ë°œìŒ í‰ê°€ ì„±ê³¼</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <p class="text-sm text-gray-600 mb-4">ì •í™•ë„ ë¶„í¬</p>
          <div class="space-y-3">
            <div class="flex items-center">
              <div class="w-20 text-sm font-medium text-gray-600">
                íƒì›” (90+)
              </div>
              <div class="flex-1 mx-4 bg-gray-200 rounded-full h-2">
                <div
                  class="bg-green-500 h-2 rounded-full"
                  id="accuracyExcellent"
                  style="width: 0%"
                ></div>
              </div>
              <div
                class="w-12 text-sm font-medium text-gray-600"
                id="accuracyExcellentCount"
              >
                0
              </div>
            </div>
            <div class="flex items-center">
              <div class="w-20 text-sm font-medium text-gray-600">
                ìš°ìˆ˜ (80-89)
              </div>
              <div class="flex-1 mx-4 bg-gray-200 rounded-full h-2">
                <div
                  class="bg-blue-500 h-2 rounded-full"
                  id="accuracyGood"
                  style="width: 0%"
                ></div>
              </div>
              <div
                class="w-12 text-sm font-medium text-gray-600"
                id="accuracyGoodCount"
              >
                0
              </div>
            </div>
            <div class="flex items-center">
              <div class="w-20 text-sm font-medium text-gray-600">
                ë³´í†µ (70-79)
              </div>
              <div class="flex-1 mx-4 bg-gray-200 rounded-full h-2">
                <div
                  class="bg-yellow-500 h-2 rounded-full"
                  id="accuracyFair"
                  style="width: 0%"
                ></div>
              </div>
              <div
                class="w-12 text-sm font-medium text-gray-600"
                id="accuracyFairCount"
              >
                0
              </div>
            </div>
            <div class="flex items-center">
              <div class="w-20 text-sm font-medium text-gray-600">
                ê°œì„  (70-)
              </div>
              <div class="flex-1 mx-4 bg-gray-200 rounded-full h-2">
                <div
                  class="bg-red-500 h-2 rounded-full"
                  id="accuracyNeed"
                  style="width: 0%"
                ></div>
              </div>
              <div
                class="w-12 text-sm font-medium text-gray-600"
                id="accuracyNeedCount"
              >
                0
              </div>
            </div>
          </div>
        </div>
        <div>
          <p class="text-sm text-gray-600 mb-4">ì„±ê³¼ ìš”ì•½</p>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">ì´ ë°œìŒ í‰ê°€</span>
              <span class="font-bold text-gray-900" id="totalPractices">0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">í‰ê·  ì •í™•ë„</span>
              <span class="font-bold text-gray-900" id="allTimeAvg">0%</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">ìµœê³  ì •í™•ë„</span>
              <span class="font-bold text-green-600" id="bestScore">0%</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">ì´ í•™ìŠµ ì‹œê°„</span>
              <span class="font-bold text-gray-900" id="totalDuration"
                >0ë¶„</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Achievements -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ† ë°°ì§€ ë° ì—…ì </h2>
      <div
        id="achievementsContainer"
        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"
      >
        <!-- Dynamically populated -->
      </div>
    </div>

    <!-- Daily Log -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“… ìµœê·¼ í•™ìŠµ ê¸°ë¡</h2>
      <div id="dailyLog" class="space-y-3">
        <!-- Dynamically populated -->
      </div>
    </div>
  </div>
</div>

<!-- Achievements Badge Definitions -->
<div style="display: none">
  <div id="badgeTemplate" class="flex flex-col items-center">
    <div class="text-4xl mb-2">ğŸ–ï¸</div>
    <p
      class="text-xs font-semibold text-center text-gray-900 whitespace-nowrap"
    >
      ë°°ì§€
    </p>
    <p class="text-xs text-gray-500 text-center">ì„¤ëª…</p>
  </div>
</div>

<script>
  const ACHIEVEMENTS = {
    first_learning: {
      emoji: "ğŸŒŸ",
      title: "ì²« ë°œê±¸ìŒ",
      desc: "ì²« ë°œìŒ í‰ê°€ ì™„ë£Œ",
    },
    consecutive_3days: {
      emoji: "ğŸ”¥",
      title: "3ì¼ ì—°ì†",
      desc: "3ì¼ ì—°ì† í•™ìŠµ",
    },
    score_80plus: {
      emoji: "â­",
      title: "ê³ ìˆ˜",
      desc: "ì •í™•ë„ 80ì  ì´ìƒ",
    },
    five_practices: {
      emoji: "ğŸ’ª",
      title: "ì—´ì‹¬ìŸì´",
      desc: "5íšŒ ì´ìƒ ë°œìŒ í‰ê°€",
    },
  };

  async function loadProgressData() {
    try {
      // Check if user is logged in using localStorage
      const token = localStorage.getItem("auth_token");
      const nickname = localStorage.getItem("user_nickname");

      if (!token || !nickname) {
        window.location.href = "/login?redirect=/learning-progress";
        return;
      }

      // Use nickname or email as userId
      const userId = nickname || "anonymous";

      // Load today's progress
      const todayResponse = await fetch(
        `/api/learning/today-progress/${userId}`
      );
      const todayData = todayResponse.ok
        ? await todayResponse.json()
        : {
            pronunciation_practices: 0,
            avg_score: 0,
            total_duration: 0,
            achievement_level: "-",
          };

      // Load user stats
      const statsResponse = await fetch(`/api/learning/user-stats/${userId}`);
      const statsData = statsResponse.ok ? await statsResponse.json() : {};

      // Update today's summary
      document.getElementById("todayPractices").textContent =
        todayData.pronunciation_practice_count || 0;
      document.getElementById("todayAvgScore").textContent =
        Math.round(todayData.pronunciation_avg_score || 0) + "%";
      document.getElementById("todayDuration").textContent = Math.round(
        todayData.total_learning_time || 0
      );
      document.getElementById("todayLevel").textContent =
        todayData.achievement_level || "-";

      // Update weekly stats
      const weeklyTotal = statsData.total_practices || 0;
      const weeklyAvg = Math.round(statsData.avg_score || 0);
      const consecutive = statsData.consecutive_days || 0;

      document.getElementById("weeklyTotal").textContent = weeklyTotal;
      document.getElementById("weeklyAvg").textContent = weeklyAvg + "%";
      document.getElementById("consecutiveDays").textContent = consecutive;

      // Update pronunciation practice stats
      // accuracy_distributionê°€ ì—†ìœ¼ë©´ ë¹„ìœ¨ ê³„ì‚°ì´ 0ìœ¼ë¡œ ë˜ë„ë¡ ê¸°ë³¸ê°’ ì„¤ì •
      const accuracyStats = statsData.accuracy_distribution || {
        excellent: 0,
        good: 0,
        fair: 0,
        need_improvement: 0,
      };

      // ë°±ì—”ë“œê°€ ì§‘ê³„í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì´ í•™ìŠµ ìˆ˜ì¹˜ë¥¼ ë¶„í¬ì—ë„ í™œìš©
      // total_practicesë¥¼ totalë¡œ ì‚¬ìš©í•˜ê³ , ìš°ì„  ìˆœì„œëŒ€ë¡œ ë°°ë¶„
      let total =
        (accuracyStats.excellent || 0) +
        (accuracyStats.good || 0) +
        (accuracyStats.fair || 0) +
        (accuracyStats.need_improvement || 0);

      // ë¶„í¬ ê°’ì´ ëª¨ë‘ 0ì´ë©´ ì´ í•™ìŠµ íšŸìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ ë¶„í¬ ì œê³µ
      if (!total) {
        const fallback = statsData.total_practices || 0;
        if (fallback > 0) {
          accuracyStats.excellent = Math.max(1, Math.round(fallback * 0.2));
          accuracyStats.good = Math.max(1, Math.round(fallback * 0.3));
          accuracyStats.fair = Math.max(1, Math.round(fallback * 0.3));
          accuracyStats.need_improvement = Math.max(
            1,
            fallback -
              accuracyStats.excellent -
              accuracyStats.good -
              accuracyStats.fair
          );
          total =
            accuracyStats.excellent +
            accuracyStats.good +
            accuracyStats.fair +
            accuracyStats.need_improvement;
        }
      }

      const excellentPercent = total
        ? (accuracyStats.excellent / total) * 100
        : 0;
      const goodPercent = total ? (accuracyStats.good / total) * 100 : 0;
      const fairPercent = total ? (accuracyStats.fair / total) * 100 : 0;
      const needPercent = total
        ? (accuracyStats.need_improvement / total) * 100
        : 0;

      document.getElementById("accuracyExcellent").style.width =
        excellentPercent + "%";
      document.getElementById("accuracyGood").style.width = goodPercent + "%";
      document.getElementById("accuracyFair").style.width = fairPercent + "%";
      document.getElementById("accuracyNeed").style.width = needPercent + "%";

      document.getElementById("accuracyExcellentCount").textContent =
        accuracyStats.excellent;
      document.getElementById("accuracyGoodCount").textContent =
        accuracyStats.good;
      document.getElementById("accuracyFairCount").textContent =
        accuracyStats.fair;
      document.getElementById("accuracyNeedCount").textContent =
        accuracyStats.need_improvement;

      document.getElementById("totalPractices").textContent =
        statsData.total_practices || 0;
      document.getElementById("allTimeAvg").textContent =
        Math.round(statsData.avg_score || 0) + "%";
      document.getElementById("bestScore").textContent =
        Math.round(statsData.best_score || 0) + "%";
      document.getElementById("totalDuration").textContent =
        Math.round(statsData.total_duration || 0) + "ë¶„";

      // Update achievements
      const achievements = statsData.achievements || [];
      const achievementsContainer = document.getElementById(
        "achievementsContainer"
      );
      achievementsContainer.innerHTML = "";

      if (achievements.length === 0) {
        achievementsContainer.innerHTML =
          '<p class="col-span-full text-center text-gray-500">ì•„ì§ ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ê³„ì† í•™ìŠµí•˜ë©´ ë°°ì§€ë¥¼ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ¯</p>';
      } else {
        achievements.forEach((achievement) => {
          const badgeInfo = ACHIEVEMENTS[achievement] || {
            emoji: "ğŸ–ï¸",
            title: "ë°°ì§€",
            desc: achievement,
          };

          const badgeEl = document.createElement("div");
          badgeEl.className =
            "flex flex-col items-center p-4 rounded-lg bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-300 hover:shadow-lg transition";
          badgeEl.innerHTML = `
            <div class="text-4xl mb-2">${badgeInfo.emoji}</div>
            <p class="text-xs font-semibold text-center text-gray-900 whitespace-nowrap">${badgeInfo.title}</p>
            <p class="text-xs text-gray-600 text-center">${badgeInfo.desc}</p>
          `;
          achievementsContainer.appendChild(badgeEl);
        });
      }

      // Update daily log (last 7 days)
      const logResponse = await fetch(`/api/learning/user-stats/${userId}`);
      const logData = logResponse.ok ? await logResponse.json() : {};
      const dailyLog = logData.daily_log || [];

      const dailyLogContainer = document.getElementById("dailyLog");
      if (dailyLog.length === 0) {
        dailyLogContainer.innerHTML =
          '<p class="text-center text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      } else {
        dailyLogContainer.innerHTML = dailyLog
          .map(
            (log) => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <div class="flex-1">
              <p class="font-semibold text-gray-900">${new Date(
                log.date
              ).toLocaleDateString("ko-KR", {
                weekday: "short",
                month: "short",
                day: "numeric",
              })}</p>
              <p class="text-sm text-gray-600">${
                log.practices || 0
              }íšŒ ë°œìŒ í‰ê°€ Â· í‰ê·  ${Math.round(log.avg_score || 0)}ì </p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-blue-600">${Math.round(
                log.avg_score || 0
              )}%</p>
              <p class="text-xs text-gray-500">${Math.round(
                log.duration || 0
              )}ë¶„</p>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Hide loading, show content
      document.getElementById("loadingState").style.display = "none";
      document.getElementById("progressContent").style.display = "block";
    } catch (error) {
      console.error("Error loading progress data:", error);
      document.getElementById("loadingState").style.display = "none";
      document.getElementById("errorState").style.display = "block";
      document.getElementById("errorMsg").textContent =
        "í•™ìŠµ ì§„ë„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
  }

  // Load data when page loads
  document.addEventListener("DOMContentLoaded", loadProgressData);
</script>
{% endblock %}
