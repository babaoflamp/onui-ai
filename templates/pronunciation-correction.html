{% extends "base.html" %} {% block title %}ë°œìŒ êµì • | ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock
%} {% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ¤ ë°œìŒ êµì •</h1>
    <p class="text-gray-600">
      AIê°€ ë‹¹ì‹ ì˜ í•œêµ­ì–´ ë°œìŒì„ í‰ê°€í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤!
    </p>
  </div>

  <div class="bg-white rounded-2xl shadow-lg p-6">
    <!-- Pronunciation Check Section -->
    <section
      class="mb-6 p-4 bg-gradient-to-br from-red-50 to-orange-50 rounded-xl border border-red-200"
    >
      <h2
        class="text-lg font-semibold mb-4 text-gray-900 flex items-center gap-2"
      >
        <span class="text-2xl">ğŸ™ï¸</span>
        ë°œìŒ ì—°ìŠµ
      </h2>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >ì—°ìŠµ ë¬¸ì¥</label
        >
        <input
          id="targetText"
          type="text"
          placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”, ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤"
          value="ì•ˆë…•í•˜ì„¸ìš”"
          class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
        />
        <p class="text-xs text-gray-500 mt-1">
          ì½ì„ ë¬¸ì¥ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”
        </p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >ë§ˆì´í¬</label
          >
          <button
            id="recordBtn"
            onclick="toggleRecording()"
            class="w-full bg-gradient-to-r from-red-500 to-orange-600 text-white px-6 py-3 rounded-lg transition-all shadow-md font-medium hover:shadow-lg"
          >
            ğŸ™ï¸ ë…¹ìŒ ì‹œì‘
          </button>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >ì‹œê°„: <span id="recordTime">0:00</span></label
          >
          <div id="audioPlayback" class="w-full"></div>
        </div>
      </div>

      <button
        id="submitBtn"
        onclick="submitPronunciation()"
        disabled
        class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-3 rounded-lg transition-all shadow-md font-medium hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
      >
        âœ¨ ë°œìŒ í‰ê°€ë°›ê¸°
      </button>

      <div
        id="feedbackResult"
        class="bg-white p-4 rounded-lg shadow-sm hidden border border-red-200 mt-4 max-h-[600px] overflow-y-auto"
      ></div>
    </section>

    <!-- Tips Section -->
    <section class="p-4 bg-blue-50 rounded-xl border border-blue-200">
      <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
        <span>ğŸ’¡</span>
        ë°œìŒ í‰ê°€ íŒ
      </h3>
      <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
        <li>ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</li>
        <li>ì¡°ìš©í•œ í™˜ê²½ì—ì„œ ë…¹ìŒí•˜ë©´ ë” ì •í™•í•œ í‰ê°€ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ìì—°ìŠ¤ëŸ½ê²Œ í•œ ë²ˆ ì½ì–´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.</li>
        <li>ì •í™•í•˜ì§€ ì•Šì€ ë°œìŒì€ AIê°€ êµì •í•´ì¤ë‹ˆë‹¤.</li>
      </ul>
    </section>
  </div>
</div>

<script>
  let recorder;
  let audioChunks = [];
  let isRecording = false;
  let recordStartTime = 0;
  let recordTimer = null;

  async function toggleRecording() {
    const btn = document.getElementById("recordBtn");

    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        recorder = new MediaRecorder(stream);
        audioChunks = [];

        recorder.ondataavailable = (e) => audioChunks.push(e.data);
        recorder.start();

        isRecording = true;
        btn.innerHTML = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
        btn.classList.add("bg-red-700");

        recordStartTime = Date.now();
        recordTimer = setInterval(updateRecordTime, 100);

        document.getElementById("submitBtn").disabled = false;
      } catch (error) {
        alert("ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
      }
    } else {
      recorder.stop();
      recorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const audioUrl = URL.createObjectURL(audioBlob);

        const audio = document.createElement("audio");
        audio.src = audioUrl;
        audio.controls = true;
        audio.className = "w-full mt-2";

        document.getElementById("audioPlayback").innerHTML = "";
        document.getElementById("audioPlayback").appendChild(audio);

        window.recordedAudioBlob = audioBlob;
      };

      isRecording = false;
      btn.innerHTML = "ğŸ™ï¸ ë…¹ìŒ ì‹œì‘";
      btn.classList.remove("bg-red-700");

      clearInterval(recordTimer);
      document.getElementById("recordTime").textContent = "0:00";
    }
  }

  function updateRecordTime() {
    const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById("recordTime").textContent = `${minutes}:${seconds
      .toString()
      .padStart(2, "0")}`;
  }

  async function submitPronunciation() {
    if (!window.recordedAudioBlob) {
      alert("ë¨¼ì € ë…¹ìŒí•´ì£¼ì„¸ìš”!");
      return;
    }

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.innerHTML = "â³ í‰ê°€ ì¤‘...";

    try {
      const formData = new FormData();
      formData.append("audio", window.recordedAudioBlob, "recording.webm");
      formData.append("text", document.getElementById("targetText").value);

      const response = await fetch("/api/check-pronunciation", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      const outDiv = document.getElementById("feedbackResult");

      if (!response.ok) {
        outDiv.innerHTML = `<div class="text-red-600">ì˜¤ë¥˜: ${
          data.error || "ìš”ì²­ ì‹¤íŒ¨"
        }</div>`;
      } else {
        let html = `<div class="prose max-w-full">`;
        html += `<h3>ğŸ¯ ë°œìŒ í‰ê°€ ê²°ê³¼</h3>`;
        html += `<div class="bg-orange-50 p-3 rounded border border-orange-200 mb-4">`;
        html += `<p><strong>í‰ê°€ ë¬¸ì¥:</strong> ${
          data.text || document.getElementById("targetText").value
        }</p>`;
        html += `<p><strong>ì •í™•ë„:</strong> <span class="text-lg font-bold text-orange-600">${
          data.score || "í‰ê°€ ì¤‘"
        }%</span></p>`;
        html += `</div>`;
        html += `<div>${data.feedback || ""}</div>`;
        html += `</div>`;
        outDiv.innerHTML = html;
      }

      outDiv.classList.remove("hidden");
    } catch (error) {
      document.getElementById(
        "feedbackResult"
      ).innerHTML = `<div class="text-red-600">ì˜¤ë¥˜: ${error.message}</div>`;
      document.getElementById("feedbackResult").classList.remove("hidden");
    } finally {
      btn.disabled = false;
      btn.innerHTML = "âœ¨ ë°œìŒ í‰ê°€ë°›ê¸°";
    }
  }
</script>
{% endblock %}
