{% extends "base.html" %} {% block title %}오누이 한국어 학습 플랫폼{% endblock
%} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Hero Section -->
  <div class="text-center py-12">
    <h1 class="text-5xl font-bold text-gray-900 mb-4">
      🌸 오누이 한국어 학습 플랫폼
    </h1>
    <p class="text-xl text-gray-600 mb-8">
      AI와 함께하는 즐거운 한국어 학습 여정
    </p>
  </div>

  <!-- Key Features Highlight -->
  <div
    class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-orange-50 via-white to-indigo-50 border border-orange-100 shadow-lg mb-10"
  >
    <div
      class="absolute -left-10 -top-10 w-40 h-40 bg-orange-100 rounded-full blur-3xl opacity-60"
    ></div>
    <div
      class="absolute -right-8 bottom-0 w-36 h-36 bg-indigo-100 rounded-full blur-3xl opacity-50"
    ></div>
    <div class="relative p-6 sm:p-8">
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6"
      >
        <div class="flex items-center gap-3">
          <span class="text-3xl">🚀</span>
          <div>
            <p
              class="text-xs font-semibold text-orange-600 uppercase tracking-wide"
            >
              Why Onui
            </p>
            <h2 class="text-2xl font-bold text-gray-900">
              이 플랫폼의 주요 특징
            </h2>
          </div>
        </div>
        <div
          class="flex items-center gap-2 text-xs font-semibold text-orange-700 bg-white/70 border border-orange-200 rounded-full px-4 py-2 shadow-sm"
        >
          <span class="text-lg">⚡</span>
          <span>AI + 실시간 피드백</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-orange-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">🧠</span>
            <h3 class="text-base sm:text-lg font-bold text-orange-700">
              AI 복합 피드백
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            SpeechPro(정확도) + FluencyPro(유창성)을 합쳐 개인맞춤형 피드백과
            격려를 제공합니다.
          </p>
        </div>

        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-blue-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">🎬</span>
            <h3 class="text-base sm:text-lg font-bold text-blue-700">
              상황별 콘텐츠 생성
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            카페·식당·병원 등 실제 상황 표현과 대화를 AI가 바로 만들어 드립니다.
          </p>
        </div>

        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-emerald-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">📈</span>
            <h3 class="text-base sm:text-lg font-bold text-emerald-700">
              발음·유창성 평가
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            음소 단위 정확도와 발화 리듬을 모두 측정해 강점과 개선점을
            제시합니다.
          </p>
        </div>

        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-purple-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">📊</span>
            <h3 class="text-base sm:text-lg font-bold text-purple-700">
              학습 커버리지 추적
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            배운 문장·어휘·콘텐츠 진행도를 퍼센트로 보여주어 성장을 한눈에
            확인합니다.
          </p>
        </div>

        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-amber-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">🐯</span>
            <h3 class="text-base sm:text-lg font-bold text-amber-700">
              캐릭터 팝업 코칭
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            학습 타이밍에 맞춰 오빠·호랑이·동생 캐릭터가 알림과 독려를 전합니다.
          </p>
        </div>

        <div
          class="p-4 rounded-xl bg-white/80 backdrop-blur border border-gray-200 shadow-sm"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">📱</span>
            <h3 class="text-base sm:text-lg font-bold text-gray-800">
              반응형 · 가벼운 사용성
            </h3>
          </div>
          <p class="text-sm sm:text-base text-gray-700">
            설치 없이 브라우저에서 바로 사용 가능하며, 모바일/데스크톱 모두
            부드럽게 동작하도록 최적화했습니다.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast (login) -->
  <div
    id="loginToast"
    class="hidden fixed top-4 right-4 z-50 max-w-sm rounded-xl bg-gray-900 text-white shadow-lg ring-1 ring-black/10"
    role="status"
    aria-live="polite"
  >
    <div class="flex items-start gap-3 px-4 py-3">
      <div class="mt-0.5 text-lg">✓</div>
      <div class="text-sm leading-snug">
        <p class="font-semibold">로그인 완료</p>
        <p id="loginToastText" class="text-gray-200"></p>
      </div>
    </div>
  </div>

  <!-- Landing Intake (가입/취향 수집) -->
  <div
    id="signupSection"
    class="bg-white rounded-2xl shadow-lg border border-orange-100 mb-12 p-6 lg:p-8"
  >
    <!-- Guest Login Button -->
    <div class="mb-8 text-center">
      <button
        id="guestLoginBtn"
        type="button"
        class="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
      >
        <span class="text-2xl">🎭</span>
        <span>게스트로 바로 시작하기</span>
      </button>
      <p class="text-sm text-gray-500 mt-3">
        회원가입 없이 바로 체험할 수 있습니다
      </p>
      <div class="relative my-8">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-200"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-4 bg-white text-gray-500">또는 회원가입</span>
        </div>
      </div>
    </div>

    <div
      class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6 mb-6"
    >
      <div>
        <p
          class="text-xs uppercase tracking-wide text-orange-500 font-semibold"
        >
          랜딩 섹션
        </p>
        <h2 class="text-2xl font-bold text-gray-900 mt-1">
          회원가입 & 취향 정보 수집
        </h2>
        <p class="text-sm text-gray-600 mt-2">
          이메일과 8자 이상의 비밀번호를 입력해 실제 계정을 생성하세요.
          비밀번호는 PBKDF2로 해시되어 안전하게 저장되며, 취향
          정보(국적·관심사·학습 목표·스타일·시간대)는 맞춤 학습을 위해
          선택적으로 수집합니다.
        </p>
      </div>
      <div
        class="flex items-center gap-2 text-sm text-gray-600 bg-orange-50 border border-orange-100 rounded-full px-3 py-2"
      >
        <span class="text-lg">🛠️</span>
        <span>실제 가입 · SQLite 저장</span>
      </div>
    </div>

    <form id="landingForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800">이메일</label>
          <input
            name="email"
            type="email"
            required
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="you@example.com"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800">닉네임</label>
          <input
            name="nickname"
            type="text"
            required
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="학습자 닉네임"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800">비밀번호</label>
          <input
            name="password"
            type="password"
            required
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="********"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >비밀번호 확인</label
          >
          <input
            name="password_confirm"
            type="password"
            required
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="********"
          />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >국적 / 모국어</label
          >
          <input
            name="native_lang"
            type="text"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="예: 일본 / 일본어"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >소속(회사/학교)</label
          >
          <input
            name="affiliation"
            type="text"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="예: OO대학교 / OO회사"
          />
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >선호 학습 시간대</label
          >
          <select
            name="time_pref"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
          >
            <option value="">선택</option>
            <option>아침</option>
            <option>점심</option>
            <option>저녁</option>
            <option>주말</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >관심 분야 (복수 선택)</label
          >
          <div class="grid grid-cols-2 gap-2 text-sm">
            {% set interests = ["음식", "K-Pop", "영화", "드라마", "여행",
            "비즈니스"] %} {% for it in interests %}
            <label class="flex items-center gap-2 text-gray-700">
              <input
                type="checkbox"
                name="interests"
                value="{{ it }}"
                class="text-orange-500 rounded"
              />
              {{ it }}
            </label>
            {% endfor %}
          </div>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800">학습 목표</label>
          <select
            name="goal"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
          >
            <option value="">선택</option>
            <option>취미</option>
            <option>자격증(TOPIK)</option>
            <option>유학/취업</option>
            <option>비즈니스 커뮤니케이션</option>
          </select>
          <label class="text-sm font-semibold text-gray-800"
            >관심 시험/레벨</label
          >
          <input
            name="exam_level"
            type="text"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="예: TOPIK II, CEFR B1"
          />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800">학습 계기</label>
          <textarea
            name="reason"
            rows="2"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
            placeholder="한국어를 배우게 된 계기를 적어주세요"
          ></textarea>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold text-gray-800"
            >선호 학습 스타일</label
          >
          <div class="grid grid-cols-2 gap-2 text-sm">
            {% set styles = ["동영상 중심", "텍스트 중심", "문제 중심",
            "실습/대화"] %} {% for st in styles %}
            <label class="flex items-center gap-2 text-gray-700">
              <input
                type="radio"
                name="style"
                value="{{ st }}"
                class="text-orange-500"
              />
              {{ st }}
            </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
      >
        <div id="landingStatus" class="text-sm text-gray-600">
          입력 후 제출하면 계정이 생성됩니다.
        </div>
        <button
          type="submit"
          class="inline-flex items-center justify-center bg-gradient-to-r from-orange-500 to-pink-500 text-white px-5 py-2.5 rounded-lg shadow hover:from-orange-600 hover:to-pink-600 transition-all"
        >
          제출 및 저장
        </button>
      </div>
    </form>
  </div>

  <!-- Learning Modes Grid -->
  <div class="mb-12">
    <div class="flex items-center gap-2 mb-4">
      <span class="text-2xl">🧭</span>
      <h2 class="text-2xl font-bold text-gray-900">지금 이용할 수 있는 메뉴</h2>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <a href="/learning" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🤖</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">AI 학습 도구</h3>
          <p class="text-gray-600 text-sm mb-4">
            SpeechPro · FluencyPro · 교재 생성까지 한 화면에서 AI 기반 학습을
            시작하세요.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded"
              >교재 생성</span
            >
            <span
              class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded"
              >발음/유창성</span
            >
            <span
              class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded"
              >학습 계획</span
            >
          </div>
        </div>
      </a>

      <a href="/content-generation" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">📚</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">맞춤형 교재 생성</h3>
          <p class="text-gray-600 text-sm mb-4">
            관심 주제와 레벨을 고르면 예문·어휘가 포함된 교재를 즉시 만듭니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded"
              >주제별</span
            >
            <span
              class="inline-block bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded"
              >레벨별</span
            >
            <span
              class="inline-block bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded"
              >예문 포함</span
            >
          </div>
        </div>
      </a>

      <a href="/media-generation" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🎬</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">
            상황별 콘텐츠 생성
          </h3>
          <p class="text-gray-600 text-sm mb-4">
            카페·식당·병원 등 실전 시나리오 대화와 영상을 AI가 만들어 줍니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded"
              >실전 상황</span
            >
            <span
              class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded"
              >대화 스크립트</span
            >
            <span
              class="inline-block bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded"
              >영상/오디오</span
            >
          </div>
        </div>
      </a>

      <a href="/fluency-test" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">✍️</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">작문 테스트</h3>
          <p class="text-gray-600 text-sm mb-4">
            글쓰기 후 AI가 유창성·문법·어휘를 평가하고 개선 문장을 제안합니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded"
              >유창성</span
            >
            <span
              class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
              >문법</span
            >
            <span
              class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded"
              >어휘 제안</span
            >
          </div>
        </div>
      </a>

      <a href="/speechpro-practice" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🎤</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">
            발음 정확도 평가 (SpeechPro)
          </h3>
          <p class="text-gray-600 text-sm mb-4">
            음소 단위 정확도를 채점하고 잘못된 구간을 하이라이트합니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
              >정확도</span
            >
            <span
              class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded"
              >오류 포인트</span
            >
            <span
              class="inline-block bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded"
              >AI 피드백</span
            >
          </div>
        </div>
      </a>

      <a href="/fluency-practice" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🗣️</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">
            유창성 평가 (FluencyPro)
          </h3>
          <p class="text-gray-600 text-sm mb-4">
            발화 리듬·속도·끊김을 측정해 가볍게 말하기 연습을 이어갑니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded"
              >리듬</span
            >
            <span
              class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded"
              >속도</span
            >
            <span
              class="inline-block bg-lime-100 text-lime-800 text-xs px-2 py-1 rounded"
              >코칭</span
            >
          </div>
        </div>
      </a>

      <a href="/word-puzzle" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🧩</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">단어 삭제</h3>
          <p class="text-gray-600 text-sm mb-4">
            불필요한 단어를 지워 자연스러운 문장을 완성하는 퍼즐로 어순을
            익혀요.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded"
              >게임</span
            >
            <span
              class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded"
              >어순</span
            >
            <span
              class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded"
              >A1-B1</span
            >
          </div>
        </div>
      </a>

      <a href="/vocab-garden" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">🌊</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">조사 떠다니기</h3>
          <p class="text-gray-600 text-sm mb-4">
            흐르는 조사 조각을 골라 문장을 완성하며 자연스러운 연결을 익힙니다.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded"
              >조사</span
            >
            <span
              class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded"
              >문장 완성</span
            >
            <span
              class="inline-block bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded"
              >게임</span
            >
          </div>
        </div>
      </a>

      <a href="/daily-expression" class="block">
        <div
          class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border-2 border-transparent hover:border-orange-500"
        >
          <div class="text-4xl mb-4">💬</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">오늘의 표현</h3>
          <p class="text-gray-600 text-sm mb-4">
            매일 하나씩 표현·발음·문화 노트를 확인하고 짧은 연습을 해보세요.
          </p>
          <div class="flex flex-wrap gap-2">
            <span
              class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded"
              >일상 표현</span
            >
            <span
              class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded"
              >문화</span
            >
            <span
              class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
              >데일리</span
            >
          </div>
        </div>
      </a>
    </div>
  </div>

  {% endblock %} {% block extra_js %}
  <script>
    (function () {
      const form = document.getElementById("landingForm");
      const statusEl = document.getElementById("landingStatus");
      if (!form) return;

      function setStatus(msg, ok = true) {
        if (!statusEl) return;
        statusEl.textContent = msg;
        statusEl.className = ok
          ? "text-sm text-emerald-600"
          : "text-sm text-red-600";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(form);

        // Client validation: password match and length
        const pw = fd.get("password") || "";
        const pc = fd.get("password_confirm") || "";
        if (pw !== pc) {
          setStatus("비밀번호가 일치하지 않습니다.", false);
          return;
        }
        if (pw.length < 8) {
          setStatus("비밀번호는 8자 이상이어야 합니다.", false);
          return;
        }

        // Gather checkbox/radio into arrays
        const interests = Array.from(
          form.querySelectorAll('input[name="interests"]:checked')
        ).map((c) => c.value);
        const style =
          (form.querySelector('input[name="style"]:checked') || {}).value || "";

        const payload = {
          email: fd.get("email") || "",
          nickname: fd.get("nickname") || "",
          password: pw,
          native_lang: fd.get("native_lang") || "",
          affiliation: fd.get("affiliation") || "",
          time_pref: fd.get("time_pref") || "",
          interests,
          goal: fd.get("goal") || "",
          exam_level: fd.get("exam_level") || "",
          reason: fd.get("reason") || "",
          style,
        };

        setStatus("가입 중...", true);

        try {
          const res = await fetch("/api/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const error = await res
              .json()
              .catch(() => ({ detail: "가입 실패" }));
            throw new Error(error.detail || "가입에 실패했습니다.");
          }
          const data = await res.json();
          setStatus(
            `✓ ${data.nickname}님 가입을 환영합니다! 이제 로그인해주세요.`
          );
          setTimeout(() => {
            window.location.href = "/login";
          }, 2000);
          form.reset();
        } catch (err) {
          console.error(err);
          setStatus(err.message || "가입 중 오류가 발생했습니다.", false);
        }
      });

      // Check if user is already logged in
      function showToast(message) {
        const toast = document.getElementById("loginToast");
        const text = document.getElementById("loginToastText");
        if (!toast || !text) return;
        text.textContent = message;
        toast.classList.remove("hidden", "opacity-0");
        toast.classList.add("opacity-100");
        setTimeout(() => {
          toast.classList.add("opacity-0");
          setTimeout(() => toast.classList.add("hidden"), 200);
        }, 2000);
      }

      // Guest login handler
      const guestLoginBtn = document.getElementById("guestLoginBtn");
      if (guestLoginBtn) {
        guestLoginBtn.addEventListener("click", async () => {
          try {
            guestLoginBtn.disabled = true;
            guestLoginBtn.innerHTML =
              '<span class="text-2xl">⏳</span><span>로그인 중...</span>';

            // Create random guest nickname
            const guestNumber = Math.floor(Math.random() * 10000);
            const guestNickname = `게스트${guestNumber}`;

            // Log guest login to server
            try {
              await fetch("/api/log/guest-login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  nickname: guestNickname,
                  timestamp: new Date().toISOString(),
                  userAgent: navigator.userAgent,
                  language: navigator.language,
                }),
              });
            } catch (logErr) {
              console.error("Failed to log guest login:", logErr);
            }

            // Store guest info in localStorage
            localStorage.setItem("auth_token", "guest_token_" + Date.now());
            localStorage.setItem("user_nickname", guestNickname);
            localStorage.setItem("user_email", `guest${guestNumber}@onui.ai`);
            localStorage.setItem("is_guest", "true");

            // Force update auth display in header (from base.html)
            if (typeof updateAuthDisplay === "function") {
              updateAuthDisplay();
            }

            // Dispatch custom event for other components
            document.dispatchEvent(new CustomEvent("authStateChanged"));

            showToast(`${guestNickname}님 환영합니다! 바로 학습을 시작하세요!`);

            setTimeout(() => {
              updateSignupSectionVisibility();
              window.scrollTo({ top: 0, behavior: "smooth" });
            }, 1000);
          } catch (err) {
            console.error("Guest login error:", err);
            guestLoginBtn.disabled = false;
            guestLoginBtn.innerHTML =
              '<span class="text-2xl">🎭</span><span>게스트로 바로 시작하기</span>';
            alert("게스트 로그인에 실패했습니다. 다시 시도해주세요.");
          }
        });
      }

      function updateSignupSectionVisibility() {
        const token = localStorage.getItem("auth_token");
        const nickname = localStorage.getItem("user_nickname");
        const signupSection = document.getElementById("signupSection");
        const shouldShowSignup = !(token && nickname);

        if (signupSection)
          signupSection.style.display = shouldShowSignup ? "block" : "none";

        if (!shouldShowSignup && nickname) {
          showToast(`${nickname}님 로그인되었습니다. 학습을 시작하세요!`);
        }
      }

      updateSignupSectionVisibility();
    })();
  </script>
  {% endblock %}
</div>
