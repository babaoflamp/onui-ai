{% extends "base.html" %} {% block title %}ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ - ì˜¤ëˆ„ì´ í•œêµ­ì–´ í•™ìŠµ{%
endblock %} {% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-900">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
    <p class="text-gray-600 mt-2">ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
  </div>

  <!-- Error State (Not logged in) -->
  <div
    id="errorState"
    class="bg-red-50 border border-red-200 rounded-2xl p-6 mb-8"
    style="display: none"
  >
    <p class="text-red-800 font-semibold mb-4">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
    <a
      href="/login"
      class="inline-block text-white bg-red-600 hover:bg-red-700 px-5 py-2 rounded-lg font-medium"
    >
      ë¡œê·¸ì¸í•˜ê¸°
    </a>
  </div>

  <!-- Form Card -->
  <div
    id="formCard"
    class="bg-white rounded-2xl shadow-lg border border-orange-100 p-8"
    style="display: none"
  >
    <form id="changePasswordForm" class="space-y-6">
      <!-- Current Password -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-800">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
        <input
          name="current_password"
          type="password"
          required
          autocomplete="current-password"
          class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-400 focus:border-transparent outline-none transition"
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        />
        <p class="text-xs text-gray-500 mt-1">
          ê³„ì • ë³´ì•ˆì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
        </p>
      </div>

      <!-- New Password -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-800">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input
          name="new_password"
          type="password"
          required
          autocomplete="new-password"
          class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-400 focus:border-transparent outline-none transition"
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        />
        <p class="text-xs text-gray-500 mt-1">
          8ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”
        </p>
      </div>

      <!-- Confirm Password -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-800"
          >ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label
        >
        <input
          name="confirm_password"
          type="password"
          required
          autocomplete="new-password"
          class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-400 focus:border-transparent outline-none transition"
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        />
        <p class="text-xs text-gray-500 mt-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”</p>
      </div>

      <!-- Status Message -->
      <div
        id="changeStatus"
        class="text-sm text-gray-600 text-center min-h-6"
      ></div>

      <!-- Buttons -->
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-4 border-t border-gray-200"
      >
        <a
          href="/mypage"
          class="text-orange-600 hover:text-orange-700 font-medium text-center sm:text-left"
        >
          â† í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
        </a>
        <button
          type="submit"
          class="px-6 py-3 rounded-lg bg-gradient-to-r from-orange-500 to-pink-500 text-white font-semibold hover:from-orange-600 hover:to-pink-600 transition-all"
        >
          ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        </button>
      </div>
    </form>

    <!-- Password Requirements -->
    <div class="mt-8 pt-6 border-t border-gray-200">
      <h3 class="text-sm font-semibold text-gray-900 mb-3">
        ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ìš”êµ¬ì‚¬í•­
      </h3>
      <ul class="space-y-2 text-sm text-gray-600">
        <li class="flex items-start gap-2">
          <span class="text-emerald-500 font-bold flex-shrink-0">âœ“</span>
          <span>ìµœì†Œ 8ì ì´ìƒ</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-emerald-500 font-bold flex-shrink-0">âœ“</span>
          <span>ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¬ë¼ì•¼ í•¨</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-emerald-500 font-bold flex-shrink-0">âœ“</span>
          <span>PBKDF2ë¡œ ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë¨</span>
        </li>
      </ul>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  (function () {
    const token = localStorage.getItem("auth_token");
    const formCard = document.getElementById("formCard");
    const errorState = document.getElementById("errorState");

    // Check auth
    if (!token) {
      errorState.style.display = "block";
      return;
    }

    formCard.style.display = "block";

    const form = document.getElementById("changePasswordForm");
    const statusEl = document.getElementById("changeStatus");

    function setStatus(msg, ok = true) {
      statusEl.textContent = msg;
      statusEl.className = ok
        ? "text-sm text-emerald-600 font-medium text-center min-h-6"
        : "text-sm text-red-600 font-medium text-center min-h-6";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      const currentPassword = fd.get("current_password") || "";
      const newPassword = fd.get("new_password") || "";
      const confirmPassword = fd.get("confirm_password") || "";

      // Client-side validation
      if (newPassword !== confirmPassword) {
        setStatus("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", false);
        return;
      }

      if (newPassword.length < 8) {
        setStatus("ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.", false);
        return;
      }

      if (currentPassword === newPassword) {
        setStatus("ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.", false);
        return;
      }

      setStatus("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘...", true);

      try {
        const res = await fetch("/api/user/password/change", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword,
          }),
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ detail: "ë³€ê²½ ì‹¤íŒ¨" }));
          throw new Error(error.detail || "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

        setStatus("âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
        form.reset();

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = "/mypage";
        }, 2000);
      } catch (err) {
        console.error(err);
        setStatus(err.message || "ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", false);
      }
    });
  })();
</script>
{% endblock %}
