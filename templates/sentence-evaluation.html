{% extends "base.html" %} {% block title %}ë¬¸ì¥ í‰ê°€ - ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock
%} {% block extra_css %}
<link rel="stylesheet" href="/static/css/pronunciation-practice.css" />
{% endblock %} {% block content %}
<div class="max-w-6xl mx-auto px-4">
  <div class="bg-white rounded-2xl p-6 shadow-lg">
    <!-- Header -->
    <header class="mb-6">
      <div
        class="inline-flex items-center gap-2 px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold mb-2"
      >
        <span class="w-2 h-2 bg-orange-500 rounded-full"></span>
        ONUI Â· ë¬¸ì¥ í‰ê°€
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">ë¬¸ì¥ í‰ê°€ ğŸ“–</h1>
      <p class="text-sm text-gray-600">
        í•œêµ­ì–´ ë¬¸ì¥ì„ ì½ê³  ë°œìŒì„ í‰ê°€ë°›ì•„ë³´ì„¸ìš”
      </p>
    </header>

    <!-- Back to pronunciation practice link -->
    <div class="mb-6">
      <a
        href="/pronunciation-practice"
        class="text-sm text-blue-600 hover:text-blue-800 font-medium"
      >
        â† ë°œìŒ ì—°ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°
      </a>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-2xl p-6 shadow-lg">
      <!-- ë¬¸ì¥ ì„ íƒ ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-gray-900 mb-3">
          ğŸ“š í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥
        </label>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <select
            id="sentence-select"
            onchange="selectSentence()"
            class="flex-1 px-4 py-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          >
            <option value="">-- ë¬¸ì¥ ì„ íƒ --</option>
          </select>
          <button
            onclick="loadSentencesData()"
            class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <!-- ì§ì ‘ ì…ë ¥ ì„¹ì…˜ -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2"
            >ë˜ëŠ” ì§ì ‘ ì…ë ¥í•˜ê¸°</label
          >
          <div class="flex gap-2">
            <input
              type="text"
              id="custom-sentence"
              placeholder="í‰ê°€í•  ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”..."
              class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              onkeydown="if (event.key === 'Enter') { setCustomSentence(); }"
            />
            <button
              onclick="setCustomSentence()"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium"
            >
              ì„¤ì •
            </button>
          </div>
        </div>
      </div>

      <!-- ì„ íƒëœ ë¬¸ì¥ í‘œì‹œ -->
      <div
        class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200"
      >
        <label class="block text-sm font-semibold text-gray-700 mb-3"
          >ì„ íƒëœ ë¬¸ì¥</label
        >
        <div
          id="selectedSentenceDisplay"
          class="text-2xl font-bold text-gray-900"
        >
          ë¬¸ì¥ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”
        </div>
      </div>

      <!-- ë…¹ìŒ ì„¹ì…˜ -->
      <div
        class="mb-8 p-6 bg-gradient-to-r from-pink-50 to-red-50 rounded-xl border-2 border-red-200"
      >
        <label class="block text-lg font-semibold text-gray-900 mb-4"
          >ğŸ¤ ë…¹ìŒ ë° í‰ê°€</label
        >
        <div class="flex gap-3 flex-wrap">
          <button
            id="startRecordingBtn"
            onclick="startSentenceRecording()"
            class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-lg hover:from-pink-600 hover:to-red-600 transition font-medium shadow-md"
          >
            <span>ğŸ¤</span>
            ë…¹ìŒ ì‹œì‘
          </button>
          <button
            id="stopRecordingBtn"
            onclick="stopSentenceRecording()"
            disabled
            class="flex items-center gap-2 px-6 py-3 bg-gray-300 text-gray-700 rounded-lg opacity-50 cursor-not-allowed font-medium"
          >
            <span>â¹ï¸</span>
            ì •ì§€ ë° í‰ê°€
          </button>
        </div>
        <div id="recordingStatus" class="mt-4 text-sm text-gray-600"></div>
      </div>

      <!-- í‰ê°€ ê²°ê³¼ -->
      <div id="evaluationResult" class="hidden"></div>
    </div>
  </div>
</div>

<!-- SpeechPro ê²°ê³¼ ëª¨ë‹¬ -->
<div
  id="speechpro-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
>
  <div
    class="relative w-full max-w-3xl max-h-[90vh] overflow-y-auto bg-white rounded-2xl shadow-2xl p-8"
  >
    <button
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl"
      onclick="closeSpeechProModal()"
      aria-label="ë‹«ê¸°"
    >
      âœ•
    </button>

    <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š ë°œìŒ í‰ê°€ ê²°ê³¼</h2>

    <!-- ì ìˆ˜ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow p-6 mb-6">
      <!-- ì „ì²´ ì ìˆ˜ -->
      <div class="mb-6">
        <div class="text-center">
          <div class="text-6xl font-bold text-blue-600 mb-2">
            <span id="sp-overall-score">0</span>/100
          </div>
          <p
            id="sp-score-feedback"
            class="text-lg text-gray-600 font-semibold"
          ></p>
        </div>

        <!-- ì ìˆ˜ ê²Œì´ì§€ -->
        <div class="mt-6">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div
              id="sp-score-bar"
              class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full transition-all duration-500"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- ìƒì„¸ ì •ë³´ -->
      <div class="border-t pt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">ìƒì„¸ ë¶„ì„</h3>
        <div id="sp-details-content" class="space-y-3 text-gray-700">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
    </div>

    <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
    <div
      id="sp-ai-feedback-section"
      class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-6 hidden"
    >
      <h3 class="text-lg font-semibold text-blue-900 mb-3">
        ğŸ¤– AI ê°œì„  í”¼ë“œë°±
      </h3>
      <div
        id="sp-ai-feedback-content"
        class="text-blue-800 whitespace-pre-wrap"
      >
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>

    <div class="flex justify-end gap-3">
      <button
        onclick="closeSpeechProModal()"
        class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
      >
        ë‹«ê¸°
      </button>
    </div>
  </div>
</div>

<script src="/static/js/pronunciation-practice.js"></script>
<script>
  // ì´ˆê¸°í™”
  console.log("Sentence evaluation page loaded");

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM loaded for sentence evaluation");
    loadSentencesData();
  });

  // ë¬¸ì¥ ì„ íƒ
  function selectSentence() {
    const select = document.getElementById("sentence-select");
    const selected = select.options[select.selectedIndex];
    const sentence = selected.value;

    if (sentence) {
      document.getElementById("selectedSentenceDisplay").textContent = sentence;
      document.getElementById("custom-sentence").value = ""; // ì§ì ‘ ì…ë ¥ ì¹¸ ì´ˆê¸°í™”
    }
  }

  // ì§ì ‘ ì…ë ¥ ë¬¸ì¥ ì„¤ì •
  function setCustomSentence() {
    const input = document.getElementById("custom-sentence");
    const sentence = input.value.trim();

    if (!sentence) {
      alert("ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    document.getElementById("selectedSentenceDisplay").textContent = sentence;
    document.getElementById("sentence-select").selectedIndex = 0; // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
  }

  // ë…¹ìŒ ì‹œì‘
  let mediaRecorder;
  let audioChunks = [];
  let mediaStream = null;

  async function startSentenceRecording() {
    const sentenceText = document.getElementById(
      "selectedSentenceDisplay"
    ).textContent;

    if (sentenceText === "ë¬¸ì¥ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”") {
      alert("ë¨¼ì € í‰ê°€í•  ë¬¸ì¥ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.start();

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("startRecordingBtn").disabled = true;
      document
        .getElementById("startRecordingBtn")
        .classList.add("opacity-50", "cursor-not-allowed");
      document.getElementById("stopRecordingBtn").disabled = false;
      document
        .getElementById("stopRecordingBtn")
        .classList.remove("opacity-50", "cursor-not-allowed", "bg-gray-300");
      document
        .getElementById("stopRecordingBtn")
        .classList.add("bg-gradient-to-r", "from-red-500", "to-red-600");

      document.getElementById("recordingStatus").innerHTML =
        '<div class="flex items-center gap-2"><div class="animate-pulse">ğŸ”´</div> ë…¹ìŒ ì¤‘...</div>';
      document.getElementById("evaluationResult").classList.add("hidden");

      console.log("Recording started");
    } catch (error) {
      console.error("ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:", error);
      alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  }

  // ë…¹ìŒ ì¤‘ì§€ ë° í‰ê°€
  async function stopSentenceRecording() {
    const sentenceText = document.getElementById(
      "selectedSentenceDisplay"
    ).textContent;

    try {
      mediaRecorder.stop();

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("startRecordingBtn").disabled = false;
      document
        .getElementById("startRecordingBtn")
        .classList.remove("opacity-50", "cursor-not-allowed");
      document.getElementById("stopRecordingBtn").disabled = true;
      document
        .getElementById("stopRecordingBtn")
        .classList.add("opacity-50", "cursor-not-allowed", "bg-gray-300");
      document
        .getElementById("stopRecordingBtn")
        .classList.remove("bg-gradient-to-r", "from-red-500", "to-red-600");

      mediaRecorder.onstop = async () => {
        // Stop all tracks
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }

        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.wav");
        formData.append("text", sentenceText);

        document.getElementById("recordingStatus").innerHTML =
          '<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-red-600"></div><span>SpeechPro APIë¡œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span></div>';

        try {
          const res = await fetch("/api/speechpro/evaluate", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          console.log("Evaluation result:", data);

          if (data.error) {
            document.getElementById("recordingStatus").innerHTML = `
              <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-700 font-semibold text-sm">âš ï¸ ì˜¤ë¥˜</p>
                <p class="text-red-600 text-xs mt-1">${data.error}</p>
              </div>
            `;
          } else {
            // Show modal with results
            showSpeechProModal(data, sentenceText);
            document.getElementById("recordingStatus").innerHTML =
              '<p class="text-green-600 font-semibold">âœ… í‰ê°€ ì™„ë£Œ!</p>';
          }
        } catch (error) {
          console.error("í‰ê°€ ì˜¤ë¥˜:", error);
          document.getElementById("recordingStatus").innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-red-700 font-semibold text-sm">âš ï¸ ì˜¤ë¥˜</p>
              <p class="text-red-600 text-xs mt-1">í‰ê°€ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            </div>
          `;
        }
      };
    } catch (error) {
      console.error("ë…¹ìŒ ì¤‘ì§€ ì˜¤ë¥˜:", error);
      alert("ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // SpeechPro ëª¨ë‹¬ í‘œì‹œ
  function showSpeechProModal(data, targetText) {
    const modal = document.getElementById("speechpro-modal");
    const score = data.score || 0;

    // Update score
    document.getElementById("sp-overall-score").textContent = score;
    document.getElementById("sp-score-bar").style.width = score + "%";

    // Score feedback
    let feedback = "";
    if (score >= 90) feedback = "ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤!";
    else if (score >= 80) feedback = "ğŸ‘ ì•„ì£¼ ì¢‹ì•„ìš”!";
    else if (score >= 70) feedback = "ğŸ˜Š ì˜í•˜ê³  ìˆì–´ìš”!";
    else if (score >= 60) feedback = "ğŸ’ª ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•´ìš”!";
    else feedback = "ğŸ“š ì—°ìŠµì´ í•„ìš”í•´ìš”!";
    document.getElementById("sp-score-feedback").textContent = feedback;

    // Details content
    let detailsHtml = "";

    if (data.fluency !== undefined) {
      detailsHtml += `<div class="flex justify-between"><span>ğŸ¯ ìœ ì°½ì„±:</span><span class="font-semibold">${data.fluency}%</span></div>`;
    }

    if (data.sentence_scores && data.sentence_scores.length > 0) {
      detailsHtml += `<div class="mt-4"><p class="font-semibold mb-2">ë¬¸ì¥ë³„ ì ìˆ˜:</p>`;
      data.sentence_scores.forEach((s, idx) => {
        const barWidth = Math.round(s);
        detailsHtml += `
          <div class="mb-2">
            <div class="flex justify-between text-sm mb-1">
              <span>ë¬¸ì¥ ${idx + 1}</span>
              <span class="font-semibold">${s}ì </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full" style="width: ${barWidth}%"></div>
            </div>
          </div>
        `;
      });
      detailsHtml += `</div>`;
    }

    if (data.words && data.words.length > 0) {
      detailsHtml += `<div class="mt-4"><p class="font-semibold mb-2">ë‹¨ì–´ë³„ ë¶„ì„:</p><div class="space-y-2">`;
      data.words.forEach((word) => {
        if (word.text && word.text !== "!SIL") {
          detailsHtml += `<div class="text-sm"><span class="font-medium">${
            word.text
          }:</span> <span class="text-blue-600">${Math.round(
            word.score || 0
          )}ì </span></div>`;
        }
      });
      detailsHtml += `</div></div>`;
    }

    document.getElementById("sp-details-content").innerHTML =
      detailsHtml || "<p class='text-gray-500'>ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";

    // AI Feedback
    if (data.ai_feedback) {
      document
        .getElementById("sp-ai-feedback-section")
        .classList.remove("hidden");
      document.getElementById("sp-ai-feedback-content").textContent =
        data.ai_feedback;
    } else {
      document.getElementById("sp-ai-feedback-section").classList.add("hidden");
    }

    // Show modal
    modal.classList.remove("hidden");
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeSpeechProModal() {
    document.getElementById("speechpro-modal").classList.add("hidden");
  }

  // ë¬¸ì¥ ë°ì´í„° ë¡œë“œ (pronunciation-practice.jsì—ì„œ ì¬ì‚¬ìš©)
  async function loadSentencesData() {
    console.log("loadSentencesData() called");
    const select = document.getElementById("sentence-select");

    try {
      const response = await fetch("/api/speechpro/sentences");
      console.log("Response status:", response.status);

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      console.log("Sentences loaded:", data);

      // Clear existing options (except first)
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Add sentences
      if (data.sentences && Array.isArray(data.sentences)) {
        data.sentences.forEach((sentence) => {
          const option = document.createElement("option");
          option.value = sentence;
          option.textContent = sentence;
          select.appendChild(option);
        });
        console.log(`Added ${data.sentences.length} sentences to dropdown`);
      }
    } catch (error) {
      console.error("Failed to load sentences:", error);
      select.innerHTML = '<option value="">ë¬¸ì¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
    }
  }
</script>
{% endblock %}
