{% extends "base.html" %} {% block title %}ìœ ì°½ì„± í‰ê°€ - ì˜¤ëˆ„ì´ AI{% endblock %}
{% block content %}
<div
  class="min-h-screen bg-gradient-to-br from-[var(--bg1)] via-white to-[var(--bg2)] p-6"
>
  <div class="max-w-4xl mx-auto">
    <!-- í—¤ë” -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-[var(--text-main)] mb-2">
        ğŸ—£ï¸ ìœ ì°½ì„± í‰ê°€
      </h1>
      <p class="text-[var(--text-sub)] text-lg">
        ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë°œí™”ë¥¼ í‰ê°€ë°›ê³  ê°œì„ í•´ë³´ì„¸ìš”
      </p>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
      <!-- í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-3">
          ğŸ“š í‰ê°€í•  ë¬¸ì¥ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥
        </label>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <input
            type="text"
            id="fluency-evaluation-text"
            placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ë„¤ìš”"
            class="flex-1 px-4 py-3 border-2 border-[var(--accent)] rounded-lg focus:outline-none focus:border-[var(--accent)] transition"
            value="ì•ˆë…•í•˜ì„¸ìš”"
          />
        </div>
      </div>

      <!-- ë ˆì½”ë”© ì„¹ì…˜ -->
      <div class="mb-8">
        <label class="block text-lg font-semibold text-[var(--text-main)] mb-4">
          ğŸ™ï¸ ìŒì„± ë…¹ìŒ
        </label>

        <div
          class="border-2 border-dashed border-[var(--accent)] rounded-lg p-8 text-center bg-gray-50"
        >
          <div id="fluency-recording-status" class="mb-4">
            <p class="text-gray-600 text-sm">ë§ˆì´í¬ë¥¼ í†µí•´ ë¬¸ì¥ì„ ì½ì–´ì£¼ì„¸ìš”</p>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 justify-center mb-4">
            <button
              id="fluency-record-btn"
              onclick="toggleFluencyRecording()"
              class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition flex-1 sm:flex-none"
            >
              ğŸ™ï¸ ë…¹ìŒ ì‹œì‘
            </button>
            <button
              id="fluency-play-btn"
              onclick="playFluencyRecording()"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition flex-1 sm:flex-none disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              â–¶ï¸ ì¬ìƒ
            </button>
            <button
              onclick="clearFluencyRecording()"
              class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold hover:bg-gray-500 transition flex-1 sm:flex-none"
            >
              ğŸ—‘ï¸ ì´ˆê¸°í™”
            </button>
          </div>
        </div>
      </div>

      <!-- í‰ê°€ ë²„íŠ¼ -->
      <div class="flex flex-col sm:flex-row gap-4 mb-8">
        <button
          onclick="evaluateFluency()"
          class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold text-lg hover:shadow-lg transition"
        >
          ğŸ“Š ìœ ì°½ì„± í‰ê°€í•˜ê¸°
        </button>
      </div>

      <!-- ê²°ê³¼ ì„¹ì…˜ -->
      <div id="fluency-results" class="hidden">
        <div
          class="mb-8 p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500"
        >
          <h3 class="text-2xl font-bold text-blue-900 mb-4">ğŸ“Š í‰ê°€ ê²°ê³¼</h3>

          <!-- í•µì‹¬ ì ìˆ˜ -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg">
              <div class="text-sm text-gray-600">ìœ ì°½ì„± ì ìˆ˜</div>
              <div class="text-3xl font-bold text-blue-600" id="fluency-score">
                0
              </div>
              <div class="text-xs text-gray-500 mt-1">/ 100</div>
            </div>
            <div class="bg-white p-4 rounded-lg">
              <div class="text-sm text-gray-600">ì‹ ë¢°ë„</div>
              <div
                class="text-3xl font-bold text-green-600"
                id="fluency-confidence"
              >
                0%
              </div>
            </div>
          </div>

          <!-- ìƒì„¸ ì§€í‘œ -->
          <div class="bg-white p-4 rounded-lg mb-4">
            <h4 class="font-semibold text-gray-800 mb-3">ğŸ“ˆ ìƒì„¸ ì§€í‘œ</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">ë°œí™” ì†ë„</span>
                <span
                  class="font-semibold text-gray-900"
                  id="fluency-speech-rate"
                  >0 ìŒì ˆ/ì´ˆ</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ì¡°ìŒ ì†ë„</span>
                <span
                  class="font-semibold text-gray-900"
                  id="fluency-articulation"
                  >0 ìŒì ˆ/ì´ˆ</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ì •í™•í•œ ìŒì ˆ ë¹„ìœ¨</span>
                <span
                  class="font-semibold text-gray-900"
                  id="fluency-correct-syllables"
                  >0%</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ì‰¼í‘œ ê°œìˆ˜</span>
                <span
                  class="font-semibold text-gray-900"
                  id="fluency-pause-count"
                  >0</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ì˜¤ë””ì˜¤ ê¸¸ì´</span>
                <span
                  class="font-semibold text-gray-900"
                  id="fluency-audio-length"
                  >0ì´ˆ</span
                >
              </div>
            </div>
          </div>

          <!-- ê°œì„  ê¶Œì¥ì‚¬í•­ -->
          <div class="bg-white p-4 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-3">ğŸ’¡ ê°œì„  ê¶Œì¥ì‚¬í•­</h4>
            <ul id="fluency-recommendations" class="space-y-2">
              <li class="text-sm text-gray-600">
                â€¢ ìŒì ˆì„ ë” ëª…í™•í•˜ê²Œ ë°œìŒí•´ì£¼ì„¸ìš”.
              </li>
              <li class="text-sm text-gray-600">
                â€¢ ìì—°ìŠ¤ëŸ¬ìš´ ì†ë„ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.
              </li>
              <li class="text-sm text-gray-600">â€¢ ì ì ˆí•œ ì‰¼í‘œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- ì •ë³´ ì„¹ì…˜ -->
      <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
        <h4 class="font-semibold text-blue-900 mb-2">â„¹ï¸ ìœ ì°½ì„± í‰ê°€ë€?</h4>
        <ul class="space-y-1 text-sm text-blue-800">
          <li>â€¢ <strong>ë°œí™” ì†ë„</strong>: 1ì´ˆë‹¹ ë°œìŒí•˜ëŠ” ìŒì ˆ ê°œìˆ˜</li>
          <li>â€¢ <strong>ì¡°ìŒ ì†ë„</strong>: ì‹¤ì œ ë°œìŒí•˜ëŠ” ì†ë„</li>
          <li>
            â€¢ <strong>ì •í™•í•œ ìŒì ˆ ë¹„ìœ¨</strong>: ì˜¬ë°”ë¥´ê²Œ ë°œìŒí•œ ìŒì ˆì˜ ë¹„ìœ¨
          </li>
          <li>â€¢ <strong>ì‰¼í‘œ ë¶„í¬</strong>: ìì—°ìŠ¤ëŸ¬ìš´ í˜¸í¡ íŒ¨í„´</li>
          <li>â€¢ <strong>ìœ ì°½ì„± ì ìˆ˜</strong>: ì „ë°˜ì ì¸ ë°œí™” ìì—°ìŠ¤ëŸ¬ì›€ ì ìˆ˜</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  let fluencyRecorder = null;
  let fluencyAudioBlob = null;
  let fluencyAudioContext = null;

  function toggleFluencyRecording() {
    const btn = document.getElementById("fluency-record-btn");
    const statusDiv = document.getElementById("fluency-recording-status");
    const playBtn = document.getElementById("fluency-play-btn");

    if (!fluencyRecorder) {
      // Start recording
      navigator.mediaDevices
        .getUserMedia({ audio: true })
        .then((stream) => {
          fluencyRecorder = new MediaRecorder(stream);
          const audioChunks = [];

          fluencyRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          fluencyRecorder.onstop = () => {
            fluencyAudioBlob = new Blob(audioChunks, { type: "audio/wav" });
            statusDiv.innerHTML =
              "âœ“ ë…¹ìŒ ì™„ë£Œ (" +
              (fluencyAudioBlob.size / 1024).toFixed(1) +
              " KB)";
            playBtn.disabled = false;
            btn.textContent = "ğŸ™ï¸ ë…¹ìŒ ë‹¤ì‹œ";
            fluencyRecorder = null;
          };

          fluencyRecorder.start();
          btn.textContent = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
          statusDiv.innerHTML = "âºï¸ ë…¹ìŒ ì¤‘...";
        })
        .catch((error) => {
          statusDiv.innerHTML =
            "ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: " + error.message;
        });
    } else {
      // Stop recording
      fluencyRecorder.stop();
    }
  }

  function playFluencyRecording() {
    if (!fluencyAudioBlob) {
      alert("ë…¹ìŒëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const audioUrl = URL.createObjectURL(fluencyAudioBlob);
    const audio = new Audio(audioUrl);
    audio.play();
  }

  function clearFluencyRecording() {
    fluencyAudioBlob = null;
    fluencyRecorder = null;
    const btn = document.getElementById("fluency-record-btn");
    const playBtn = document.getElementById("fluency-play-btn");
    const statusDiv = document.getElementById("fluency-recording-status");

    btn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì‹œì‘";
    playBtn.disabled = true;
    statusDiv.innerHTML = "ë§ˆì´í¬ë¥¼ í†µí•´ ë¬¸ì¥ì„ ì½ì–´ì£¼ì„¸ìš”";
  }

  async function evaluateFluency() {
    const textInput = document.getElementById("fluency-evaluation-text").value;
    const resultsDiv = document.getElementById("fluency-results");

    if (!textInput) {
      alert("í‰ê°€í•  ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    if (!fluencyAudioBlob) {
      alert("ìŒì„±ì„ ë…¹ìŒí•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("text", textInput);
      formData.append("audio", fluencyAudioBlob, "fluency.wav");

      const response = await fetch("/api/fluencypro/analyze", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();

      // ê²°ê³¼ í‘œì‹œ
      document.getElementById("fluency-score").textContent = Math.round(
        data.fluency_score || 0
      );
      document.getElementById("fluency-confidence").textContent =
        Math.round((data.confidence || 0.85) * 100) + "%";
      document.getElementById("fluency-speech-rate").textContent =
        (data.speech_rate || 0).toFixed(2) + " ìŒì ˆ/ì´ˆ";
      document.getElementById("fluency-articulation").textContent =
        (data.articulation_rate || 0).toFixed(2) + " ìŒì ˆ/ì´ˆ";
      document.getElementById("fluency-correct-syllables").textContent =
        (data.correct_syllables_rate || 0).toFixed(1) + "%";
      document.getElementById("fluency-pause-count").textContent =
        data.pause_count || 0;
      document.getElementById("fluency-audio-length").textContent =
        (data.audio_length_ms / 1000 || 0).toFixed(1) + "ì´ˆ";

      // ê°œì„  ê¶Œì¥ì‚¬í•­ í‘œì‹œ
      const recommendationsDiv = document.getElementById(
        "fluency-recommendations"
      );
      recommendationsDiv.innerHTML = "";
      if (data.recommendations && data.recommendations.length > 0) {
        data.recommendations.forEach((rec) => {
          const li = document.createElement("li");
          li.className = "text-sm text-gray-600";
          li.textContent = "â€¢ " + rec;
          recommendationsDiv.appendChild(li);
        });
      }

      resultsDiv.classList.remove("hidden");

      // í•™ìŠµ ì§„ë„ ê¸°ë¡
      recordFluencyProgress(Math.round(data.fluency_score || 0));
    } catch (error) {
      alert("í‰ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  async function recordFluencyProgress(score) {
    try {
      const userId = localStorage.getItem("user_nickname") || "anonymous";

      const response = await fetch("/api/learning/pronunciation-completed", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          user_id: userId,
          score: score,
        }),
      });

      const data = await response.json();
      console.log("í•™ìŠµ ì§„ë„ ê¸°ë¡ë¨:", data);
    } catch (error) {
      console.error("í•™ìŠµ ì§„ë„ ê¸°ë¡ ì‹¤íŒ¨:", error);
    }
  }
</script>
{% endblock %}
