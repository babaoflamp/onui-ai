{% extends "base.html" %}

{% block title %}ì „ë˜ë™í™” ì½ê¸° - ì˜¤ëˆ„ì´ í•œêµ­ì–´{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <div class="bg-white rounded-2xl p-6 shadow-lg">
    <!-- Header -->
    <header class="mb-6">
      <div
        class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold mb-2"
      >
        <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
        ONUI Â· ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <span class="text-2xl">ğŸ“–</span>
        ì „ë˜ë™í™” ì½ê¸°
      </h1>
      <p class="text-sm text-gray-600">
        í•œêµ­ì˜ ì „ë˜ë™í™”ë¥¼ ì½ê³  ì´í•´ë„ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”
      </p>
    </header>

    <!-- Level Selection -->
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        ë‚œì´ë„ ì„ íƒ
      </label>
      <div class="flex gap-2 flex-wrap">
        <button
          class="level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-purple-500 text-white"
          data-level="all"
        >
          ì „ì²´
        </button>
        <button
          class="level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
          data-level="A1"
        >
          A1 (ì´ˆê¸‰)
        </button>
        <button
          class="level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
          data-level="A2"
        >
          A2
        </button>
        <button
          class="level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
          data-level="B1"
        >
          B1 (ì¤‘ê¸‰)
        </button>
        <button
          class="level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
          data-level="B2"
        >
          B2
        </button>
      </div>
    </div>

    <!-- Folktale List -->
    <div id="folktaleList" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <!-- Will be populated by JavaScript -->
    </div>

    <!-- Reading Section (hidden initially) -->
    <div id="readingSection" class="hidden">
      <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 mb-6">
        <button
          id="backBtn"
          class="text-purple-600 hover:text-purple-700 text-sm mb-4 flex items-center gap-1"
        >
          â† ëª©ë¡ìœ¼ë¡œ
        </button>
        <h2
          id="storyTitle"
          class="text-2xl font-bold text-gray-900 mb-2"
        ></h2>
        <p id="storyTitleEn" class="text-sm text-gray-500 mb-4"></p>
        <div class="mb-4">
          <span
            id="storyLevel"
            class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold"
          ></span>
        </div>
        <p id="storySummary" class="text-sm text-gray-600 mb-6 italic"></p>

        <!-- Story Content -->
        <div class="bg-white rounded-lg p-6 mb-6 border border-gray-200">
          <p id="storyContent" class="text-base leading-relaxed"></p>
        </div>

        <!-- Vocabulary -->
        <div class="mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-3">
            ğŸ“š ì£¼ìš” ì–´íœ˜
          </h3>
          <div
            id="vocabularyList"
            class="grid grid-cols-2 md:grid-cols-3 gap-3"
          ></div>
        </div>

        <!-- Moral Lesson -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
          <h3 class="text-sm font-bold text-yellow-800 mb-2">ğŸ’¡ êµí›ˆ</h3>
          <p id="moralLesson" class="text-sm text-yellow-900"></p>
        </div>

        <!-- Comprehension Quiz -->
        <div class="mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">
            âœ… ì´í•´ë„ í™•ì¸ í€´ì¦ˆ
          </h3>
          <div id="quizContainer"></div>
        </div>

        <!-- Submit Button -->
        <button
          id="submitQuiz"
          class="w-full bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors"
        >
          ì •ë‹µ í™•ì¸í•˜ê¸°
        </button>

        <!-- Result -->
        <div
          id="quizResult"
          class="hidden mt-6 p-4 rounded-lg text-center"
        ></div>
      </div>
    </div>

    <!-- Tips Section -->
    <div class="bg-gray-50 border border-gray-200 rounded-xl p-5">
      <h3 class="text-sm font-bold text-gray-800 mb-3">ğŸ’¡ í•™ìŠµ íŒ</h3>
      <ul class="space-y-2 text-sm text-gray-700">
        <li class="flex items-start gap-2">
          <span class="text-purple-500 mt-0.5">â€¢</span>
          <span
            >ë¨¼ì € ì „ì²´ ì´ì•¼ê¸°ë¥¼ ì½ê³ , ëª¨ë¥´ëŠ” ë‹¨ì–´ëŠ” ì–´íœ˜ ëª©ë¡ì„
            ì°¸ê³ í•˜ì„¸ìš”</span
          >
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-500 mt-0.5">â€¢</span>
          <span>ì´ì•¼ê¸°ì˜ êµí›ˆì„ ìƒê°í•˜ë©° ì½ìœ¼ë©´ ë‚´ìš© ì´í•´ì— ë„ì›€ì´ ë©ë‹ˆë‹¤</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-500 mt-0.5">â€¢</span>
          <span
            >í€´ì¦ˆë¥¼ í†µí•´ ì´ì•¼ê¸°ë¥¼ ì œëŒ€ë¡œ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”</span
          >
        </li>
      </ul>
    </div>
  </div>
</div>

<script>
  (function () {
    // DOM elements
    const folktaleList = document.getElementById("folktaleList");
    const readingSection = document.getElementById("readingSection");
    const backBtn = document.getElementById("backBtn");
    const levelBtns = document.querySelectorAll(".level-btn");
    const submitQuiz = document.getElementById("submitQuiz");

    // State
    let folktales = [];
    let currentLevel = "all";
    let currentFolktale = null;
    let userAnswers = {};

    // Initialize
    async function init() {
      await loadFolktales();
      renderFolktaleList();
      setupEventListeners();
    }

    // Load folktales from API
    async function loadFolktales(level = null) {
      try {
        const url = level ? `/api/folktales?level=${level}` : "/api/folktales";
        const response = await fetch(url);
        const data = await response.json();
        folktales = data.folktales || [];
      } catch (error) {
        console.error("Failed to load folktales:", error);
        folktales = [];
      }
    }

    // Render folktale cards
    function renderFolktaleList() {
      if (folktales.length === 0) {
        folktaleList.innerHTML = `
          <div class="col-span-2 text-center py-12 text-gray-500">
            í•´ë‹¹ ë ˆë²¨ì˜ ì „ë˜ë™í™”ê°€ ì—†ìŠµë‹ˆë‹¤
          </div>
        `;
        return;
      }

      folktaleList.innerHTML = folktales
        .map(
          (folktale) => `
        <div class="folktale-card bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-5 cursor-pointer hover:shadow-lg transition-shadow" data-id="${folktale.id}">
          <div class="flex items-start justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-900">${folktale.title}</h3>
            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${folktale.level}</span>
          </div>
          <p class="text-sm text-gray-600 mb-3">${folktale.titleEn}</p>
          <p class="text-sm text-gray-700 line-clamp-2">${folktale.summary}</p>
        </div>
      `
        )
        .join("");

      // Add click listeners
      document.querySelectorAll(".folktale-card").forEach((card) => {
        card.addEventListener("click", () => {
          const id = parseInt(card.dataset.id);
          showFolktale(id);
        });
      });
    }

    // Show selected folktale
    function showFolktale(id) {
      currentFolktale = folktales.find((f) => f.id === id);
      if (!currentFolktale) return;

      // Populate content
      document.getElementById("storyTitle").textContent =
        currentFolktale.title;
      document.getElementById("storyTitleEn").textContent =
        currentFolktale.titleEn;
      document.getElementById("storyLevel").textContent =
        currentFolktale.level;
      document.getElementById("storySummary").textContent =
        currentFolktale.summary;
      document.getElementById("storyContent").textContent =
        currentFolktale.story;
      document.getElementById("moralLesson").textContent =
        currentFolktale.moralLesson;

      // Render vocabulary
      const vocabularyList = document.getElementById("vocabularyList");
      vocabularyList.innerHTML = currentFolktale.vocabulary
        .map(
          (vocab) => `
        <div class="bg-white border border-gray-200 rounded-lg p-3">
          <div class="font-bold text-gray-900 text-sm">${vocab.word}</div>
          <div class="text-xs text-gray-600">${vocab.meaning}</div>
        </div>
      `
        )
        .join("");

      // Render quiz
      renderQuiz();

      // Show reading section
      folktaleList.parentElement.classList.add("hidden");
      readingSection.classList.remove("hidden");
      document.getElementById("quizResult").classList.add("hidden");
      userAnswers = {};
    }

    // Render comprehension quiz
    function renderQuiz() {
      const quizContainer = document.getElementById("quizContainer");
      quizContainer.innerHTML = currentFolktale.questions
        .map(
          (q, qIndex) => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
          <p class="font-semibold text-gray-900 mb-3">${qIndex + 1}. ${
            q.question
          }</p>
          <div class="space-y-2">
            ${q.choices
              .map(
                (choice, cIndex) => `
              <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                <input type="radio" name="q${qIndex}" value="${cIndex}" class="mt-1">
                <span class="text-sm text-gray-700">${choice}</span>
              </label>
            `
              )
              .join("")}
          </div>
        </div>
      `
        )
        .join("");

      // Add change listeners
      quizContainer.querySelectorAll('input[type="radio"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          const qIndex = parseInt(e.target.name.replace("q", ""));
          userAnswers[qIndex] = parseInt(e.target.value);
        });
      });
    }

    // Check quiz answers
    function checkQuiz() {
      const totalQuestions = currentFolktale.questions.length;
      let correctCount = 0;

      currentFolktale.questions.forEach((q, index) => {
        if (userAnswers[index] === q.correctAnswer) {
          correctCount++;
        }
      });

      const percentage = Math.round((correctCount / totalQuestions) * 100);
      const resultDiv = document.getElementById("quizResult");

      if (percentage >= 80) {
        resultDiv.className =
          "mt-6 p-4 rounded-lg text-center bg-green-50 border border-green-200";
        resultDiv.innerHTML = `
          <div class="text-4xl mb-2">ğŸ‰</div>
          <div class="text-lg font-bold text-green-800 mb-1">í›Œë¥­í•´ìš”!</div>
          <div class="text-sm text-green-700">${correctCount}/${totalQuestions} ì •ë‹µ (${percentage}%)</div>
        `;
      } else if (percentage >= 60) {
        resultDiv.className =
          "mt-6 p-4 rounded-lg text-center bg-yellow-50 border border-yellow-200";
        resultDiv.innerHTML = `
          <div class="text-4xl mb-2">ğŸ‘</div>
          <div class="text-lg font-bold text-yellow-800 mb-1">ì˜í–ˆì–´ìš”!</div>
          <div class="text-sm text-yellow-700">${correctCount}/${totalQuestions} ì •ë‹µ (${percentage}%)</div>
        `;
      } else {
        resultDiv.className =
          "mt-6 p-4 rounded-lg text-center bg-red-50 border border-red-200";
        resultDiv.innerHTML = `
          <div class="text-4xl mb-2">ğŸ“–</div>
          <div class="text-lg font-bold text-red-800 mb-1">ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”</div>
          <div class="text-sm text-red-700">${correctCount}/${totalQuestions} ì •ë‹µ (${percentage}%)</div>
        `;
      }

      resultDiv.classList.remove("hidden");
    }

    // Setup event listeners
    function setupEventListeners() {
      // Level buttons
      levelBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          currentLevel = btn.dataset.level;

          // Update button styles
          levelBtns.forEach((b) => {
            b.className =
              "level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200";
          });
          btn.className =
            "level-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-purple-500 text-white";

          // Reload folktales
          await loadFolktales(currentLevel === "all" ? null : currentLevel);
          renderFolktaleList();
        });
      });

      // Back button
      backBtn.addEventListener("click", () => {
        readingSection.classList.add("hidden");
        folktaleList.parentElement.classList.remove("hidden");
      });

      // Submit quiz button
      submitQuiz.addEventListener("click", () => {
        if (Object.keys(userAnswers).length < currentFolktale.questions.length) {
          alert("ëª¨ë“  ë¬¸ì œì— ë‹µí•´ì£¼ì„¸ìš”!");
          return;
        }
        checkQuiz();
      });
    }

    // Start
    init();
  })();
</script>
{% endblock %}
